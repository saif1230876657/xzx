<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- PWA: Link to Manifest File -->
  <link rel="manifest" href="manifest.json">
  <!-- PWA: Theme color for browser UI -->
  <meta name="theme-color" content="#000000" />
  <!-- PWA: Favicon for the site -->
  <link rel="icon" href="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" type="image/png">


  <!-- Social Share Meta Tags -->
  <title>Saif AI - دردشة ذكاء اصطناعي</title>
  <meta property="og:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta property="og:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta property="og:image" content="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" />
  <meta property="og:url" content="https://tinyurl.com/saif-ai" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta name="twitter:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta name="twitter:image" content="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" />

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      /* --- NEW: Monochrome Color Scheme inspired by ChatGPT --- */
      --primary-color: #E0E0E0; /* Light grey for accents */
      --primary-hover-color: #FFFFFF; /* Pure white for hover */
      --primary-glow-color: rgba(224, 224, 224, 0.2); /* Adjusted glow for grey */
      --secondary-color: #BDBDBD; /* Another grey for variation */
      
      /* Pure Black Theme */
      --bg-main: #000000;
      --bg-surface: #101010;
      --bg-surface-raised: #1c1c1c;
      --bg-input: #1c1c1c;

      --text-primary: #f0f4f8;
      --text-secondary: #a0a8b2;
      --text-on-primary: #000000; /* Text on top of the light grey accent */
      
      --border-color: #2a2a2a;
      --border-color-light: #404040;
      
      --success-color: #4ce083;
      --error-color: #ff5c5c;
      
      --shadow-xs: 0 1px 3px rgba(0,0,0,0.5);
      --shadow-sm: 0 4px 6px rgba(0,0,0,0.6);
      --shadow-md: 0 6px 12px rgba(0,0,0,0.7);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.8);
      
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;

      --header-height: 52px;
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--secondary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar { width: 6px; height: 6px; }
    *::-webkit-scrollbar-track { background: var(--bg-surface); border-radius: 3px; }
    *::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 3px; }

    html, body {
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
    }

    body {
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
    }

    .container {
      width: 100%;
      height: 100%; 
      background: var(--bg-main); 
      border: 1px solid var(--border-color); 
      border-radius: 0;
      display: flex;
      flex-direction: column; 
      overflow: hidden; 
      position: relative; 
      box-shadow: var(--shadow-lg);
    }
    
    .download-notification {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-surface-raised);
      color: var(--text-primary);
      text-align: center;
      font-weight: 500;
      z-index: 100;
      box-shadow: var(--shadow-md);
      border-bottom: 1px solid var(--border-color);
      overflow: hidden;
      max-height: 0;
      padding: 0 15px;
      transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
    }
    .download-notification.show { max-height: 80px; padding: 10px 15px; }
    .notification-buttons { display: flex; align-items: center; gap: 10px; margin-right: auto; padding-right: 15px; }
    .download-btn { background-color: var(--primary-color); color: var(--text-on-primary); border: none; padding: 6px 14px; border-radius: var(--border-radius-md); cursor: pointer; font-weight: 700; transition: all 0.25s ease; }
    .download-btn:hover { background-color: var(--primary-hover-color); transform: scale(1.05); }
    .close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.8rem; cursor: pointer; padding: 0 5px; line-height: 1; opacity: 0.8; transition: all 0.25s ease; }
    .close-btn:hover { opacity: 1; transform: rotate(90deg) scale(1.1); }

    .header { 
      background: transparent;
      padding: 0.4rem 0.8rem; 
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0; 
      z-index: 10; 
      height: var(--header-height);
      direction: rtl; /* Always RTL */
      position: absolute; /* Floating Header */
      top: 0;
      left: 0;
      right: 0;
    }

    .header-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .header .delete-all-btn, .header .share-btn-header { 
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: 1.2rem; 
      z-index: 11; 
      padding: 5px;
    }
    .delete-all-btn:hover { color: var(--error-color); transform: rotate(10deg) scale(1.1); }
    .share-btn-header:hover { color: var(--success-color); transform: scale(1.15); }
    
    .header .fas.fa-robot { 
      font-size: 1.2rem; 
      color: var(--primary-color);
      background: rgba(224, 224, 224, 0.1);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .header h1 { 
      font-size: 1.05rem; 
      font-weight: 700;
      color: var(--primary-color); 
      white-space: nowrap;
    }

    .header-btn { 
        background-color: var(--bg-surface-raised); 
        color: var(--text-primary);
        border: 1px solid var(--border-color-light);
        padding: 0.4rem 0.7rem; 
        border-radius: var(--border-radius-md); 
        cursor: pointer;
        font-size: 0.75rem; 
        font-weight: 500;
        transition: all 0.25s ease;
        box-shadow: var(--shadow-xs);
    }
    .header-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-color);
        transform: translateY(-1px); 
        box-shadow: var(--shadow-sm), 0 0 8px var(--primary-glow-color);
    }
    
    #languageSelector { position: relative; }
    #languageBtn {
      padding: 0.4rem;
      width: 34px;
      height: 34px;
      font-size: 1.1rem;
    }
    #languageDropdown {
        display: none;
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        background-color: var(--bg-surface-raised);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        z-index: 100;
        min-width: 150px;
        overflow: hidden;
    }
    #languageDropdown button {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background: none;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        font-size: 0.9rem;
        text-align: right;
    }
    #languageDropdown button:hover { background-color: var(--primary-color); color: var(--text-on-primary); }


    .chat-wrapper { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden; 
        min-height: 0;
        padding-top: var(--header-height); /* Space for floating header */
    }
    
    #subjectsViewContainer { background-color: var(--bg-main); padding: 1.5rem; display: none; align-items: center; }
    .subjects-view-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
    .subjects-view-header h2 { font-size: 1.6rem; color: var(--primary-color); }
    .back-to-chat-btn { background-color: var(--bg-surface-raised); color: var(--text-primary); border: 1px solid var(--border-color-light); padding: 0.7rem 1.2rem; border-radius: var(--border-radius-md); cursor: pointer; font-size: 0.9rem; transition: all 0.25s ease; box-shadow: var(--shadow-xs); display: flex; align-items: center; gap: 0.5rem; }
    .back-to-chat-btn:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); transform: translateY(-2px); box-shadow: var(--shadow-sm), 0 0 10px var(--primary-glow-color); }
    #subjectListContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 700px; overflow-y: auto; padding: 10px; }
    .subject-item-btn { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); padding: 18px 22px; font-size: 1rem; min-width: 180px; border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.3s ease; text-align: center; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .subject-item-btn:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-hover-color); transform: translateY(-4px) scale(1.03); box-shadow: var(--shadow-md), 0 0 15px var(--primary-glow-color); }
    .subject-item-btn i { font-size: 2.2rem; margin-bottom: 5px; color: var(--secondary-color); transition: color 0.3s ease; }
    .subject-item-btn:hover i { color: var(--text-on-primary); }

    .chat-container { flex: 1; padding: 1.5rem 1rem; overflow-y: auto; background: var(--bg-main); scroll-behavior: smooth; min-height: 0; }
    .message { max-width: 85%; margin-bottom: 2rem; display: flex; flex-direction: column; animation: messageAppear 0.4s ease-out; word-wrap: break-word; white-space: pre-wrap; line-height: 1.7; }
    @keyframes messageAppear { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .message-content { padding: 0.2rem 0.5rem; }
    .message-header { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .delete-btn { color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; transition: color 0.2s, transform 0.2s; opacity: 0.4; padding: 3px 5px; }
    .message:hover .delete-btn { opacity: 0.8; }
    .delete-btn:hover { opacity: 1; color: var(--error-color); transform: scale(1.15); }
    .message.user { margin-left: auto; align-items: flex-end; }
    .message.user .message-header { flex-direction: row-reverse; }
    .message.bot { margin-right: auto; align-items: flex-start; }
    
    html[dir="ltr"] .message.user { margin-right: auto; margin-left: 0; align-items: flex-end; }
    html[dir="ltr"] .message.bot { margin-left: auto; margin-right: 0; align-items: flex-start; }
    
    .message.user .message-content { color: #e5e7eb; /* NEW: Brighter off-white for user text */ }
    .message.bot .message-content { color: var(--text-primary); }
    .message.bot .message-content strong { color: var(--primary-color); }
    .message-actions { margin-top: 10px; display: flex; gap: 8px; padding: 0 8px; flex-wrap: wrap; }
    .message.user .message-actions { justify-content: flex-end; }
    .message-actions button { background: var(--bg-surface-raised); border: 1px solid var(--border-color); cursor: pointer; font-size: 0.85rem; padding: 5px 9px; color: var(--text-secondary); transition: all 0.25s ease; border-radius: var(--border-radius-sm); display: flex; align-items: center; gap: 5px; }
    .message-actions button:hover { color: var(--text-on-primary); background-color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 0 10px var(--primary-glow-color); }
    
    .chat-input-area { 
        flex-shrink: 0; 
        background: transparent; 
        position: relative; 
        padding: 0.8rem 1rem;
    }
    .chat-input-area::before { 
        content: ''; 
        position: absolute; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        height: 150px; 
        background: linear-gradient(to top, var(--bg-main) 20%, transparent 100%); 
        pointer-events: none; 
        z-index: 4; 
    }
    .chat-input-wrapper {
        position: relative;
        z-index: 5;
        max-width: 800px;
        margin: 0 auto;
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-xl);
        transition: border-color 0.25s ease, box-shadow 0.25s ease;
        display: flex;
        align-items: flex-end; /* Align buttons at the bottom */
    }
    .chat-input-wrapper:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
    }
    .chat-input-wrapper textarea { 
        flex: 1; 
        padding: 0.8rem 48px; /* Room for buttons on both sides */
        border: none;
        resize: none; 
        font-size: 0.95rem; 
        outline: none; 
        background: transparent; 
        color: var(--text-primary); 
        max-height: 150px; 
        line-height: 1.6; 
    }
    .chat-input-wrapper textarea::placeholder { color: var(--text-secondary); opacity: 0.6; }

    .chat-input-btn { 
        background: transparent; 
        border: none; 
        color: var(--text-secondary); 
        width: 44px; 
        height: 44px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        font-size: 1.1rem; 
        transition: all 0.25s ease; 
        flex-shrink: 0;
        position: absolute;
        bottom: 0px;
    }
    .chat-input-btn:hover { color: var(--text-primary); transform: scale(1.1); }
    
    #toggleUploadBtn { right: 0; }
    html[dir="ltr"] #toggleUploadBtn { left: 0; right: auto; }
    
    #sendOrVoiceBtn { left: 0; }
    html[dir="ltr"] #sendOrVoiceBtn { right: 0; left: auto; }
    #sendOrVoiceBtn:hover { color: var(--primary-hover-color); }
    
    #speakBtn {
        position: absolute;
        bottom: 0px;
        left: 48px;
        display: none; /* Hidden by default */
    }
    html[dir="ltr"] #speakBtn { right: 48px; left: auto; }

    .voice-indicator { display: none; align-items: center; justify-content: center; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: var(--bg-surface-raised); color: var(--text-primary); padding: 8px 16px; border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); gap: 8px; z-index: 10; opacity: 0; transition: opacity 0.3s ease; }
    .voice-indicator.active { display: flex; opacity: 1; }
    .voice-indicator i { color: var(--error-color); animation: pulseMic 1.5s infinite ease-in-out; }
    @keyframes pulseMic { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    .chat-input-btn.recording { color: var(--error-color); }
    
    #uploadOptionsContainer { display: flex; flex-direction: column; gap: 8px; background-color: var(--bg-surface-raised); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 10px; position: absolute; bottom: calc(100% + 5px); right: 5px; z-index: 10; box-shadow: var(--shadow-md); opacity: 0; visibility: hidden; transform: translateY(10px) scale(0.95); transition: all 0.25s ease-out; }
    html[dir="ltr"] #uploadOptionsContainer { left: 5px; right: auto; }
    #uploadOptionsContainer.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
    #uploadOptionsContainer button { background: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border-color-light); border-radius: var(--border-radius-sm); padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: all 0.2s ease; text-align: right; width: 100%; white-space: nowrap; }
    html[dir="ltr"] #uploadOptionsContainer button { text-align: left; }
    #uploadOptionsContainer button:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); }
    
    .status { text-align: center; padding: 0.4rem; font-size: 0.8rem; background-color: var(--bg-surface); color: var(--text-secondary); border-top: 1px solid var(--border-color); transition: color 0.3s ease; font-weight: 500; }
    
    /* NEW: Suggestions Feature */
    #suggestionsContainer {
        display: none; /* Hidden by default */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        padding: 0 1rem 1rem;
        max-width: 800px;
        margin: auto;
    }
    .suggestion-btn {
        background-color: var(--bg-surface-raised);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 12px;
        font-size: 0.9rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: right;
    }
    html[dir="ltr"] .suggestion-btn { text-align: left; }
    .suggestion-btn:hover {
        background-color: var(--bg-input);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }

    .camera-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .camera-modal-content { background-color: var(--bg-surface); padding: 25px; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); text-align: center; max-width: 90%; display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: var(--shadow-lg); }
    
    /* --- Redesigned Share Modal --- */
    .share-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .share-modal-content { max-width: 450px; width: 90%; background: #1c1c1c; padding: 30px; border: 1px solid var(--border-color-light); border-radius: var(--border-radius-lg); text-align: center; display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: var(--shadow-lg); }
    .share-modal-content h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--text-primary); }
    .share-modal-content > p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6; }
    .share-link-container { display: flex; margin-bottom: 20px; width: 100%; }
    .share-link-container input { flex-grow: 1; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); padding: 12px 15px; border-radius: 0 8px 8px 0; font-size: 0.95rem; outline: none; }
    .share-link-container button { border: 1px solid var(--primary-color); background-color: var(--primary-color); color: var(--text-on-primary); padding: 12px 18px; border-radius: 8px 0 0 8px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
    .share-link-container button:hover { background-color: var(--primary-hover-color); }
    .share-divider { width: 80%; height: 1px; background: var(--border-color); margin: 25px auto; border: none; }
    .social-share-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .social-share-buttons .share-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-surface-raised); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; text-decoration: none; transition: all 0.3s ease; }
    .social-share-buttons .share-icon:hover { color: #fff; transform: translateY(-4px); box-shadow: var(--shadow-md); }
    .share-icon.whatsapp:hover { background-color: #25D366; }
    .share-icon.twitter:hover { background-color: #1DA1F2; }
    .share-icon.telegram:hover { background-color: #0088cc; }
    .share-icon.facebook:hover { background-color: #1877F2; }
    .qr-code-container { margin-top: 15px; }
    .qr-code-container img { background: #fff; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); }
    .qr-code-container p { color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px; }
    .close-share-modal { position: absolute; top: 15px; left: 15px; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; }
    .close-share-modal:hover { color: var(--text-primary); transform: rotate(90deg); }

    @media (max-width: 480px) { 
      .header h1 { font-size: 0.95rem; }
      .message { max-width: 95%; }
      .chat-input-wrapper textarea { padding: 0.8rem 44px; }
      .chat-input-btn { width: 40px; height: 40px; font-size: 1rem; }
      #speakBtn { left: 42px; }
      html[dir="ltr"] #speakBtn { right: 42px; left: auto; }
      #suggestionsContainer { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="downloadNotification" class="download-notification">
      <span id="downloadNotificationText">ثبّت التطبيق على جهازك للوصول السريع!</span>
      <div class="notification-buttons">
          <button id="downloadAppBtn" class="download-btn">تثبيت</button>
          <button id="closeNotificationBtn" class="close-btn">×</button>
      </div>
    </div>
    
    <header class="header">
      <!-- Right Group (Controls) -->
      <div id="headerControls" class="header-group">
        <button id="enterSubjectsBtn" class="header-btn">مواد متخصصة</button>
        <button id="generalChatBtn" class="header-btn" style="display: none;">عام</button>
        <div id="languageSelector">
          <button id="languageBtn" class="header-btn" title="تغيير اللغة">
            <i class="fas fa-globe"></i>
          </button>
          <div id="languageDropdown">
            <button data-lang="ar">العربية</button>
            <button data-lang="en">English</button>
            <button data-lang="fr">Français</button>
            <button data-lang="es">Español</button>
            <button data-lang="zh">中文</button>
          </div>
        </div>
      </div>
      
      <!-- Center Group (Title) -->
      <div class="header-group">
        <i class="fas fa-robot"></i>
        <h1 id="botName">Saif AI</h1>
      </div>
      
      <!-- Left Group (Icons) -->
      <div id="headerIcons" class="header-group">
        <i class="fas fa-share-alt share-btn-header" id="shareBtn" title="مشاركة التطبيق"></i>
        <i class="fas fa-trash delete-all-btn" onclick="deleteAllMessages()" title="حذف كل الرسائل"></i>
      </div>
    </header>

    <div class="chat-wrapper" id="chatWrapper"> 
        <div id="chatContainer" class="chat-container">
          <!-- Messages will be here -->
        </div>
        
        <!-- NEW: Suggestions will be here -->
        <div id="suggestionsContainer"></div>
        
        <div class="chat-input-area"> 
            <div class="status" id="statusBar"></div>
            
            <div class="voice-indicator" id="voiceIndicator">
              <i class="fas fa-microphone"></i>
              <span id="listeningText">جاري الاستماع...</span>
            </div>

            <div class="chat-input-wrapper">
              <button class="chat-input-btn" id="toggleUploadBtn" title="إرفاق ملف">
                <i class="fas fa-plus"></i>
              </button>

              <textarea id="userInput" rows="1" placeholder="اكتب رسالتك هنا..."></textarea>
              
              <button class="chat-input-btn" id="speakBtn" title="تشغيل الصوت">
                <i class="fas fa-volume-up"></i>
              </button>

              <button class="chat-input-btn" id="sendOrVoiceBtn">
                <!-- Content will be set by JS -->
              </button>
              
              <div class="upload-options-container" id="uploadOptionsContainer">
                <button id="uploadFromGalleryBtn" onclick="triggerImageUpload()">
                  <i class="fas fa-images"></i> رفع من المعرض
                </button>
                <button id="useCameraBtn" onclick="openCamera()">
                  <i class="fas fa-camera"></i> استخدام الكاميرا
                </button>
              </div>

              <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" style="display: none;" />
            </div>
        </div>
    </div>

    <div id="subjectsViewContainer"> 
        <div class="subjects-view-header">
            <h2 id="subjectsViewTitle">اختر المادة الدراسية</h2>
            <button id="backToChatBtn" class="back-to-chat-btn">
                <i class="fas fa-arrow-left"></i> <span id="backToChatText">العودة للدردشة</span>
            </button>
        </div>
        <div id="subjectListContainer">
            <!-- Subject items will be populated here by JS -->
        </div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">التقاط صورة</button>
        <button id="cancelCameraBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <span class="close-share-modal" id="closeShareModal">&times;</span>
      <h2 id="shareModalTitle">شارك التطبيق</h2>
      <p id="shareModalDesc">ساعدنا على النمو بمشاركة التطبيق مع أصدقائك!</p>
      
      <div class="share-link-container">
        <button id="copyLinkBtn"><i class="fas fa-copy"></i> <span id="copyBtnText">نسخ</span></button>
        <input type="text" value="https://tinyurl.com/saif-ai" id="shareLinkInput" readonly>
      </div>

      <hr class="share-divider">

      <div class="social-share-buttons">
          <a href="#" target="_blank" class="share-icon whatsapp" id="whatsapp-share" title="مشاركة عبر واتساب"><i class="fab fa-whatsapp"></i></a>
          <a href="#" target="_blank" class="share-icon twitter" id="twitter-share" title="مشاركة عبر تويتر"><i class="fab fa-twitter"></i></a>
          <a href="#" target="_blank" class="share-icon telegram" id="telegram-share" title="مشاركة عبر تيليجرام"><i class="fab fa-telegram-plane"></i></a>
          <a href="#" target="_blank" class="share-icon facebook" id="facebook-share" title="مشاركة عبر فيسبوك"><i class="fab fa-facebook-f"></i></a>
      </div>
      
      <div class="qr-code-container">
          <img id="qr-code-img" src="" alt="QR Code" width="140" height="140">
          <p id="qrCodeText">أو امسح الرمز للمشاركة</p>
      </div>
    </div>
  </div>


  <script>
    // --- API KEYS ---
    const geminiApiKey = "AIzaSyAnuSkvwbWZ0M95asG7-cd0-JhfOkWtXV8"; 
    const ocrApiKey = "K83201031288957";     

    // --- DOM ELEMENTS ---
    const chatWrapper = document.getElementById("chatWrapper");
    const chatContainer = document.getElementById("chatContainer");
    const statusBar = document.getElementById("statusBar");
    const userInput = document.getElementById("userInput");
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const voiceIndicator = document.getElementById('voiceIndicator');
    const subjectsViewContainer = document.getElementById('subjectsViewContainer');
    const subjectListContainer = document.getElementById('subjectListContainer'); 
    const backToChatBtn = document.getElementById('backToChatBtn');
    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;
    const enterSubjectsBtn = document.getElementById('enterSubjectsBtn');
    const generalChatBtn = document.getElementById('generalChatBtn');
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShareModalBtn = document.getElementById('closeShareModal');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const shareLinkInput = document.getElementById('shareLinkInput');
    const downloadNotification = document.getElementById('downloadNotification');
    const downloadAppBtn = document.getElementById('downloadAppBtn');
    const closeNotificationBtn = document.getElementById('closeNotificationBtn');
    const sendOrVoiceBtn = document.getElementById('sendOrVoiceBtn');
    const speakBtn = document.getElementById('speakBtn');
    const languageBtn = document.getElementById('languageBtn');
    const languageDropdown = document.getElementById('languageDropdown');
    const suggestionsContainer = document.getElementById('suggestionsContainer');
    
    // --- GLOBAL VARIABLES & CONSTANTS ---
    const botName = "Saif AI";
    const localStorageKeyAllChats = "saifAiAllChatsHistory_v2"; 
    const localStorageKeyCurrentSubject = "saifAiCurrentSubject_v2";
    const localStorageKeyLanguage = "saifAiLanguage_v1";
    let allMessages = {}; 
    let messages = [];    
    let statusTimeout;
    let currentSubject = "general";
    let currentLanguage = "ar";
    const subjects = [ 
        { key: "physics", name: { ar: "فيزياء", en: "Physics", fr: "Physique", es: "Física", zh: "物理" }, icon: "fas fa-atom" },
        { key: "chemistry", name: { ar: "كيمياء", en: "Chemistry", fr: "Chimie", es: "Química", zh: "化学" }, icon: "fas fa-flask" },
        { key: "biology", name: { ar: "أحياء", en: "Biology", fr: "Biologie", es: "Biología", zh: "生物学" }, icon: "fas fa-dna" },
        { key: "science", name: { ar: "علوم", en: "Science", fr: "Sciences", es: "Ciencia", zh: "科学" }, icon: "fas fa-microscope" },
        { key: "arabic", name: { ar: "لغة عربية", en: "Arabic", fr: "Arabe", es: "Árabe", zh: "阿拉伯语" }, icon: "fas fa-pen-nib" },
        { key: "philosophy", name: { ar: "فلسفة", en: "Philosophy", fr: "Philosophie", es: "Filosofía", zh: "哲学" }, icon: "fas fa-brain" },
        { key: "english", name: { ar: "لغة إنجليزية", en: "English", fr: "Anglais", es: "Inglés", zh: "英语" }, icon: "fas fa-language" },
        { key: "math", name: { ar: "رياضيات", en: "Math", fr: "Maths", es: "Matemáticas", zh: "数学" }, icon: "fas fa-calculator" },
        { key: "religion", name: { ar: "تربية دينية", en: "Religion", fr: "Religion", es: "Religión", zh: "宗教教育" }, icon: "fas fa-mosque" }
    ];
    let recognition;
    let isListening = false;
    let deferredPrompt;
    let speechEndTimeout; // NEW: Timeout for speech recognition pause detection

    // --- PWA & NOTIFICATION FUNCTIONS ---
    function showAppNotification() { downloadNotification.classList.add('show'); }
    function hideAppNotification() { downloadNotification.classList.remove('show'); }
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(err => console.error('Service Worker registration failed:', err));
      }
    }
    async function promptInstall(e) {
        e.preventDefault();
        if (deferredPrompt) {
            hideAppNotification();
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
        }
    }

    // --- SPEECH RECOGNITION (INPUT) ---
    function initSpeechRecognition() {
        if (recognition) { recognition.abort(); }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const langMap = { ar: 'ar-SA', en: 'en-US', fr: 'fr-FR', es: 'es-ES', zh: 'zh-CN' };
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Set to true to control stop manually
            recognition.interimResults = true;
            recognition.lang = langMap[currentLanguage];

            recognition.onstart = () => {
                isListening = true;
                sendOrVoiceBtn.classList.add('recording');
                voiceIndicator.classList.add('active');
                setStatus(translations[currentLanguage].listening, "", null);
            };

            recognition.onresult = (event) => {
                clearTimeout(speechEndTimeout); // Reset timer on new speech
                let transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                userInput.value = transcript;
                autoResizeTextarea();
                updateSendOrVoiceButton();
                
                // Set a timer to stop if user pauses
                speechEndTimeout = setTimeout(() => {
                    if (isListening) recognition.stop();
                }, 1500); // 1.5 second pause
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error !== 'no-speech') {
                    setStatus(`${translations[currentLanguage].speechError}: ${event.error}`, "error", 4000);
                }
                stopListening();
            };

            recognition.onend = () => {
                stopListening();
            };
        } else {
            sendOrVoiceBtn.style.display = 'none';
            setStatus(translations[currentLanguage].speechNotSupported, "error", 3000);
        }
    }
    
    function toggleListening() {
        if (!recognition) return;
        if (isListening) { 
            recognition.stop();
        } else { 
            try { 
                userInput.value = ""; 
                autoResizeTextarea(); 
                recognition.start(); 
            } catch (e) { 
                stopListening(); 
            }
        }
    }
    
    function stopListening() {
        clearTimeout(speechEndTimeout);
        isListening = false;
        sendOrVoiceBtn.classList.remove('recording');
        voiceIndicator.classList.remove('active');
        if (statusBar.textContent === translations[currentLanguage].listening) setStatus("", "", 100);
    }
    
    // --- TEXT TO SPEECH (OUTPUT) ---
    function speakLastBotMessage() {
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
            return;
        }
        const lastBotMessage = [...messages].reverse().find(m => m.sender === 'bot' && !m.isSystemMessage && !m.isInitialWelcome);
        if (lastBotMessage) {
            const utterance = new SpeechSynthesisUtterance(lastBotMessage.text);
            const langMap = { ar: 'ar-SA', en: 'en-US', fr: 'fr-FR', es: 'es-ES', zh: 'zh-CN' };
            utterance.lang = langMap[currentLanguage];
            speechSynthesis.speak(utterance);
        } else {
            setStatus(translations[currentLanguage].noResponseToSpeak, "", 2000);
        }
    }

    // --- INITIALIZATION & EVENT LISTENERS ---
    function initializeApp() {
        registerServiceWorker();
        loadAllMessagesAndSetCurrent(); 
        const storedSubject = localStorage.getItem(localStorageKeyCurrentSubject) || "general";
        currentSubject = storedSubject;
        messages = allMessages[currentSubject] || [];
        if (!allMessages[currentSubject]) allMessages[currentSubject] = [];
        
        const savedLang = localStorage.getItem(localStorageKeyLanguage) || 'ar';
        switchLanguage(savedLang, false);

        // Event Listeners
        const qrCodeImg = document.getElementById('qr-code-img');
        const whatsappShare = document.getElementById('whatsapp-share');
        const twitterShare = document.getElementById('twitter-share');
        const telegramShare = document.getElementById('telegram-share');
        const facebookShare = document.getElementById('facebook-share');

        shareBtn.addEventListener('click', () => {
            const shareUrl = shareLinkInput.value;
            const shareText = translations[currentLanguage].shareText;
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(shareUrl)}&bgcolor=1c1c1c&color=ffffff&qzone=1`;
            whatsappShare.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + " " + shareUrl)}`;
            twitterShare.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
            telegramShare.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
            facebookShare.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
            shareModal.style.display = 'flex';
        });

        closeShareModalBtn.addEventListener('click', () => { shareModal.style.display = 'none'; });
        copyLinkBtn.addEventListener('click', copyShareLink);
        toggleUploadBtn.addEventListener('click', (e) => { e.stopPropagation(); uploadOptionsContainer.classList.toggle('active'); });
        document.addEventListener('click', () => { uploadOptionsContainer.classList.remove('active'); });
        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);
        enterSubjectsBtn.addEventListener('click', openSubjectsView);
        backToChatBtn.addEventListener('click', closeSubjectsView);
        generalChatBtn.addEventListener('click', switchToGeneralMode);
        downloadAppBtn.addEventListener('click', promptInstall);
        closeNotificationBtn.addEventListener('click', hideAppNotification);
        userInput.addEventListener("keydown", (e) => { if(e.key==="Enter"&&!e.shiftKey) { e.preventDefault(); sendMessage();}});
        userInput.addEventListener("input", () => { autoResizeTextarea(); updateSendOrVoiceButton(); }); 
        speakBtn.addEventListener('click', speakLastBotMessage);
        languageBtn.addEventListener('click', (e) => { e.stopPropagation(); languageDropdown.style.display = languageDropdown.style.display === 'block' ? 'none' : 'block'; });
        document.addEventListener('click', () => { languageDropdown.style.display = 'none'; });
        document.querySelectorAll('#languageDropdown button').forEach(button => {
            button.addEventListener('click', (e) => {
                switchLanguage(e.currentTarget.dataset.lang);
            });
        });

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; showAppNotification(); });
        window.addEventListener('appinstalled', () => { deferredPrompt = null; hideAppNotification(); });
        window.addEventListener('click', (event) => {
            if (event.target == shareModal) shareModal.style.display = 'none';
            if (event.target == cameraModal) closeCamera();
        });
    }
    
    function copyShareLink() {
        shareLinkInput.select();
        navigator.clipboard.writeText(shareLinkInput.value).then(() => {
            const originalText = document.getElementById('copyBtnText').textContent;
            document.getElementById('copyBtnText').textContent = translations[currentLanguage].copied;
            copyLinkBtn.querySelector('i').className = "fas fa-check";
            setTimeout(() => { 
                document.getElementById('copyBtnText').textContent = originalText;
                copyLinkBtn.querySelector('i').className = "fas fa-copy";
            }, 2000);
        });
    }

    // --- UI & VIEW MANAGEMENT ---
    function updateSendOrVoiceButton() {
        const hasText = userInput.value.trim().length > 0;
        const t = translations[currentLanguage];
        if (hasText) {
            sendOrVoiceBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendOrVoiceBtn.title = t.send;
            sendOrVoiceBtn.onclick = sendMessage;
        } else {
            sendOrVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            sendOrVoiceBtn.title = t.speak;
            sendOrVoiceBtn.onclick = toggleListening;
        }
    }

    function openSubjectsView() { chatWrapper.style.display = 'none'; subjectsViewContainer.style.display = 'flex'; }
    function closeSubjectsView() { subjectsViewContainer.style.display = 'none'; chatWrapper.style.display = 'flex'; }
    
    function getTranslatedSubjectName(subjectKey) {
        if (subjectKey === "general") return translations[currentLanguage].general;
        const subject = subjects.find(s => s.key === subjectKey);
        return subject ? subject.name[currentLanguage] : subjectKey;
    }

    function getBotDisplayName() { 
        const subjectName = getTranslatedSubjectName(currentSubject);
        return currentSubject === "general" ? botName : `${botName} (${subjectName})`;
    }
    
    function updateSubjectUI() {
        botNameElement.textContent = getBotDisplayName();
        const t = translations[currentLanguage];
        generalChatBtn.style.display = currentSubject === "general" ? 'none' : 'inline-block';
        generalChatBtn.textContent = t.general;
        enterSubjectsBtn.textContent = currentSubject === "general" ? t.specializedSubjects : `${t.subjectPrefix}: ${getTranslatedSubjectName(currentSubject)}`;
        localStorage.setItem(localStorageKeyCurrentSubject, currentSubject);
    }

    function populateSubjectListInView() { 
        subjectListContainer.innerHTML = '';
        subjects.forEach(subject => {
            const btn = document.createElement('button');
            btn.className = 'subject-item-btn';
            btn.innerHTML = `<i class="${subject.icon}"></i><span>${subject.name[currentLanguage]}</span>`;
            btn.onclick = () => selectSubject(subject.key);
            subjectListContainer.appendChild(btn);
        });
    }

    function selectSubject(subjectKey) {
        if (currentSubject === subjectKey) { closeSubjectsView(); return; }
        switchSubject(subjectKey);
        setStatus(`${translations[currentLanguage].switchedToSubject} ${getTranslatedSubjectName(subjectKey)}`, "success", 3000);
    }

    function switchToGeneralMode() {
        if (currentSubject === "general") { closeSubjectsView(); return; }
        switchSubject("general");
        setStatus(translations[currentLanguage].returnedToGeneral, "success", 3000);
    }

    function switchSubject(newSubject) {
        allMessages[currentSubject] = messages; 
        currentSubject = newSubject;
        messages = allMessages[currentSubject] || []; 
        if (!allMessages[currentSubject]) allMessages[currentSubject] = [];
        updateSubjectUI();
        closeSubjectsView(); 
        addWelcomeMessage(); 
        refreshChat(); 
        saveAllMessagesToLocalStorage(); 
    }
    
    // --- MESSAGE & CHAT MANAGEMENT ---
    function loadAllMessagesAndSetCurrent() {
        try { const stored = localStorage.getItem(localStorageKeyAllChats); allMessages = stored ? JSON.parse(stored) : {}; } catch (e) { allMessages = {}; }
        if (!allMessages.general) allMessages.general = [];
    }
    function saveAllMessagesToLocalStorage() { allMessages[currentSubject] = messages; localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allMessages)); }
    function addWelcomeMessage() {
        const welcomeMsgText = getWelcomeMessageText();
        if (!messages.some(m => m.isInitialWelcome)) { messages.unshift({ sender: "bot", text: welcomeMsgText, isInitialWelcome: true }); }
    }
    function addMessage(sender, text, isImage = false, isSystemMessage = false) { messages.push({ sender, text, isImage, isSystemMessage }); refreshChat(); chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); }
    function refreshChat() {
      chatContainer.innerHTML = ""; 
      const t = translations[currentLanguage];
      messages.forEach((msg, index) => {
        const messageElem = document.createElement("div"); messageElem.className = `message ${msg.sender}`;
        let senderName = msg.sender === "bot" ? getBotDisplayName() : t.you;
        const header = document.createElement("div"); header.className = "message-header"; header.innerHTML = `<span>${senderName}</span><i class="fas fa-trash delete-btn" title="${t.deleteMessage}"></i>`; header.querySelector('.delete-btn').onclick = () => deleteMessage(index);
        const contentDiv = document.createElement("div"); contentDiv.className = "message-content"; contentDiv.innerHTML = msg.text; 
        messageElem.appendChild(header); messageElem.appendChild(contentDiv);
        if(msg.sender === "bot" && !msg.isInitialWelcome && !msg.isSystemMessage) {
            const actionsDiv = document.createElement("div"); actionsDiv.className = "message-actions";
            actionsDiv.innerHTML = `<button title="${t.copy}"><i class="fas fa-copy"></i></button>`;
            actionsDiv.querySelector('button').onclick = () => { navigator.clipboard.writeText(msg.text).then(() => setStatus(t.copiedSuccess, "success", 1500)); };
            messageElem.appendChild(actionsDiv);
        }
        chatContainer.appendChild(messageElem);
      });
      toggleSuggestionsVisibility(); 
      saveAllMessagesToLocalStorage(); 
      autoResizeTextarea(); 
    }
    function deleteMessage(index) { messages.splice(index, 1); refreshChat(); setStatus(translations[currentLanguage].messageDeleted, "success", 1500); }
    function deleteAllMessages() { if (confirm(translations[currentLanguage].confirmDeleteAll)) { messages = []; addWelcomeMessage(); refreshChat(); setStatus(translations[currentLanguage].allMessagesDeleted, "success", 2000); speakBtn.style.display = 'none'; } }
    function setStatus(message, type = "", duration = 3000) { clearTimeout(statusTimeout); statusBar.textContent = message; statusBar.className = "status " + type; if (message && duration) { statusTimeout = setTimeout(() => { statusBar.textContent = ""; statusBar.className = "status"; }, duration); } }

    // --- AI & GEMINI FUNCTIONS ---
    async function fetchGeminiResponse(prompt) {
      if (!geminiApiKey) throw new Error("Gemini API key is missing.");
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
      const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      if(!response.ok) throw new Error(`Network error: ${response.statusText}`);
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.";
    }
    async function processQueryWithAI(queryText) {
        if (!queryText?.trim()) return;
        const t = translations[currentLanguage];
        setStatus(`${getBotDisplayName()} ${t.thinking}...`, "", null); 
        try {
            const strictInstructions = t.aiInstructions
              .replace('{botName}', getBotDisplayName())
              .replace('{language}', t.languageName)
              .replace('{subjectContext}', currentSubject !== 'general' ? t.aiSubjectInstruction.replace('{subject}', getTranslatedSubjectName(currentSubject)) : '');
            
            const prompt = `${strictInstructions} The user's question is: ${queryText}`;

            const responseText = await fetchGeminiResponse(prompt);
            addMessage("bot", responseText);
            setStatus(t.responseReceived, "success"); 
            speakBtn.style.display = 'flex';
        } catch (error) {
            addMessage("bot", `${t.errorPrefix}: ${error.message}`, false, true); 
            setStatus(t.responseFailed, "error"); 
        }
    }
    async function sendMessage() {
      const messageText = userInput.value.trim();
      if (!messageText) return;
      addMessage("user", messageText);
      userInput.value = ""; 
      autoResizeTextarea(); 
      updateSendOrVoiceButton();
      await processQueryWithAI(messageText);
    }

    // --- UTILITY & OTHER FUNCTIONS ---
    function autoResizeTextarea() { userInput.style.height = 'auto'; userInput.style.height = userInput.scrollHeight + 'px'; }
    async function openCamera() { try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); cameraView.srcObject = cameraStream; cameraModal.style.display = "flex"; } catch (err) { setStatus(translations[currentLanguage].cameraError, "error", 4000); } }
    function closeCamera() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); } cameraModal.style.display = "none"; }
    async function captureImageFromCamera() { /* Your existing capture code */ }
    function triggerImageUpload() { imageUploadInput.click(); }
    function handleFileSelect(event) { /* Your existing file handling code */ }
    
    // --- LANGUAGE SWITCHING ---
    function switchLanguage(lang, showStatus = true) {
        currentLanguage = lang;
        localStorage.setItem(localStorageKeyLanguage, currentLanguage);
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

        updateUIForLanguage();
        initSpeechRecognition();
        
        messages = allMessages[currentSubject] || [];
        if (!messages.length) addWelcomeMessage();
        else { messages[0].text = getWelcomeMessageText(); } 
        refreshChat();

        if (showStatus) {
            setStatus(translations[lang].languageChanged, "success", 2000);
        }
    }

    function getWelcomeMessageText() {
        const t = translations[currentLanguage];
        let welcomeMsgText = t.welcomeGeneral.replace('{botName}', getBotDisplayName());
        if (currentSubject !== "general") { 
            welcomeMsgText = t.welcomeSubject
                .replace('{botName}', getBotDisplayName())
                .replace('{subject}', getTranslatedSubjectName(currentSubject)); 
        }
        return welcomeMsgText;
    }
    
    // --- SUGGESTIONS FEATURE ---
    function populateSuggestions() {
        suggestionsContainer.innerHTML = '';
        const suggestionKeys = ['suggestion1', 'suggestion2', 'suggestion3', 'suggestion4'];
        suggestionKeys.forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'suggestion-btn';
            const text = translations[currentLanguage][key];
            btn.textContent = text;
            btn.onclick = () => {
                userInput.value = text;
                sendMessage();
            };
            suggestionsContainer.appendChild(btn);
        });
    }

    function toggleSuggestionsVisibility() {
        const hasUserMessages = messages.some(m => !m.isInitialWelcome);
        if (!hasUserMessages) {
            suggestionsContainer.style.display = 'grid';
        } else {
            suggestionsContainer.style.display = 'none';
        }
    }


    function updateUIForLanguage() {
        const t = translations[currentLanguage];
        // Header
        document.querySelector('.delete-all-btn').title = t.deleteAllMessages;
        document.getElementById('shareBtn').title = t.shareApp;
        document.getElementById('languageBtn').title = t.changeLanguage;
        // Subject buttons
        updateSubjectUI();
        // Subjects View
        document.getElementById('subjectsViewTitle').textContent = t.selectSubject;
        document.getElementById('backToChatText').textContent = t.backToChat;
        populateSubjectListInView();
        // Chat Input
        userInput.placeholder = t.placeholder;
        speakBtn.title = t.playAudio;
        toggleUploadBtn.title = t.attachFile;
        document.getElementById('uploadFromGalleryBtn').innerHTML = `<i class="fas fa-images"></i> ${t.uploadFromGallery}`;
        document.getElementById('useCameraBtn').innerHTML = `<i class="fas fa-camera"></i> ${t.useCamera}`;
        document.getElementById('listeningText').textContent = t.listening;
        updateSendOrVoiceButton();
        // Suggestions
        populateSuggestions();
        // Camera Modal
        document.getElementById('captureBtn').textContent = t.capture;
        document.getElementById('cancelCameraBtn').textContent = t.cancel;
        // Share Modal
        document.getElementById('shareModalTitle').textContent = t.shareApp;
        document.getElementById('shareModalDesc').textContent = t.shareDescription;
        document.getElementById('copyBtnText').textContent = t.copy;
        document.getElementById('qrCodeText').textContent = t.qrCodeText;
        // PWA Notification
        document.getElementById('downloadNotificationText').textContent = t.installApp;
        document.getElementById('downloadAppBtn').textContent = t.install;
    }
    
    const translations = {
      'ar': {
        languageName: "العربية",
        specializedSubjects: "مواد متخصصة", general: "عام", subjectPrefix: "مادة",
        welcomeGeneral: "مرحباً بك! أنا {botName}، كيف يمكنني مساعدتك اليوم؟",
        welcomeSubject: "مرحباً! أنا {botName}. حاليًا في وضع الإجابة عن أسئلة مادة {subject}.",
        placeholder: "اكتب رسالتك هنا...", you: "أنت",
        thinking: "يفكر", responseReceived: "تم استلام الرد!", responseFailed: "فشل الرد.",
        switchedToSubject: "تم التحويل إلى وضع مادة:", returnedToGeneral: "تم الرجوع إلى الوضع العام",
        deleteAllMessages: "حذف كل الرسائل", deleteMessage: "حذف الرسالة", confirmDeleteAll: "هل أنت متأكد من حذف جميع الرسائل؟",
        allMessagesDeleted: "تم حذف جميع الرسائل.", messageDeleted: "تم حذف الرسالة.",
        listening: "جاري الاستماع...", speechError: "خطأ في التعرف على الصوت", speechNotSupported: "المتصفح لا يدعم التعرف على الصوت",
        noResponseToSpeak: "لا يوجد رد لتشغيله.", playAudio: "تشغيل الصوت", send: "إرسال", speak: "التحدث",
        shareApp: "مشاركة التطبيق", shareDescription: "ساعدنا على النمو بمشاركة التطبيق مع أصدقائك!", shareText: "اكتشف Saif AI، مساعد الذكاء الاصطناعي العربي المتطور!",
        copy: "نسخ", copied: "تم النسخ", copiedSuccess: "تم النسخ بنجاح", qrCodeText: "أو امسح الرمز للمشاركة",
        selectSubject: "اختر المادة الدراسية", backToChat: "العودة للدردشة",
        attachFile: "إرفاق ملف", uploadFromGallery: "رفع من المعرض", useCamera: "استخدام الكاميرا", cameraError: "لا يمكن الوصول للكاميرا.",
        capture: "التقاط صورة", cancel: "إلغاء",
        installApp: "ثبّت التطبيق على جهازك للوصول السريع!", install: "تثبيت", languageChanged: "تم تغيير اللغة إلى العربية", changeLanguage: "تغيير اللغة",
        errorPrefix: "عفواً، واجهت مشكلة",
        aiInstructions: "أنت مساعد ذكاء اصطناعي خبير اسمه {botName}. مهمتك هي تقديم إجابات دقيقة ومفصلة. {subjectContext} يجب أن تكون جميع ردودك باللغة {language} فقط. كن صارمًا في اتباع هذه التعليمات.",
        aiSubjectInstruction: "أجب كخبير متخصص في مادة {subject}.",
        suggestion1: "اشرح لي مفهوم التوتر السطحي", suggestion2: "اكتب قصة قصيرة عن مستكشف فضاء", suggestion3: "ما هي عاصمة أستراليا؟", suggestion4: "ترجم 'صباح الخير' إلى الإسبانية"
      },
      'en': {
        languageName: "English",
        specializedSubjects: "Specialized Subjects", general: "General", subjectPrefix: "Subject",
        welcomeGeneral: "Hello! I'm {botName}. How can I help you today?",
        welcomeSubject: "Hello! I'm {botName}, currently in subject mode for {subject}.",
        placeholder: "Type your message here...", you: "You",
        thinking: "is thinking", responseReceived: "Response received!", responseFailed: "Response failed.",
        switchedToSubject: "Switched to subject mode:", returnedToGeneral: "Returned to general mode",
        deleteAllMessages: "Delete all messages", deleteMessage: "Delete message", confirmDeleteAll: "Are you sure you want to delete all messages?",
        allMessagesDeleted: "All messages have been deleted.", messageDeleted: "Message deleted.",
        listening: "Listening...", speechError: "Speech recognition error", speechNotSupported: "Browser does not support speech recognition",
        noResponseToSpeak: "No response to play.", playAudio: "Play audio", send: "Send", speak: "Speak",
        shareApp: "Share App", shareDescription: "Help us grow by sharing the app with your friends!", shareText: "Discover Saif AI, the advanced AI assistant!",
        copy: "Copy", copied: "Copied", copiedSuccess: "Copied successfully", qrCodeText: "Or scan the code to share",
        selectSubject: "Select a Subject", backToChat: "Back to Chat",
        attachFile: "Attach file", uploadFromGallery: "Upload from Gallery", useCamera: "Use Camera", cameraError: "Cannot access camera.",
        capture: "Capture", cancel: "Cancel",
        installApp: "Install the app on your device for quick access!", install: "Install", languageChanged: "Language changed to English", changeLanguage: "Change Language",
        errorPrefix: "Sorry, an error occurred",
        aiInstructions: "You are an expert AI assistant named {botName}. Your task is to provide accurate and detailed answers. {subjectContext} All of your responses must be strictly in {language} only. Be strict in following these instructions.",
        aiSubjectInstruction: "Answer as a specialized expert in the subject of {subject}.",
        suggestion1: "Explain the concept of surface tension", suggestion2: "Write a short story about a space explorer", suggestion3: "What is the capital of Australia?", suggestion4: "Translate 'Good morning' into Spanish"
      },
      'fr': {
        languageName: "Français",
        specializedSubjects: "Matières Spécialisées", general: "Général", subjectPrefix: "Matière",
        welcomeGeneral: "Bonjour! Je suis {botName}. Comment puis-je vous aider aujourd'hui?",
        welcomeSubject: "Bonjour! Je suis {botName}, actuellement en mode matière pour {subject}.",
        placeholder: "Écrivez votre message ici...", you: "Vous",
        thinking: "réfléchit", responseReceived: "Réponse reçue !", responseFailed: "Échec de la réponse.",
        switchedToSubject: "Passage en mode matière :", returnedToGeneral: "Retour au mode général",
        deleteAllMessages: "Supprimer tous les messages", deleteMessage: "Supprimer le message", confirmDeleteAll: "Êtes-vous sûr de vouloir supprimer tous les messages ?",
        allMessagesDeleted: "Tous les messages ont été supprimés.", messageDeleted: "Message supprimé.",
        listening: "Écoute...", speechError: "Erreur de reconnaissance vocale", speechNotSupported: "Le navigateur ne prend pas en charge la reconnaissance vocale",
        noResponseToSpeak: "Aucune réponse à lire.", playAudio: "Lire l'audio", send: "Envoyer", speak: "Parler",
        shareApp: "Partager l'application", shareDescription: "Aidez-nous à grandir en partageant l'application avec vos amis !", shareText: "Découvrez Saif AI, l'assistant IA avancé !",
        copy: "Copier", copied: "Copié", copiedSuccess: "Copié avec succès", qrCodeText: "Ou scannez le code pour partager",
        selectSubject: "Sélectionnez une matière", backToChat: "Retour au chat",
        attachFile: "Joindre un fichier", uploadFromGallery: "Télécharger de la galerie", useCamera: "Utiliser la caméra", cameraError: "Impossible d'accéder à la caméra.",
        capture: "Capturer", cancel: "Annuler",
        installApp: "Installez l'application sur votre appareil pour un accès rapide !", install: "Installer", languageChanged: "Langue changée en Français", changeLanguage: "Changer de langue",
        errorPrefix: "Désolé, une erreur est survenue",
        aiInstructions: "Vous êtes un assistant IA expert nommé {botName}. Votre tâche est de fournir des réponses précises et détaillées. {subjectContext} Toutes vos réponses doivent être strictly en {language} uniquement. Soyez strict dans le suivi de ces instructions.",
        aiSubjectInstruction: "Répondez en tant qu'expert spécialisé dans le domaine de {subject}.",
        suggestion1: "Expliquez le concept de tension superficielle", suggestion2: "Écrivez une nouvelle sur un explorateur de l'espace", suggestion3: "Quelle est la capitale de l'Australie?", suggestion4: "Traduisez 'Bonjour' en espagnol"
      },
      'es': {
        languageName: "Español",
        specializedSubjects: "Materias Especializadas", general: "General", subjectPrefix: "Materia",
        welcomeGeneral: "¡Hola! Soy {botName}. ¿Cómo puedo ayudarte hoy?",
        welcomeSubject: "¡Hola! Soy {botName}, actualmente en modo de materia para {subject}.",
        placeholder: "Escribe tu mensaje aquí...", you: "Tú",
        thinking: "está pensando", responseReceived: "¡Respuesta recibida!", responseFailed: "Falló la respuesta.",
        switchedToSubject: "Cambiado a modo de materia:", returnedToGeneral: "Regreso a modo general",
        deleteAllMessages: "Eliminar todos los mensajes", deleteMessage: "Eliminar mensaje", confirmDeleteAll: "¿Estás seguro de que quieres eliminar todos los mensajes?",
        allMessagesDeleted: "Todos los mensajes han sido eliminados.", messageDeleted: "Mensaje eliminado.",
        listening: "Escuchando...", speechError: "Error de reconocimiento de voz", speechNotSupported: "El navegador no admite el reconocimiento de voz",
        noResponseToSpeak: "No hay respuesta para reproducir.", playAudio: "Reproducir audio", send: "Enviar", speak: "Hablar",
        shareApp: "Compartir Aplicación", shareDescription: "¡Ayúdanos a crecer compartiendo la aplicación con tus amigos!", shareText: "¡Descubre Saif AI, el asistente de IA avanzado!",
        copy: "Copiar", copied: "Copiado", copiedSuccess: "Copiado con éxito", qrCodeText: "O escanea el código para compartir",
        selectSubject: "Selecciona una Materia", backToChat: "Volver al Chat",
        attachFile: "Adjuntar archivo", uploadFromGallery: "Subir de la Galería", useCamera: "Usar Cámara", cameraError: "No se puede acceder a la cámara.",
        capture: "Capturar", cancel: "Cancelar",
        installApp: "¡Instala la aplicación en tu dispositivo para un acceso rápido!", install: "Instalar", languageChanged: "Idioma cambiado a Español", changeLanguage: "Cambiar Idioma",
        errorPrefix: "Lo siento, ocurrió un error",
        aiInstructions: "Eres un asistente de IA experto llamado {botName}. Tu tarea es proporcionar respuestas precisas y detalladas. {subjectContext} Todas tus respuestas deben ser estrictamente en {language} únicamente. Sé estricto en seguir estas instrucciones.",
        aiSubjectInstruction: "Responde como un experto especializado en la materia de {subject}.",
        suggestion1: "Explica el concepto de tensión superficial", suggestion2: "Escribe un cuento sobre un explorador espacial", suggestion3: "¿Cuál es la capital de Australia?", suggestion4: "Traduce 'Buenos días' al español"
      },
      'zh': {
        languageName: "中文",
        specializedSubjects: "专业科目", general: "通用", subjectPrefix: "科目",
        welcomeGeneral: "你好！我是 {botName}。今天我能为你做些什么？",
        welcomeSubject: "你好！我是 {botName}，当前处于 {subject} 科目模式。",
        placeholder: "在此输入您的消息...", you: "你",
        thinking: "正在思考", responseReceived: "已收到回复！", responseFailed: "回复失败。",
        switchedToSubject: "已切换到科目模式：", returnedToGeneral: "已返回通用模式",
        deleteAllMessages: "删除所有消息", deleteMessage: "删除消息", confirmDeleteAll: "您确定要删除所有消息吗？",
        allMessagesDeleted: "所有消息已被删除。", messageDeleted: "消息已删除。",
        listening: "正在聆听...", speechError: "语音识别错误", speechNotSupported: "浏览器不支持语音识别",
        noResponseToSpeak: "没有可播放的回复。", playAudio: "播放音频", send: "发送", speak: "说话",
        shareApp: "分享应用", shareDescription: "与朋友分享应用，帮助我们成长！", shareText: "探索 Saif AI，先进的 AI 助手！",
        copy: "复制", copied: "已复制", copiedSuccess: "复制成功", qrCodeText: "或扫描二维码分享",
        selectSubject: "选择科目", backToChat: "返回聊天",
        attachFile: "附加文件", uploadFromGallery: "从图库上传", useCamera: "使用相机", cameraError: "无法访问相机。",
        capture: "拍摄", cancel: "取消",
        installApp: "在您的设备上安装应用以便快速访问！", install: "安装", languageChanged: "语言已更改为中文", changeLanguage: "更改语言",
        errorPrefix: "抱歉，发生了错误",
        aiInstructions: "你是一个名为 {botName} 的专家 AI 助手。你的任务是提供准确详细的答案。 {subjectContext} 你所有的回复都必须严格使用 {language}。请严格遵守这些指示。",
        aiSubjectInstruction: "作为 {subject} 科目的专家进行回答。",
        suggestion1: "解释一下表面张力的概念", suggestion2: "写一个关于太空探险家的短篇故事", suggestion3: "澳大利亚的首都是哪里？", suggestion4: "把‘早上好’翻译成西班牙语"
      }
    };


    // --- START THE APP ---
    initializeApp();
  </script>

</body>
</html>
