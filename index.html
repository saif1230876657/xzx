<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- PWA: Link to Manifest File -->
  <link rel="manifest" href="manifest.json">
  <!-- PWA: Theme color for browser UI -->
  <meta name="theme-color" content="#000000" />
  <!-- PWA: Favicon for the site -->
  <link rel="icon" href="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" type="image/png">


  <!-- Social Share Meta Tags -->
  <title>Saif AI - دردشة ذكاء اصطناعي</title>
  <meta property="og:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta property="og:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta property="og:image" content="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" />
  <meta property="og:url" content="https://tinyurl.com/saif-ai" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta name="twitter:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta name="twitter:image" content="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" />

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-hue: 205;
      --primary-saturation: 85%;
      --primary-lightness: 55%;

      --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
      --primary-hover-color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 7%));
      --primary-glow-color: hsla(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%), 0.4);

      --secondary-color: #7a8cff;
      
      /* MODIFIED: Pure Black Theme */
      --bg-main: #000000;
      --bg-surface: #101010;
      --bg-surface-raised: #1c1c1c;
      --bg-input: #1c1c1c;

      --text-primary: #f0f4f8;
      --text-secondary: #a0a8b2;
      --text-on-primary: #ffffff;
      
      --border-color: #2a2a2a;
      --border-color-light: #404040;
      
      --success-color: #4ce083;
      --error-color: #ff5c5c;
      
      /* Bubble colors removed as they are no longer used */

      --shadow-xs: 0 1px 3px rgba(0,0,0,0.5);
      --shadow-sm: 0 4px 6px rgba(0,0,0,0.6);
      --shadow-md: 0 6px 12px rgba(0,0,0,0.7);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.8);
      
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;
      --border-radius-lg-buttons: 12px; 

      --chat-input-area-height: 60px; 
      --status-bar-area-height: 25px; 
      --search-log-area-height: 20px; 

      --scroll-btn-size: 42px; 
      --scroll-btn-spacing: 10px; 

      --header-height: 52px;
      --header-padding-vertical: 0.4rem; 
      --header-padding-horizontal: 0.8rem;
      --header-gap: 0.5rem;
      --header-icon-size: 1.2rem; 
      --header-icon-container-size: 32px; 
      --header-title-font-size: 1.05rem; 
      --header-btn-font-size: 0.75rem; 
      --header-btn-padding-vertical: 0.4rem; 
      --header-btn-padding-horizontal: 0.7rem; 
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-track {
      background: var(--bg-surface);
      border-radius: 3px;
    }
    *::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    html, body {
      height: 100%; 
      font-smooth: antialiased;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
    }

    body {
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      overflow: hidden; 
      padding: 0; 
    }

    .container {
      width: 100%;
      height: 100%; 
      background: var(--bg-main); 
      border: 1px solid var(--border-color); 
      border-radius: 0;
      display: flex;
      flex-direction: column; 
      overflow: hidden; 
      position: relative; 
      box-shadow: var(--shadow-lg);
    }
    
    .download-notification {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-on-primary);
      text-align: center;
      font-weight: 500;
      z-index: 100;
      box-shadow: var(--shadow-md);
      border-bottom: 1px solid var(--border-color);
      overflow: hidden;
      max-height: 0;
      padding: 0 15px;
      transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
    }
    .download-notification.show {
        max-height: 80px; 
        padding: 10px 15px; 
    }
    .notification-buttons {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: auto;
        padding-right: 15px;
    }
    .download-btn {
        background-color: rgba(255, 255, 255, 0.9);
        color: var(--primary-color);
        border: none;
        padding: 6px 14px;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        font-weight: 700;
        transition: all 0.25s ease;
        white-space: nowrap;
        font-family: 'Tajawal', sans-serif;
    }
    .download-btn:hover {
        background-color: #fff;
        transform: scale(1.05);
    }
    .close-btn {
        background: none;
        border: none;
        color: var(--text-on-primary);
        font-size: 1.8rem;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1;
        opacity: 0.8;
        transition: all 0.25s ease;
    }
    .close-btn:hover {
        opacity: 1;
        transform: rotate(90deg) scale(1.1);
    }

    .header { 
      background: var(--bg-surface);
      color: var(--text-primary);
      padding: var(--header-padding-vertical) var(--header-padding-horizontal); 
      display: flex;
      align-items: center;
      gap: var(--header-gap); 
      position: relative; 
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0; 
      z-index: 10; 
      height: var(--header-height);
    }

    .header .delete-all-btn, .header .share-btn-header { 
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: var(--header-icon-size); 
      z-index: 11; 
      padding: 5px;
      flex-shrink: 0;
    }
    .delete-all-btn:hover {
      color: var(--error-color);
      transform: rotate(10deg) scale(1.1);
    }
    .share-btn-header:hover {
        color: var(--success-color);
        transform: scale(1.15);
    }
    
    .header .fas.fa-robot { 
      font-size: var(--header-icon-size); 
      color: var(--primary-color);
      background: rgba(106, 123, 255, 0.1);
      width: var(--header-icon-container-size);
      height: var(--header-icon-container-size);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      animation: pulseIcon 2.5s infinite ease-in-out;
      flex-shrink: 0;
    }

    @keyframes pulseIcon {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; box-shadow: 0 0 10px var(--primary-glow-color); }
    }
    
    .header h1 { 
      font-size: var(--header-title-font-size); 
      font-weight: 700;
      color: var(--primary-color); 
      letter-spacing: 0.3px; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
      text-shadow: 0 0 6px rgba(106, 123, 255, 0.25);
      flex-grow: 1;
      min-width: 0;
    }

    #subjectControls { 
        display: flex;
        gap: var(--header-gap); 
        flex-shrink: 0;
    }

    .header-btn { 
        background-color: var(--bg-surface-raised); 
        color: var(--text-primary);
        border: 1px solid var(--border-color-light);
        padding: var(--header-btn-padding-vertical) var(--header-btn-padding-horizontal); 
        border-radius: var(--border-radius-md); 
        cursor: pointer;
        font-size: var(--header-btn-font-size); 
        font-weight: 500;
        transition: all 0.25s ease;
        white-space: nowrap;
        box-shadow: var(--shadow-xs);
    }
    .header-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-color);
        transform: translateY(-1px); 
        box-shadow: var(--shadow-sm), 0 0 8px var(--primary-glow-color);
    }
    .header-btn:active {
        transform: translateY(0px);
        box-shadow: var(--shadow-xs);
    }

    .chat-wrapper, #subjectsViewContainer { 
        flex: 1;
        display: flex; 
        flex-direction: column;
        overflow: hidden; 
        min-height: 0; 
    }
    
    #subjectsViewContainer {
        background-color: var(--bg-main);
        padding: 1.5rem;
        display: none; 
        align-items: center; 
    }
    
    .subjects-view-header {
        width: 100%;
        display: flex;
        justify-content: space-between; 
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .subjects-view-header h2 {
        font-size: 1.6rem;
        color: var(--primary-color);
        text-shadow: 0 0 10px rgba(106, 123, 255, 0.3);
    }

    .back-to-chat-btn {
        background-color: var(--bg-surface-raised);
        color: var(--text-primary);
        border: 1px solid var(--border-color-light);
        padding: 0.7rem 1.2rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.25s ease;
        box-shadow: var(--shadow-xs);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .back-to-chat-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm), 0 0 10px var(--primary-glow-color);
    }

    #subjectListContainer { 
        display: flex;
        flex-wrap: wrap;
        justify-content: center; 
        gap: 20px; 
        width: 100%;
        max-width: 700px; 
        overflow-y: auto; 
        padding: 10px;
    }

    .subject-item-btn {
        background: var(--bg-input); 
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 18px 22px; 
        font-size: 1rem; 
        font-weight: 500;
        min-width: 180px; 
        max-width: 220px; 
        border-radius: var(--border-radius-lg-buttons); 
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: var(--shadow-sm); 
        display: flex;
        flex-direction: column; 
        align-items: center;
        gap: 10px; 
        flex-grow: 1; 
    }
    .subject-item-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-hover-color);
        transform: translateY(-4px) scale(1.03); 
        box-shadow: var(--shadow-md), 0 0 15px var(--primary-glow-color); 
    }
    .subject-item-btn i {
        font-size: 2.2rem; 
        margin-bottom: 5px; 
        color: var(--secondary-color); 
        transition: color 0.3s ease;
    }
    .subject-item-btn:hover i {
        color: var(--text-on-primary); 
    }

    .chat-container {
      flex: 1; 
      padding: 1.5rem 1rem; 
      overflow-y: auto; 
      background: var(--bg-main);
      scroll-behavior: smooth; 
      min-height: 0; 
    }

    /* MODIFIED: Message Style (No Bubbles) */
    .message {
      max-width: 85%;
      margin-bottom: 2rem; 
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.4s ease-out;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.7;
    }

    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-content {
        padding: 0.2rem 0.5rem;
    }

    .message-header {
      font-size: 0.8rem; 
      color: var(--text-secondary);
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .delete-btn {
      color: var(--text-secondary);
      font-size: 0.8rem; 
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      opacity: 0.4; 
      padding: 3px 5px;
      border-radius: 4px;
    }
    .message:hover .delete-btn {
        opacity: 0.8;
    }
    .delete-btn:hover {
      opacity: 1;
      color: var(--error-color);
      transform: scale(1.15);
    }

    .message.user {
      align-items: flex-end;
      margin-left: auto; /* Push to the right */
    }
    .message.user .message-header {
      flex-direction: row-reverse; 
    }

    .message.bot {
      align-items: flex-start;
      margin-right: auto; /* Push to the left */
    }
    
    .message.user .message-content {
      color: #c7d2fe; /* Light blue for user text */
    }
    
    .message.bot .message-content {
      color: var(--text-primary);
    }
    
    .message.bot .message-content strong {
        color: var(--primary-color);
    }

    .message-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px; 
      padding: 0 8px; 
      flex-wrap: wrap; 
    }
    .message.user .message-actions { 
        justify-content: flex-end;
    }

    .message-actions button {
      background: var(--bg-surface-raised); 
      border: 1px solid var(--border-color); 
      cursor: pointer;
      font-size: 0.85rem; 
      padding: 5px 9px; 
      color: var(--text-secondary);
      transition: all 0.25s ease;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .message-actions button:hover {
      color: var(--text-on-primary);
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 10px var(--primary-glow-color);
    }
    
    /* MODIFIED: Transparent Input Area */
    .chat-input-area { 
        flex-shrink: 0; 
        background: transparent;
        position: relative;
    }
    
    /* Add a gradient overlay for visual separation */
    .chat-input-area::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 150px;
        background: linear-gradient(to top, var(--bg-main) 20%, transparent 100%);
        pointer-events: none; /* Allows clicks to go through */
        z-index: 4;
    }

    .chat-input {
      display: flex;
      align-items: flex-end; 
      padding: 0.8rem 1rem; 
      gap: 0.8rem; 
      position: relative; 
      z-index: 5; 
      min-height: var(--chat-input-area-height); 
      max-width: 800px;
      margin: 0 auto; /* Center the input area */
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.8rem 1.1rem; 
      border: 1px solid var(--border-color);
      resize: none;
      font-size: 0.95rem;
      outline: none;
      border-radius: var(--border-radius-xl); 
      background: var(--bg-input);
      color: var(--text-primary);
      max-height: 150px; /* Increased max height */
      line-height: 1.6;
      transition: border-color 0.25s ease, box-shadow 0.25s ease;
    }
     .chat-input textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.6;
     }
     .chat-input textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
     }

    .chat-input-btn { 
      background: var(--primary-color);
      border: none;
      color: var(--text-on-primary);
      width: 44px; 
      height: 44px; 
      border-radius: 50%; 
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; 
      transition: all 0.25s ease;
      flex-shrink: 0; 
      box-shadow: var(--shadow-sm);
    }
    .chat-input-btn:hover {
      background: var(--primary-hover-color);
      transform: scale(1.08);
      box-shadow: 0 0 15px var(--primary-glow-color);
    }
    
    .voice-indicator {
      display: none;
      align-items: center;
      justify-content: center;
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface-raised);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      gap: 8px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .voice-indicator.active {
      display: flex;
      opacity: 1;
    }
    .voice-indicator i {
      color: var(--error-color);
      animation: pulseMic 1.5s infinite ease-in-out;
    }
    @keyframes pulseMic {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    .chat-input-btn.recording {
        background-color: var(--error-color);
    }
    
    #uploadOptionsContainer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background-color: var(--bg-surface-raised);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md);
      padding: 10px;
      position: absolute;
      bottom: calc(100% + 5px);
      left: 60px;
      z-index: 10;
      box-shadow: var(--shadow-md);
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px) scale(0.95);
      transition: all 0.25s ease-out;
    }
    #uploadOptionsContainer.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }
    #uploadOptionsContainer button {
      background: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border-color-light);
      border-radius: var(--border-radius-sm);
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      text-align: right;
      width: 100%;
      white-space: nowrap;
    }
    #uploadOptionsContainer button:hover {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border-color: var(--primary-color);
    }

    .status {
      text-align: center;
      padding: 0.4rem; 
      font-size: 0.8rem; 
      background-color: var(--bg-surface);
      color: var(--text-secondary);
      border-top: 1px solid var(--border-color);
      min-height: var(--status-bar-area-height); 
      transition: color 0.3s ease;
      font-weight: 500;
    }
    
    a {
      color: var(--primary-color); 
      text-decoration: none;
      word-break: break-all;
      font-weight: 500;
    }
    
    .camera-modal, .share-modal { 
        display: none; 
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    
    .camera-modal-content, .share-modal-content { 
        background-color: var(--bg-surface);
        padding: 25px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative; 
        box-shadow: var(--shadow-lg);
    }
    
    .scroll-btn {
      position: absolute; 
      right: 25px;
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border: none;
      width: var(--scroll-btn-size);   
      height: var(--scroll-btn-size);  
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; 
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      z-index: 6; 
      opacity: 0;
      visibility: hidden;
      display: flex;
    }
    #scrollToTopBtn {
        bottom: calc(var(--chat-input-area-height) + var(--scroll-btn-size) + var(--scroll-btn-spacing) + 15px);
    }
    #scrollToBottomBtn {
        bottom: calc(var(--chat-input-area-height) + var(--scroll-btn-spacing) + 15px);
    }
    .scroll-btn.visible {
        opacity: 0.8;
        visibility: visible;
    }
    .scroll-btn:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    
    /* --- بداية التعديل --- */
    .safe-area-padding {
        height: 10px; /* هذا يضيف مسافة صغيرة في الأسفل */
        flex-shrink: 0;
        transition: height 0.3s ease;
    }
    /* --- نهاية التعديل --- */

    /* Media Queries for Responsive Design */
    @media (min-width: 1024px) {
        body { padding: 0; }
        .container {
            max-width: 100%;
            height: 100%;
            border-radius: 0;
            border: none;
        }
    }

    @media (max-width: 767px) { 
      .container {
        border-radius: 0; 
        border: none;
        height: 100%;
        width: 100%;
      }
      .message { max-width: 90%; }
    }

    @media (max-width: 480px) { 
      :root {
        --header-height: 50px;
        --header-padding-horizontal: 0.6rem;
        --header-gap: 0.4rem;
        --header-icon-size: 1.1rem;
        --header-title-font-size: 0.95rem;
        --header-btn-font-size: 0.7rem;
        --header-btn-padding-horizontal: 0.6rem;
      }
      .subjects-view-header { flex-direction: column; gap: 0.8rem; }
      .subject-item-btn { min-width: calc(50% - 10px); } 
      .message { max-width: 95%; }
      .chat-input { gap: 0.5rem; padding: 0.6rem; }
      .chat-input-btn { width: 40px; height: 40px; font-size: 1rem; }
      #uploadOptionsContainer { left: 50px; }
      
      /* --- بداية التعديل --- */
      .safe-area-padding {
          height: 0; /* على الهواتف، تختفي هذه المسافة لتوفير المساحة */
      }
      /* --- نهاية التعديل --- */
    }

  </style>
</head>
<body>
  <div class="container">
    <div id="downloadNotification" class="download-notification">
      <span id="downloadNotificationText">ثبّت التطبيق على جهازك للوصول السريع!</span>
      <div class="notification-buttons">
          <button id="downloadAppBtn" class="download-btn">تثبيت</button>
          <button id="closeNotificationBtn" class="close-btn">×</button>
      </div>
    </div>
    
    <header class="header">
      <i class="fas fa-share-alt share-btn-header" id="shareBtn" title="مشاركة التطبيق"></i>
      <i class="fas fa-trash delete-all-btn" onclick="deleteAllMessages()" title="حذف كل الرسائل"></i>
      <i class="fas fa-robot"></i>
      <h1 id="botName">Saif AI</h1>
      <div id="subjectControls">
        <button id="enterSubjectsBtn" class="header-btn">مواد متخصصة</button>
        <button id="generalChatBtn" class="header-btn" style="display: none;">عام</button>
      </div>
    </header>

    <div class="chat-wrapper" id="chatWrapper"> 
        <div id="chatContainer" class="chat-container">
          <!-- Messages will be here -->
        </div>

        <button id="scrollToTopBtn" class="scroll-btn" title="الانتقال إلى الأعلى">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button id="scrollToBottomBtn" class="scroll-btn" title="الانتقال إلى الأسفل">
          <i class="fas fa-arrow-down"></i>
        </button>
        
        <div class="chat-input-area"> 
            <div id="searchLog" class="search-log"></div>
            <div class="status" id="statusBar"></div>
            
            <div class="voice-indicator" id="voiceIndicator">
              <i class="fas fa-microphone"></i>
              <span>جاري الاستماع...</span>
            </div>

            <div class="chat-input">
              <button class="chat-input-btn" id="toggleUploadBtn" title="إرفاق ملف">
                <i class="fas fa-plus"></i>
              </button>

              <div class="upload-options-container" id="uploadOptionsContainer">
                <button onclick="triggerImageUpload()">
                  <i class="fas fa-images"></i> رفع من المعرض
                </button>
                <button onclick="openCamera()">
                  <i class="fas fa-camera"></i> استخدام الكاميرا
                </button>
              </div>

              <textarea id="userInput" rows="1" placeholder="اكتب رسالتك هنا..."></textarea>
              
              <button class="chat-input-btn" id="voiceInputBtn" title="التحدث">
                <i class="fas fa-microphone"></i>
              </button>
              
              <button class="chat-input-btn" onclick="sendMessage()" title="إرسال">
                <i class="fas fa-paper-plane"></i>
              </button>
              <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" style="display: none;" />
            </div>
            <!-- --- بداية التعديل: إضافة المساحة الفارغة --- -->
            <div class="safe-area-padding"></div>
            <!-- --- نهاية التعديل --- -->
        </div>
    </div>

    <div id="subjectsViewContainer"> 
        <div class="subjects-view-header">
            <h2>اختر المادة الدراسية</h2>
            <button id="backToChatBtn" class="back-to-chat-btn">
                <i class="fas fa-arrow-left"></i> العودة للدردشة
            </button>
        </div>
        <div id="subjectListContainer">
            <!-- Subject items will be populated here by JS -->
        </div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">التقاط صورة</button>
        <button id="cancelCameraBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <span class="close-share-modal" id="closeShareModal">×</span>
      <h2>مشاركة التطبيق</h2>
      <p>شارك الرابط مع أصدقائك لدعمنا!</p>
      <div class="share-link-container">
        <input type="text" value="https://tinyurl.com/saif-ai" id="shareLinkInput" readonly>
        <button id="copyLinkBtn"><i class="fas fa-copy"></i> نسخ</button>
      </div>
      <p class="support-message">ارجو دعمنا للاستمرار</p>
    </div>
  </div>


  <script>
    // --- API KEYS ---
    const geminiApiKey = "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk"; 
    const ocrApiKey = "K83201031288957";     

    // --- DOM ELEMENTS ---
    const chatWrapper = document.getElementById("chatWrapper");
    const chatContainer = document.getElementById("chatContainer");
    const statusBar = document.getElementById("statusBar");
    const searchLog = document.getElementById("searchLog");
    const userInput = document.getElementById("userInput");
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const voiceIndicator = document.getElementById('voiceIndicator');
    
    const subjectsViewContainer = document.getElementById('subjectsViewContainer');
    const subjectListContainer = document.getElementById('subjectListContainer'); 
    const backToChatBtn = document.getElementById('backToChatBtn');

    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;

    const enterSubjectsBtn = document.getElementById('enterSubjectsBtn');
    const generalChatBtn = document.getElementById('generalChatBtn');
    
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShareModalBtn = document.getElementById('closeShareModal');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const shareLinkInput = document.getElementById('shareLinkInput');
    
    const downloadNotification = document.getElementById('downloadNotification');
    const downloadNotificationText = document.getElementById('downloadNotificationText');
    const downloadAppBtn = document.getElementById('downloadAppBtn');
    const closeNotificationBtn = document.getElementById('closeNotificationBtn');
    
    // --- GLOBAL VARIABLES & CONSTANTS ---
    const botName = "سيف AI";
    const localStorageKeyAllChats = "saifAiAllChatsHistory_v2"; 
    const localStorageKeyAdCounter = "saifAiAdCounter";
    const localStorageKeyImageUploadDate = "saifAiImageUploadDate";
    const localStorageKeyImageUploadCount = "saifAiImageUploadCount";
    const localStorageKeyCurrentSubject = "saifAiCurrentSubject_v2";

    const AD_URL = "https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e";
    const AD_DELAY_MS = 10000; 

    let allMessages = {}; 
    let messages = [];    
    
    let successfulResponseCount = 0;
    let userMessageCounterForAds = 0;
    let statusTimeout;
    
    let currentSubject = "general"; 
    const subjects = [ 
        { name: "فيزياء", icon: "fas fa-atom" },
        { name: "كيمياء", icon: "fas fa-flask" },
        { name: "أحياء", icon: "fas fa-dna" },
        { name: "علوم", icon: "fas fa-microscope" },
        { name: "لغة عربية", icon: "fas fa-pen-nib" },
        { name: "فلسفة", icon: "fas fa-brain" },
        { name: "لغة إنجليزية", icon: "fas fa-language" },
        { name: "رياضيات", icon: "fas fa-calculator" },
        { name: "تربية دينية", icon: "fas fa-mosque" }
    ];
    
    let recognition;
    let isListening = false;
    let deferredPrompt; // PWA: For storing the install prompt event

    // --- PWA & NOTIFICATION FUNCTIONS ---
    function showAppNotification() {
      downloadNotificationText.textContent = "ثبّت التطبيق على جهازك للوصول السريع!";
      downloadAppBtn.textContent = "تثبيت";
      downloadNotification.classList.add('show');
    }

    function hideAppNotification() {
      downloadNotification.classList.remove('show');
    }

    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => console.log('Service Worker registered with scope:', registration.scope))
          .catch((error) => console.error('Service Worker registration failed:', error));
      }
    }

    // --- SPEECH RECOGNITION FUNCTIONS ---
    function initSpeechRecognition() {
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'ar-SA';

            recognition.onstart = () => {
                isListening = true;
                voiceInputBtn.classList.add('recording');
                voiceIndicator.classList.add('active');
                setStatus("جاري الاستماع...", "", null);
            };

            recognition.onresult = (event) => {
                let transcript = Array.from(event.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');
                userInput.value = transcript;
                autoResizeTextarea();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                let userMessage = "حدث خطأ في التعرف على الصوت: " + event.error;
                setStatus(userMessage, "error", 4000);
                stopListening();
            };

            recognition.onend = () => stopListening();
        } else {
            voiceInputBtn.style.display = 'none'; 
            setStatus("المتصفح لا يدعم التعرف على الصوت", "error", 3000);
        }
    }
    
    function toggleListening() {
        if (!recognition) { 
            setStatus("ميزة التعرف على الصوت غير متاحة.", "error", 3000); 
            return; 
        }
        if (isListening) { 
            recognition.stop(); 
        } else {
            try {
                userInput.value = ""; 
                autoResizeTextarea(); 
                recognition.start();
            } catch (e) {
                console.error("Error starting speech recognition:", e);
                setStatus("لا يمكن بدء التعرف على الصوت.", "error", 3000); 
                stopListening(); 
            }
        }
    }
    
    function stopListening() {
        isListening = false;
        voiceInputBtn.classList.remove('recording');
        voiceIndicator.classList.remove('active');
        if (statusBar.textContent === "جاري الاستماع...") { 
            setStatus("", "", 100); 
        }
    }
    
    // --- INITIALIZATION & EVENT LISTENERS ---
    function initializeApp() {
        registerServiceWorker(); 
    
        successfulResponseCount = parseInt(localStorage.getItem(localStorageKeyAdCounter) || '0', 10);
        
        loadAllMessagesAndSetCurrent(); 

        const storedSubject = localStorage.getItem(localStorageKeyCurrentSubject);
        if (storedSubject && (subjects.find(s => s.name === storedSubject) || storedSubject === "general")) {
            currentSubject = storedSubject;
        } else {
            currentSubject = "general";
        }
        
        messages = allMessages[currentSubject] || [];
        if (!allMessages[currentSubject]) {
            allMessages[currentSubject] = [];
        }

        updateSubjectUI(); 
        botNameElement.textContent = getBotDisplayName(); 

        addWelcomeMessage(); 
        refreshChat();
        autoResizeTextarea();

        // Event Listeners
        toggleUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            uploadOptionsContainer.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            uploadOptionsContainer.classList.remove('active');
        });

        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);
        scrollToTopBtn.addEventListener('click', () => chatContainer.scrollTo({ top: 0, behavior: 'smooth' }));
        scrollToBottomBtn.addEventListener('click', () => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }));
        chatContainer.addEventListener('scroll', handleChatScroll);
        enterSubjectsBtn.addEventListener('click', openSubjectsView);
        backToChatBtn.addEventListener('click', closeSubjectsView);
        generalChatBtn.addEventListener('click', switchToGeneralMode);
        voiceInputBtn.addEventListener('click', toggleListening);
        shareBtn.addEventListener('click', () => shareModal.style.display = 'flex');
        closeShareModalBtn.addEventListener('click', () => shareModal.style.display = 'none');
        copyLinkBtn.addEventListener('click', copyShareLink);
        downloadAppBtn.addEventListener('click', promptInstall);
        closeNotificationBtn.addEventListener('click', hideAppNotification);
        userInput.addEventListener("keydown", (e) => { if(e.key==="Enter"&&!e.shiftKey) { e.preventDefault(); sendMessage();}});
        userInput.addEventListener("input", autoResizeTextarea); 

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showAppNotification();
        });
        
        window.addEventListener('appinstalled', () => {
          console.log('PWA was installed');
          deferredPrompt = null;
          hideAppNotification();
        });
        
        window.addEventListener('click', (event) => {
            if (event.target == shareModal) shareModal.style.display = 'none';
            if (event.target == cameraModal) closeCamera();
        });
        
        handleChatScroll(); 
        populateSubjectListInView(); 
        initSpeechRecognition();
    }
    
    async function promptInstall(e) {
        e.preventDefault();
        if (deferredPrompt) {
            hideAppNotification();
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
        }
    }
    
    function copyShareLink() {
        shareLinkInput.select();
        shareLinkInput.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(shareLinkInput.value).then(() => {
            const originalText = copyLinkBtn.innerHTML;
            copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> تم النسخ';
            setTimeout(() => { copyLinkBtn.innerHTML = originalText; }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            setStatus("فشل نسخ الرابط.", "error", 2500);
        });
    }

    // --- UI & VIEW MANAGEMENT ---
    function handleChatScroll() {
        if (chatWrapper.style.display === 'none') {
            scrollToTopBtn.classList.remove('visible');
            scrollToBottomBtn.classList.remove('visible');
            return;
        }
        const { scrollTop, scrollHeight, clientHeight } = chatContainer;
        const scrollThreshold = 150; 
        scrollToTopBtn.classList.toggle('visible', scrollTop > scrollThreshold);
        scrollToBottomBtn.classList.toggle('visible', scrollHeight - scrollTop - clientHeight > scrollThreshold);
    }
    
    function openSubjectsView() {
        chatWrapper.style.display = 'none';
        subjectsViewContainer.style.display = 'flex'; 
        handleChatScroll(); 
    }

    function closeSubjectsView() {
        subjectsViewContainer.style.display = 'none';
        chatWrapper.style.display = 'flex'; 
        handleChatScroll(); 
    }

    function getBotDisplayName() {
        return currentSubject === "general" ? botName : `${botName} (${currentSubject})`;
    }
    
    function updateSubjectUI() {
        botNameElement.textContent = getBotDisplayName();
        generalChatBtn.style.display = currentSubject === "general" ? 'none' : 'inline-block';
        enterSubjectsBtn.textContent = currentSubject === "general" ? "مواد متخصصة" : `مادة: ${currentSubject}`;
        localStorage.setItem(localStorageKeyCurrentSubject, currentSubject);
    }

    function populateSubjectListInView() { 
        subjectListContainer.innerHTML = '';
        subjects.forEach(({ name, icon }) => {
            const btn = document.createElement('button');
            btn.className = 'subject-item-btn';
            btn.innerHTML = `<i class="${icon}"></i><span>${name}</span>`;
            btn.onclick = () => selectSubject(name);
            subjectListContainer.appendChild(btn);
        });
    }

    function selectSubject(subjectName) {
        if (currentSubject === subjectName) {
            closeSubjectsView();
            return;
        }
        switchSubject(subjectName);
        setStatus(`تم التحويل إلى وضع مادة: ${subjectName}`, "success", 3000);
    }

    function switchToGeneralMode() {
        if (currentSubject === "general") {
            closeSubjectsView();
            return;
        }
        switchSubject("general");
        setStatus("تم الرجوع إلى الوضع العام", "success", 3000);
    }

    function switchSubject(newSubject) {
        allMessages[currentSubject] = messages; 
        currentSubject = newSubject;
        messages = allMessages[currentSubject] || []; 
        if (!allMessages[currentSubject]) {
            allMessages[currentSubject] = [];
        }
        updateSubjectUI();
        closeSubjectsView(); 
        addWelcomeMessage(); 
        refreshChat(); 
        saveAllMessagesToLocalStorage(); 
    }
    
    // --- MESSAGE & CHAT MANAGEMENT ---
    function loadAllMessagesAndSetCurrent() {
        try {
            const storedAllMessages = localStorage.getItem(localStorageKeyAllChats);
            const parsed = storedAllMessages ? JSON.parse(storedAllMessages) : {};
            if (typeof parsed === 'object' && parsed !== null) {
                allMessages = parsed;
                Object.keys(allMessages).forEach(key => {
                    if (Array.isArray(allMessages[key])) {
                        allMessages[key] = allMessages[key].map(msg => ({
                            ...msg, timestamp: new Date(msg.timestamp) 
                        }));
                    } else {
                        allMessages[key] = [];
                    }
                });
            } else {
                allMessages = {};
            }
        } catch (e) {
            console.error("Error parsing messages:", e); 
            allMessages = {}; 
            localStorage.removeItem(localStorageKeyAllChats); 
        }
        if (!allMessages["general"] || !Array.isArray(allMessages["general"])) {
            allMessages["general"] = [];
        }
    }

    function saveAllMessagesToLocalStorage() {
        allMessages[currentSubject] = messages;
        localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allMessages));
    }

    function addWelcomeMessage() {
        let welcomeMsgText = `مرحباً بك! أنا ${getBotDisplayName()}، كيف يمكنني مساعدتك اليوم؟ 💡 يمكنك رفع صورتين يوميًا وسأحاول استخلاص النص منها وإرساله للتحليل.`;
        if (currentSubject !== "general") {
             welcomeMsgText = `مرحباً! أنا ${getBotDisplayName()}. حاليًا في وضع الإجابة عن أسئلة مادة ${currentSubject} بناءً على المنهج الدراسي. كيف يمكنني مساعدتك ضمن هذا الإطار؟`;
        }
      
        const welcomeIndex = messages.findIndex(m => m.isInitialWelcome && m.sender === "bot");
        if (welcomeIndex === -1) {
            messages = messages.filter(m => !m.isInitialWelcome); 
            const welcomeMessageObject = {
                sender: "bot", text: welcomeMsgText, isImage: false,
                isSystemMessage: true, timestamp: new Date(), isInitialWelcome: true
            };
            messages.unshift(welcomeMessageObject); 
        } else if (messages[welcomeIndex].text !== welcomeMsgText) {
            messages[welcomeIndex].text = welcomeMsgText;
        }
        saveAllMessagesToLocalStorage();
    }

    function addMessage(sender, text, isImage = false, isSystemMessage = false) {
      const message = { sender, text, isImage, isSystemMessage, timestamp: new Date() };
      messages.push(message);
      const wasNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 150;
      refreshChat(); 
      if (sender === 'user' || wasNearBottom) {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }
    }

    function linkifyAndFormatText(text) {
      if (typeof text !== 'string') return '';
      const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      return text
        .replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>')
        .replace(/\n/g, '<br>');
    }

    // MODIFIED: refreshChat for bubble-less design
    function refreshChat() {
      chatContainer.innerHTML = ""; 
      messages.forEach((msg, index) => {
        const messageElem = document.createElement("div");
        messageElem.className = `message ${msg.sender}`;
        
        let senderName = msg.sender === "bot" ? getBotDisplayName() : "أنت";
        if (msg.isSystemMessage && !msg.isInitialWelcome) senderName += " (نظام)";

        const header = document.createElement("div");
        header.className = "message-header";
        header.innerHTML = `<span>${senderName}</span><i class="fas fa-trash delete-btn" title="حذف الرسالة"></i>`;
        header.querySelector('.delete-btn').onclick = () => deleteMessage(index);
        
        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        if(msg.isImage) {
          const img = document.createElement("img");
          img.src = msg.text;
          img.style.cssText = "max-width: 100%; max-height: 300px; border-radius: var(--border-radius-md);";
          img.alt = "صورة مرسلة";
          img.onload = () => {
              if (index === messages.length - 1 || chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 350) {
                  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
              }
          };
          img.onerror = () => contentDiv.textContent = "فشل تحميل الصورة";
          contentDiv.appendChild(img);
        } else {
          contentDiv.innerHTML = linkifyAndFormatText(msg.text);
        }
        
        messageElem.appendChild(header);
        messageElem.appendChild(contentDiv);
        
        if(msg.sender === "bot" && !msg.isImage && !msg.isSystemMessage && !msg.isInitialWelcome) {
            const actionsDiv = document.createElement("div");
            actionsDiv.className = "message-actions";
            actionsDiv.innerHTML = `
                <button title="إعجاب"><i class="fas fa-thumbs-up"></i></button>
                <button title="نسخ"><i class="fas fa-copy"></i></button>
                ${(index > 0 && messages[index - 1]?.sender === 'user') ? '<button class="retry-btn" title="إعادة"><i class="fas fa-redo"></i></button>' : ''}
            `;
            actionsDiv.querySelector('[title="إعجاب"]').addEventListener("click", (e) => e.currentTarget.classList.toggle("liked"));
            actionsDiv.querySelector('[title="نسخ"]').addEventListener("click", () => {
              navigator.clipboard.writeText(msg.text) 
              .then(() => setStatus("تم النسخ 👍", "success", 1500))
              .catch(() => setStatus("فشل النسخ", "error", 2000));
            });
            if (actionsDiv.querySelector('.retry-btn')) {
                actionsDiv.querySelector('.retry-btn').onclick = () => retryQuery(index);
            }
            messageElem.appendChild(actionsDiv);
        }
        chatContainer.appendChild(messageElem);
      });
      saveAllMessagesToLocalStorage(); 
      autoResizeTextarea(); 
      handleChatScroll(); 
    }

    async function retryQuery(botMessageIndex) {
        const userMessageIndex = botMessageIndex - 1;
        if (userMessageIndex >= 0 && messages[userMessageIndex]?.sender === 'user') {
            const originalUserQuery = messages[userMessageIndex].text;
            setStatus(`إعادة: "${originalUserQuery.substring(0, 30)}..."`, "", null);
            await processQueryWithAI(originalUserQuery);
        } else {
            setStatus("خطأ: لم يتمكن من تحديد السؤال الأصلي.", "error", 3000);
        }
    }

    function deleteMessage(index) {
      messages.splice(index, 1); 
      if (!messages.some(m => m.isInitialWelcome)) addWelcomeMessage();
      refreshChat(); 
      setStatus("تم حذف الرسالة.", "success", 1500);
    }

    function deleteAllMessages() {
      const nonWelcomeMessages = messages.filter(m => !m.isInitialWelcome);
      if (nonWelcomeMessages.length === 0) {
          setStatus("لا يوجد رسائل للحذف.", "", 1500); 
          return;
      }
      if (confirm("هل أنت متأكد من حذف جميع الرسائل في هذه الدردشة؟")) {
        messages = messages.filter(m => m.isInitialWelcome); 
        addWelcomeMessage(); 
        refreshChat(); 
        setStatus("تم حذف جميع الرسائل بنجاح.", "success", 2000);
      }
    }
    
    function setStatus(message, type = "", duration = 3000) {
      clearTimeout(statusTimeout);
      statusBar.textContent = message; 
      statusBar.className = "status " + type; 
      if (message && duration !== null) {
        statusTimeout = setTimeout(() => { statusBar.textContent = ""; statusBar.className = "status"; }, duration);
      }
    }

    // --- IMAGE & OCR FUNCTIONS ---
    function triggerImageUpload() {
        uploadOptionsContainer.classList.remove('active'); 
        imageUploadInput.click();
    }

    function handleFileSelect(event) {
        const file = event.target.files?.[0];
        if (file) {
            processAndUploadImageFile(file); 
            event.target.value = ""; 
        }
    }
    
    async function processAndUploadImageFile(file) {
        if (!checkImageUploadLimit()) return;
        setTimeout(() => { window.open(AD_URL, '_blank'); }, AD_DELAY_MS); 
        if (file.size > 5 * 1024 * 1024) { 
            setStatus("حجم الصورة كبير (الحد 5 ميجا).", "error", 3000); 
            return; 
        }
        const reader = new FileReader();
        reader.onload = (e) => { 
            addMessage("user", e.target.result, true); 
            extractTextFromImageAndProcess(file); 
        }
        reader.readAsDataURL(file);
        incrementImageUploadCount();
    }

    function checkImageUploadLimit() {
        const today = new Date().toISOString().split('T')[0];
        const lastUploadDate = localStorage.getItem(localStorageKeyImageUploadDate);
        let uploadCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        if (lastUploadDate === today && uploadCount >= 2) {
            setStatus("تعديت حد الصور اليومي (2).", "error", 4000);
            addMessage("bot", "عفواً، استنفدت حصة رفع الصور اليومية.", false, true); 
            return false;
        }
        if (lastUploadDate !== today) {
            localStorage.setItem(localStorageKeyImageUploadDate, today);
            localStorage.setItem(localStorageKeyImageUploadCount, "0");
        }
        return true;
    }

    function incrementImageUploadCount() {
        let currentCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        localStorage.setItem(localStorageKeyImageUploadCount, (currentCount + 1).toString());
        localStorage.setItem(localStorageKeyImageUploadDate, new Date().toISOString().split('T')[0]); 
    }

    async function extractTextFromImageAndProcess(file) {
        if (!ocrApiKey) { 
             addMessage("bot", "ميزة OCR غير مفعلة.", false, true);
             setStatus("مفتاح OCR غير مكوّن.", "error", 5000); 
             return;
        }
        setStatus(`جاري معالجة الصورة...`, "", null); 
        const formData = new FormData();
        formData.append('apikey', ocrApiKey); 
        formData.append('language', 'ara'); 
        formData.append('file', file);
        try {
            const ocrResponse = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
            if (!ocrResponse.ok) throw new Error(`فشل OCR: ${ocrResponse.statusText}`);
            
            const ocrData = await ocrResponse.json();
            if (ocrData.IsErroredOnProcessing) throw new Error(`خطأ معالجة OCR: ${ocrData.ErrorMessage.join(', ')}`);
            
            const extractedText = ocrData.ParsedResults?.[0]?.ParsedText.trim();
            if (extractedText) {
                addMessage("bot", `النص من الصورة:\n"${extractedText}"`, false, true); 
                setStatus("تم استخلاص النص، جاري التحليل...", "success", 2500);
                await processQueryWithAI(extractedText); 
            } else {
                addMessage("bot", "لم يتم العثور على نص واضح في الصورة.", false, true);
                setStatus("لم يتم استخلاص نص.", "error", 3000);
            }
        } catch (error) {
            console.error("خطأ OCR:", error);
            addMessage("bot", `خطأ استخلاص النص: ${error.message}`, false, true);
            setStatus("فشل استخلاص النص.", "error", 4000);
        }
    }
    
    // --- AI & GEMINI FUNCTIONS ---
    function generateChatPrompt(userMessage) {
      const maxHistoryMessages = 8;
      const textMessages = messages.filter(m => !m.isImage && !m.isSystemMessage);
      const history = textMessages.slice(-maxHistoryMessages);
      
      let relevantHistory = history.map(msg => 
          (msg.sender === "user" ? "المستخدم: " : `${getBotDisplayName()}: `) + msg.text
      ).join("\n");

      let baseSystemPrompt = `أنت ${getBotDisplayName()}، مساعد ذكاء اصطناعي ودود، صادق، وإيجابي. هدفك هو مساعدة المستخدم بوضوح وبطريقة تفاعلية. إذا لم تعرف الإجابة، اعترف بذلك. استخدم بعض الرموز التعبيرية باعتدال. إذا سُئلت "من صنعك" أو "من مطورك"، أجب "أنا من صنع وتطوير سيف هاني".\n\n`;
      
      if (currentSubject !== "general") {
          baseSystemPrompt = `أنت الآن خبير مادة "${currentSubject}". جميع إجاباتك يجب أن تستند بشكل صارم إلى المنهج الدراسي المعتمد. لا تقدم أي معلومات خارج هذا النطاق. إذا كان السؤال خارج النطاق، وضح ذلك.\n\n` + baseSystemPrompt;
      }
      
      return `${baseSystemPrompt}${relevantHistory}\nالمستخدم: ${userMessage}\n${getBotDisplayName()}:`;
    }

    async function fetchGeminiResponse(prompt) {
      if (!geminiApiKey) { throw new Error("خدمة AI غير مكوّنة."); }
      
      const requestBody = { contents: [{ parts: [{ text: prompt }] }] };
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
      
      try {
        const response = await fetch(url, {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(requestBody)
        });

        if(!response.ok) {
          const errorData = await response.json().catch(() => ({})); 
          throw new Error(`خطأ ${response.status}: ${errorData.error?.message || response.statusText}`);
        }

        const data = await response.json();
        const candidate = data.candidates?.[0];
        
        if (candidate?.content?.parts?.[0]?.text) {
            return candidate.content.parts[0].text;
        }
        if (data.promptFeedback?.blockReason) {
            return `لم أتمكن من معالجة طلبك (السبب: ${data.promptFeedback.blockReason}).`;
        }
        if (candidate?.finishReason && candidate.finishReason !== "STOP") {
            return `لم يتم استلام رد مكتمل (السبب: ${candidate.finishReason}).`;
        }
        
        return "لم يتم استلام رد بالتنسيق الصحيح من Gemini.";

      } catch (error) {
          console.error("Gemini Fetch Error:", error);
          if (error.message.toLowerCase().includes('failed to fetch')) {
              throw new Error("فشل الاتصال بالخادم. تحقق من الإنترنت.");
          }
          throw error; 
      }
    }

    async function processQueryWithAI(queryText) {
        if (!queryText?.trim()) return;
        
        searchLog.textContent = `بحث: ${queryText.substring(0, 60)}...`;
        setStatus(`${getBotDisplayName()} يفكر...`, "", null); 
        
        try {
            const responseText = await fetchGeminiResponse(generateChatPrompt(queryText));
            addMessage("bot", responseText);
            setStatus("تم استلام الرد! ✅", "success"); 
            successfulResponseCount++;
            localStorage.setItem(localStorageKeyAdCounter, successfulResponseCount.toString());
        } catch (error) {
            console.error("فشل إرسال لـ Gemini:", error);
            const displayError = `عفواً، واجهت مشكلة: ${error.message}`;
            addMessage("bot", displayError, false, true); 
            setStatus("فشل الرد من Gemini. ❌", "error"); 
        }
    }

    async function sendMessage() {
      const messageText = userInput.value.trim();
      if (!messageText) return;
      
      addMessage("user", messageText);
      userInput.value = ""; 
      autoResizeTextarea(); 
      
      userMessageCounterForAds++;
      if (userMessageCounterForAds % 4 === 0) { 
          setTimeout(() => { window.open(AD_URL, '_blank'); }, 500); 
      }
      
      await processQueryWithAI(messageText);
    }

    // --- UTILITY FUNCTIONS ---
    function autoResizeTextarea() {
        userInput.style.height = 'auto'; 
        const newHeight = userInput.scrollHeight;
        const maxHeight = 150; // Corresponds to CSS max-height
        userInput.style.overflowY = newHeight > maxHeight ? 'auto' : 'hidden';
        userInput.style.height = Math.min(newHeight, maxHeight) + 'px';
    }
    
    // --- CAMERA FUNCTIONS ---
    async function openCamera() {
        uploadOptionsContainer.classList.remove('active'); 
        if (!checkImageUploadLimit()) return;
        
        if (navigator.mediaDevices?.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                cameraView.srcObject = cameraStream; 
                cameraModal.style.display = "flex"; 
            } catch (err) {
                setStatus("لا يمكن الوصول للكاميرا.", "error", 4000);
                addMessage("bot", "عفواً، لم أتمكن من الوصول للكاميرا.", false, true);
            }
        } else {
            setStatus("متصفحك لا يدعم الكاميرا.", "error", 4000);
            addMessage("bot","متصفحك لا يدعم استخدام الكاميرا.", false, true);
        }
    }

    function closeCamera() {
        if (cameraStream) { 
            cameraStream.getTracks().forEach(track => track.stop()); 
        }
        cameraView.srcObject = null; 
        cameraModal.style.display = "none"; 
    }

    async function captureImageFromCamera() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraView.videoWidth; 
        canvas.height = cameraView.videoHeight;
        canvas.getContext('2d').drawImage(cameraView, 0, 0);
        closeCamera(); 
        
        canvas.toBlob(async (blob) => {
            if (blob) {
                const file = new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' });
                await processAndUploadImageFile(file);
            } else {
                 setStatus("فشل التقاط الصورة.", "error", 3000);
                 addMessage("bot", "خطأ أثناء التقاط الصورة.", false, true);
            }
        }, 'image/jpeg', 0.9); 
    }

    // --- START THE APP ---
    initializeApp();
  </script>

</body>
</html>
