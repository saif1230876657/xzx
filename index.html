<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saif AI - دردشة ذكاء اصطناعي</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-hue: 205;
      --primary-saturation: 75%;
      --primary-lightness: 42%;

      --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
      --primary-hover-color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 5%));
      --primary-glow-color: hsla(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%), 0.5);

      --secondary-color: #6a7bff;
      --accent-color: #ff7eb3;
      
      --bg-main: #1a1d1e;
      --bg-surface: #24292b;
      --bg-surface-raised: #2e3335;
      --bg-input: #2e3335;

      --text-primary: #eef2f4;
      --text-secondary: #a5b3c1;
      --text-on-primary: #ffffff;
      
      --border-color: #3c4245;
      --border-color-light: #4d5458;
      
      --success-color: #4ac97c;
      --error-color: #ff6b6b;
      
      --user-message-bg: var(--secondary-color);
      --bot-message-bg: var(--bg-surface-raised);

      --shadow-xs: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-sm: 0 4px 6px rgba(0,0,0,0.35);
      --shadow-md: 0 6px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.45);
      
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;
      --border-radius-lg-buttons: 12px; 

      --chat-input-area-height: 60px; 
      --status-bar-area-height: 25px; 
      --search-log-area-height: 20px; 

      --scroll-btn-size: 42px; 
      --scroll-btn-spacing: 10px; 
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-track {
      background: var(--bg-surface);
      border-radius: 3px;
    }
    *::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    html, body {
      height: 100%; 
      font-smooth: antialiased;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0; 
      padding: 0; 
    }

    body {
      background: linear-gradient(135deg, #141618 0%, #1c2023 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      overflow: hidden; 
      padding: 15px;
    }

    .container {
      width: 100%;
      max-width: 800px;
      height: 100%; 
      background: var(--bg-surface); 
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      display: flex;
      flex-direction: column; 
      overflow: hidden; 
      position: relative; 
      box-shadow: var(--shadow-lg);
    }

    .header {
      background: linear-gradient(to right, var(--bg-surface-raised), var(--bg-surface));
      color: var(--text-primary);
      padding: 0.8rem 1.2rem; 
      display: flex;
      align-items: center;
      gap: 0.8rem; 
      position: relative; 
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0; 
      z-index: 10; 
    }

    .header .delete-all-btn {
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: 1.1rem; 
      z-index: 11; 
      order: -1; 
      margin-right: auto; 
    }
    .delete-all-btn:hover {
      color: var(--error-color);
      transform: rotate(10deg) scale(1.1);
    }
    
    .header .fas.fa-robot {
      font-size: 1.6rem; 
      color: var(--primary-color);
      background: rgba(106, 123, 255, 0.1);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      animation: pulseIcon 2.5s infinite ease-in-out;
    }

    @keyframes pulseIcon {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; box-shadow: 0 0 15px var(--primary-glow-color); }
    }
    
    .header h1 {
      font-size: 1.25rem; 
      font-weight: 700;
      color: var(--primary-color); 
      letter-spacing: 0.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-left: 0.4rem; 
      margin-right: 0.4rem;
      flex-grow: 0; 
      text-align: center;
      text-shadow: 0 0 8px rgba(106, 123, 255, 0.3);
    }

    #subjectControls {
        display: flex;
        gap: 0.8rem; 
    }

    .header-btn {
        background-color: var(--bg-surface-raised); 
        color: var(--text-primary);
        border: 1px solid var(--border-color-light);
        padding: 0.6rem 1rem; 
        border-radius: var(--border-radius-md); 
        cursor: pointer;
        font-size: 0.85rem; 
        font-weight: 500;
        transition: all 0.25s ease;
        white-space: nowrap;
        box-shadow: var(--shadow-xs);
    }
    .header-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm), 0 0 10px var(--primary-glow-color);
    }
    .header-btn:active {
        transform: translateY(0px);
        box-shadow: var(--shadow-xs);
    }

    .chat-container {
      flex: 1; 
      padding: 1.2rem 0.9rem; 
      overflow-y: auto; 
      background: var(--bg-main);
      scroll-behavior: smooth; 
      min-height: 0; 
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(42, 60, 87, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(106, 123, 255, 0.05) 0%, transparent 20%);
    }

    .message {
      margin-bottom: 1.4rem; 
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.4s ease-out;
    }

    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(15px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-header {
      font-size: 0.75rem; 
      color: var(--text-secondary);
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      padding: 0 8px; 
    }

    .delete-btn {
      color: var(--text-secondary);
      font-size: 0.8rem; 
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      opacity: 0.5; 
      background: rgba(255,255,255,0.05);
      padding: 3px 5px;
      border-radius: 4px;
    }

    .delete-btn:hover {
      opacity: 1;
      color: var(--error-color);
      transform: scale(1.15);
      background: rgba(255,107,107,0.1);
    }

    .message.user {
      align-items: flex-end;
    }
    .message.user .message-header {
      flex-direction: row-reverse; 
    }

    .message.bot {
      align-items: flex-start;
    }

    .bubble {
      max-width: 80%; 
      padding: 0.9rem 1.2rem; 
      border-radius: var(--border-radius-md); 
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.65;
      transition: all 0.25s ease;
      box-shadow: var(--shadow-xs);
      position: relative;
    }

    .message.user .bubble {
      background: var(--user-message-bg);
      color: var(--text-on-primary);
      border-bottom-right-radius: var(--border-radius-sm); 
    }

    .message.bot .bubble {
      background: var(--bot-message-bg);
      color: var(--text-primary);
      border-bottom-left-radius: var(--border-radius-sm); 
      border: 1px solid rgba(255,255,255,0.05);
    }

    .message:hover .bubble {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .message-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px; 
      padding: 0 8px; 
    }
    .message.user .message-actions { 
        justify-content: flex-end;
    }

    .message-actions button {
      background: rgba(255,255,255,0.08); 
      border: 1px solid var(--border-color-light); 
      cursor: pointer;
      font-size: 0.9rem; 
      padding: 5px 9px; 
      color: var(--text-secondary);
      transition: all 0.25s ease;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .message-actions button:hover {
      color: var(--text-on-primary);
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 10px var(--primary-glow-color);
    }

    .message-actions button.liked {
      color: var(--success-color);
      border-color: var(--success-color);
      background: rgba(74, 201, 124, 0.1);
    }
     .message-actions button.liked:hover {
      background-color: var(--success-color);
      color: var(--text-on-primary);
      box-shadow: 0 0 10px rgba(74, 201, 124, 0.4);
    }
    .message-actions button.retry-btn i { 
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 15%));
    }
    .message-actions button.retry-btn:hover i {
      color: var(--text-on-primary); 
    }


    .chat-input {
      display: flex;
      align-items: flex-end; 
      border-top: 1px solid var(--border-color);
      padding: 0.8rem 1rem; 
      background: var(--bg-surface); 
      gap: 0.8rem; 
      position: relative; 
      z-index: 5; 
      flex-shrink: 0; 
      min-height: var(--chat-input-area-height); 
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.8rem 1.1rem; 
      border: 1px solid var(--border-color);
      resize: none;
      font-size: 0.95rem;
      outline: none;
      border-radius: var(--border-radius-xl); 
      background: var(--bg-input);
      color: var(--text-primary);
      max-height: 120px; 
      line-height: 1.6;
      transition: border-color 0.25s ease, box-shadow 0.25s ease;
    }
     .chat-input textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.6;
     }
     .chat-input textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
     }

    .chat-input-btn { 
      background: var(--primary-color);
      border: none;
      color: var(--text-on-primary);
      width: 44px; 
      height: 44px; 
      border-radius: 50%; 
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; 
      transition: all 0.25s ease;
      flex-shrink: 0; 
      box-shadow: var(--shadow-sm);
    }
    .chat-input-btn:hover {
      background: var(--primary-hover-color);
      transform: scale(1.08);
      box-shadow: 0 0 15px var(--primary-glow-color);
    }
    .chat-input-btn:active {
        transform: scale(0.92);
    }
    
    .chat-input-btn.recording {
        background: var(--error-color);
        animation: pulseRecording 1.5s infinite;
    }
    
    @keyframes pulseRecording {
        0% { box-shadow: 0 0 0 0 rgba(255,107,107,0.5); }
        70% { box-shadow: 0 0 0 12px rgba(255,107,107,0); }
        100% { box-shadow: 0 0 0 0 rgba(255,107,107,0); }
    }

    #imageUpload {
      display: none;
    }

    .upload-options-container {
      position: absolute;
      bottom: calc(100% + 8px); 
      right: 55px; 
      background-color: var(--bg-surface-raised);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .upload-options-container.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .upload-options-container button {
      background-color: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border-color-light);
      padding: 10px 14px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      transition: all 0.25s ease;
      text-align: right; 
    }
    .upload-options-container button:hover {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    .upload-options-container button i {
      font-size: 1.1rem;
      margin-left: 8px; 
    }


    .status {
      text-align: center;
      padding: 0.4rem; 
      font-size: 0.8rem; 
      background-color: var(--bg-surface);
      color: var(--text-secondary);
      border-top: 1px solid var(--border-color);
      min-height: var(--status-bar-area-height); 
      transition: color 0.3s ease;
      flex-shrink: 0; 
      font-weight: 500;
    }

    .status.success { color: var(--success-color); }
    .status.error { color: var(--error-color); }

    a {
      color: var(--primary-color); 
      text-decoration: none;
      word-break: break-all;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
    }

    .search-log {
      text-align: center;
      font-size: 0.75rem; 
      color: var(--text-secondary);
      opacity: 0.7; 
      padding: 0.2rem 0; 
      border-top: 1px dashed var(--border-color-light);
      background-color: var(--bg-main);
      min-height: var(--search-log-area-height);
      flex-shrink: 0; 
      font-weight: 500;
    }

    .toggle-details-btn {
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 500;
      border: none;
      background: none;
      padding: 0;
      margin-top: 10px;
      display: block; 
      text-align: right; 
      font-size: 0.9rem;
      transition: color 0.25s ease;
    }

    .toggle-details-btn:hover {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .camera-modal, .subject-modal { 
        display: none; 
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    .camera-modal-content { 
        background-color: var(--bg-surface);
        padding: 25px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative; 
        box-shadow: var(--shadow-lg);
    }
    .subject-modal-content {
        background-color: var(--bg-surface);
        padding: 30px; 
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        width: 550px; 
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        box-shadow: var(--shadow-lg);
    }

    #cameraView {
        width: 100%;
        max-width: 450px;
        height: auto;
        border-radius: var(--border-radius-md);
        margin-bottom: 20px;
        background-color: #000; 
    }
    .camera-controls button { 
        background: var(--primary-color);
        border: none;
        color: var(--text-on-primary);
        padding: 12px 24px;
        font-size: 1rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        margin: 8px; 
        transition: background-color 0.25s ease;
        font-weight: 500;
    }
     .camera-controls button:hover { 
        background: var(--primary-hover-color);
        transform: translateY(-2px);
    }
    .camera-controls button#cancelCameraBtn {
        background-color: var(--error-color);
    }
    .camera-controls button#cancelCameraBtn:hover {
        background-color: hsl(0, 90%, 45%); 
    }

    .subject-modal-content h2 {
        font-size: 1.8rem; 
        color: var(--primary-color);
        margin-bottom: 30px; 
        font-weight: 700;
        text-shadow: 0 0 10px rgba(106, 123, 255, 0.3);
    }
    .subject-modal-content .close-modal-btn {
        position: absolute;
        top: 15px;
        left: 20px; 
        font-size: 1.8rem;
        color: var(--text-secondary);
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.25s ease;
    }
     .subject-modal-content .close-modal-btn:hover {
        color: var(--text-primary);
        background: rgba(255,255,255,0.1);
     }
    #subjectListContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 18px; 
        margin-top: 20px;
        width: 100%;
    }
    #subjectListContainer button {
        background: var(--bg-input); 
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 16px 26px; 
        font-size: 1.05rem; 
        font-weight: 500;
        min-width: 160px; 
        border-radius: var(--border-radius-lg-buttons); 
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: var(--shadow-sm); 
    }
    #subjectListContainer button:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-hover-color);
        transform: translateY(-4px) scale(1.03); 
        box-shadow: var(--shadow-md), 0 0 15px var(--primary-glow-color); 
    }
    #subjectListContainer button:active {
        transform: translateY(0px) scale(1);
    }

    .scroll-btn {
      position: absolute; 
      right: 25px;
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border: none;
      width: var(--scroll-btn-size);   
      height: var(--scroll-btn-size);  
      border-radius: 50%;
      display: none; 
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; 
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      z-index: 3; 
      opacity: 0;
      visibility: hidden;
    }
    .scroll-btn:hover {
      background-color: var(--primary-hover-color);
      transform: scale(1.12);
      box-shadow: 0 0 15px var(--primary-glow-color);
    }
    .scroll-btn.visible {
        display: flex;
        opacity: 0.85; 
        visibility: visible;
    }
    .scroll-btn.visible:hover {
        opacity: 1; 
    }

    #scrollToBottomBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing));
    }
    #scrollToTopBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing) + var(--scroll-btn-size) + var(--scroll-btn-spacing));
    }
    
    .voice-indicator {
        position: absolute;
        top: -30px; 
        left: 50%;
        transform: translateX(-50%);
        background: var(--error-color); 
        color: white;
        padding: 5px 12px;
        border-radius: 20px; 
        font-size: 0.8rem;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        z-index: 6; 
    }
    .voice-indicator.active {
        opacity: 1;
    }
    
    /* Smart Chat / TTS Overlay and Indicator */
    .speaking-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); 
        /* backdrop-filter: blur(3px); */
        z-index: 2000; 
        display: none; 
    }
    .speaking-indicator-circle {
        position: fixed;
        top: 45%; /* Adjusted slightly for close button */
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background-color: var(--primary-color);
        border-radius: 50%;
        display: none; 
        align-items: center;
        justify-content: center;
        color: var(--text-on-primary);
        font-size: 2rem;
        z-index: 2001; 
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .speaking-indicator-circle.speaking-animation {
        animation: pulseSpeakingCircle 1.5s infinite ease-in-out;
    }
    @keyframes pulseSpeakingCircle {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
    }

    .close-smart-chat-btn {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 25px;
        background-color: var(--error-color);
        color: white;
        border: none;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        z-index: 2002; 
        display: none; 
        box-shadow: var(--shadow-md);
        transition: background-color 0.2s ease;
    }
    .close-smart-chat-btn:hover {
        background-color: hsl(0, 80%, 55%);
    }
    .close-smart-chat-btn i {
        margin-right: 8px;
    }


    /* Media Queries for Responsiveness */
    @media (max-width: 768px) { 
      .container {
        border-radius: 16px; 
      }
      body { 
        padding: 10px;
      }
      :root { 
        --chat-input-area-height: 55px; 
        --status-bar-area-height: 22px;
        --search-log-area-height: 18px;
        --scroll-btn-size: 38px;
        --scroll-btn-spacing: 8px;
      }
      .header { padding: 0.7rem 1rem; gap: 0.6rem;}
      .header h1 { font-size: 1.15rem; margin-left: 0.3rem; margin-right: 0.3rem;}
      .header .fas.fa-robot { font-size: 1.4rem; width: 36px; height: 36px; }
      .delete-all-btn { font-size: 1.05rem; }
      .header-btn { font-size: 0.8rem; padding: 0.5rem 0.8rem;}
      #subjectControls { gap: 0.5rem;}

      .bubble { max-width: 85%; padding: 0.8rem 1rem; line-height: 1.6; }
      .chat-input { padding: 0.6rem 0.8rem; gap: 0.6rem; } 
      .chat-input textarea { font-size: 0.9rem; padding: 0.7rem 1rem; } 
      .chat-input-btn { width: 40px; height: 40px; font-size: 1rem; } 
      .upload-options-container { right: 48px; } 
      .upload-options-container button { padding: 8px 12px; font-size: 0.85rem; }
      .speaking-indicator-circle { width: 70px; height: 70px; font-size: 1.8rem; top: 42%;}
      .close-smart-chat-btn { padding: 10px 20px; font-size: 0.9rem;}
    }

    @media (max-width: 480px) { 
      :root {
        --chat-input-area-height: 52px; 
        --status-bar-area-height: 20px;
        --search-log-area-height: 16px;
        --scroll-btn-size: 36px;
        --scroll-btn-spacing: 6px;
      }
       body { 
        padding: 8px;
      }
      .header { 
        padding: 0.6rem 0.8rem; 
        gap: 0.4rem; 
        flex-wrap: wrap; 
        justify-content: center;
      }
       .header .delete-all-btn {
        order: 1; 
        margin: 0 4px; 
        font-size: 1rem;
      }
      .header .fas.fa-robot {
        order: 2;
        margin: 0 4px;
        font-size: 1.3rem;
        width: 34px;
        height: 34px;
      }
      .header h1 { 
        order: 3;
        font-size: 1.1rem; 
        width: 100%; 
        text-align: center;
        margin: 5px 0; 
      }
      #subjectControls { 
        order: 4; 
        width: 100%; 
        justify-content: center; 
        margin-top: 0.3rem; 
        gap: 0.5rem;
      }
      
      .subject-modal-content {
        width: 92%;
        padding: 20px;
      }
      .subject-modal-content h2 {
        font-size: 1.6rem;
        margin-bottom: 20px;
      }
      #subjectListContainer button {
        padding: 14px 20px;
        font-size: 0.95rem;
        min-width: 140px;
      }

      .chat-container { padding: 1rem 0.6rem; }
      .message-header { font-size: 0.7rem; gap: 5px; }
      .bubble { max-width: 90%; padding: 0.7rem 0.9rem; line-height: 1.55; }
      .message-actions button { font-size: 0.85rem; padding: 4px 8px; }
      
      .chat-input { padding: 0.5rem 0.6rem; gap: 0.5rem; }
      .chat-input textarea { font-size: 0.85rem; padding: 0.6rem 0.9rem; max-height: 100px; }
      .chat-input-btn { width: 38px; height: 38px; font-size: 0.95rem; }
      .upload-options-container { right: 44px; }  
      .upload-options-container button { padding: 7px 10px; font-size: 0.8rem; }
      .upload-options-container button i { font-size: 1rem; }
      .status { font-size: 0.75rem; padding: 0.3rem;}
      .search-log { font-size: 0.7rem; padding: 0.15rem 0;}
      .scroll-btn { right: 18px; }
      .toggle-details-btn { font-size: 0.85rem; }
      .header-btn { font-size: 0.75rem; padding: 0.4rem 0.7rem;}
      .speaking-indicator-circle { width: 65px; height: 65px; font-size: 1.6rem; top: 40%;}
      .close-smart-chat-btn { padding: 10px 18px; font-size: 0.85rem; bottom: 20px;}
    }

    @media (max-width: 360px) { 
       :root {
        --chat-input-area-height: 50px;
        --status-bar-area-height: 20px; 
        --search-log-area-height: 15px;
        --scroll-btn-size: 34px;
       }
      .header h1 { font-size: 1rem; }
      .bubble { padding: 0.6rem 0.8rem; }
      .chat-input textarea { padding: 0.5rem 0.8rem; }
      .chat-input-btn { width: 36px; height: 36px; }
      .upload-options-container { right: 42px; } 
    }

  </style>
</head><body>
  <div class="container">
    <header class="header">
      <i class="fas fa-trash delete-all-btn" onclick="deleteAllMessages()" title="حذف كل الرسائل"></i>
      <i class="fas fa-robot"></i>
      <h1 id="botName">Saif AI</h1>
      <div id="subjectControls">
        <button id="enterSubjectsBtn" class="header-btn">مواد متخصصة</button>
        <button id="generalChatBtn" class="header-btn" style="display: none;">عام</button>
      </div>
    </header>

    <div id="chatContainer" class="chat-container">
      <!-- Messages will be here -->
    </div>

    <button id="scrollToTopBtn" class="scroll-btn" title="الانتقال إلى الأعلى">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button id="scrollToBottomBtn" class="scroll-btn" title="الانتقال إلى الأسفل">
      <i class="fas fa-arrow-down"></i>
    </button>

    <div id="searchLog" class="search-log"></div>
    <div class="status" id="statusBar"></div>

    <div class="chat-input">
      <textarea id="userInput" rows="1" placeholder="اكتب رسالتك هنا..."></textarea>
      
      <div class="voice-indicator" id="voiceIndicator">
        <i class="fas fa-microphone"></i>
        <span>جاري الاستماع...</span>
      </div>
      
      <div class="upload-options-container" id="uploadOptionsContainer">
        <button onclick="triggerImageUpload()">
           رفع من المعرض <i class="fas fa-images"></i>
        </button>
        <button onclick="openCamera()">
           استخدام الكاميرا <i class="fas fa-camera"></i>
        </button>
        <button onclick="startSmartChat()">
            دردشة ذكية <i class="fas fa-brain"></i>
        </button>
      </div>
      
      <button class="chat-input-btn" id="toggleUploadBtn" title="إرفاق ملف أو بدء دردشة ذكية">
        <i class="fas fa-plus"></i>
      </button>
      
      <button class="chat-input-btn" id="voiceInputBtn" title="التحدث (يدوي)">
        <i class="fas fa-microphone"></i>
      </button>
      
      <button class="chat-input-btn" onclick="sendMessage()" title="إرسال">
        <i class="fas fa-paper-plane"></i>
      </button>
      <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" />
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">التقاط صورة</button>
        <button id="cancelCameraBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Subject Selection Modal -->
  <div id="subjectModal" class="subject-modal">
    <div class="subject-modal-content">
      <button class="close-modal-btn" onclick="closeSubjectModal()" title="إغلاق">×</button>
      <h2>اختر المادة</h2>
      <div id="subjectListContainer">
        <!-- Subject buttons will be populated here -->
      </div>
    </div>
  </div>

  <!-- Smart Chat UI Elements -->
  <div id="speakingOverlay" class="speaking-overlay"></div>
  <div id="speakingIndicatorCircle" class="speaking-indicator-circle">
      <i id="smartChatIcon" class="fas fa-microphone"></i> <!-- Default to mic for listening -->
  </div>
  <button id="closeSmartChatBtn" class="close-smart-chat-btn">
      <i class="fas fa-times"></i> إيقاف الدردشة الذكية
  </button>


  <script>
    const geminiApiKey = "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk"; 
    const ocrApiKey = "K83201031288957";     

    const chatContainer = document.getElementById("chatContainer");
    const statusBar = document.getElementById("statusBar");
    const searchLog = document.getElementById("searchLog");
    const userInput = document.getElementById("userInput");
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const voiceIndicator = document.getElementById('voiceIndicator'); // For manual voice input button

    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;

    const enterSubjectsBtn = document.getElementById('enterSubjectsBtn');
    const generalChatBtn = document.getElementById('generalChatBtn');
    const subjectModal = document.getElementById('subjectModal');
    const subjectListContainer = document.getElementById('subjectListContainer');
    
    // Smart Chat UI elements
    const speakingOverlay = document.getElementById('speakingOverlay');
    const speakingIndicatorCircle = document.getElementById('speakingIndicatorCircle');
    const smartChatIcon = document.getElementById('smartChatIcon'); // The <i> tag inside the circle
    const closeSmartChatBtn = document.getElementById('closeSmartChatBtn');


    const botName = "سيف AI";
    const localStorageKeyAllChats = "saifAiAllChatsHistory_v2"; 
    const localStorageKeyAdCounter = "saifAiAdCounter";
    const localStorageKeyImageUploadDate = "saifAiImageUploadDate";
    const localStorageKeyImageUploadCount = "saifAiImageUploadCount";
    const localStorageKeyCurrentSubject = "saifAiCurrentSubject_v2";


    const AD_URL = "https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e";
    const AD_DELAY_MS = 10000; 

    let allMessages = {}; 
    let messages = [];    
    
    let successfulResponseCount = 0;
    let userMessageCounterForAds = 0;
    let statusTimeout;
    
    let currentSubject = "general"; 
    const subjects = ["فيزياء", "كيمياء", "أحياء", "علوم", "لغة عربية", "فلسفة", "لغة إنجليزية", "رياضيات", "تربية دينية"];
    
    let recognition;
    let isListening = false; // General flag for speech rec active (manual or smart)
    let isSmartChatActive = false; // Specific flag for smart chat mode
    let ttsUtterance; 

    // Main handler for speech recognition ending
    function defaultRecognitionOnEnd() {
        const currentTranscript = userInput.value.trim();
        stopListening(); // Resets manual voice input button UI

        if (isSmartChatActive) {
            if (currentTranscript !== "") {
                // Smart chat is active and user spoke. Process the message.
                // Icon will be changed to volume-up by speakText.
                // Overlay, indicator, close button remain visible.
                sendMessage(); // This will process and call speakText
            } else {
                // No speech detected, but smart chat is active. Restart listening.
                if (isSmartChatActive) { // Check flag again, might have been changed by an error
                    smartChatIcon.className = 'fas fa-microphone speaking-animation';
                    speakingIndicatorCircle.classList.add('speaking-animation');
                    // Overlay and close button should still be visible.
                    userInput.value = ""; 
                    autoResizeTextarea();
                    try { recognition.start(); } catch(e) { console.error("Error restarting smart chat recognition:", e); stopSmartChat(); }
                }
            }
        } else {
            // Manual voice input ended OR smart chat was explicitly stopped.
            // If smart chat was stopped, stopSmartChat() would have hidden its UI.
        }
    }


    // Initialize speech recognition
    function initSpeechRecognition() {
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false; 
            recognition.interimResults = true; 
            recognition.lang = 'ar-SA';

            recognition.onstart = function() {
                isListening = true; // General listening flag
                if (!isSmartChatActive) { // Only for manual button
                    voiceInputBtn.classList.add('recording');
                    voiceIndicator.classList.add('active');
                    setStatus("جاري الاستماع...", "", null);
                }
                // For smart chat, its own UI is already active
            };

            recognition.onresult = function(event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                userInput.value = transcript; 
                autoResizeTextarea();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error', event.error);
                let userMessage = "حدث خطأ في التعرف على الصوت: ";
                switch (event.error) {
                    case 'no-speech': userMessage += "لم يتم اكتشاف أي كلام. حاول التحدث بوضوح."; break;
                    case 'audio-capture': userMessage += "مشكلة في التقاط الصوت. تأكد أن الميكروفون يعمل."; break;
                    case 'not-allowed': userMessage += "لم يتم منح الإذن لاستخدام الميكروفون."; break;
                    case 'network': userMessage += "مشكلة في الشبكة. يتطلب التعرف على الصوت اتصالاً بالإنترنت."; break;
                    default: userMessage += event.error;
                }
                setStatus(userMessage, "error", 4000);
                
                if (isSmartChatActive) {
                    // Try to recover or offer to restart smart chat, or just stop it
                    // For now, let's stop it to prevent loops on persistent errors
                    stopSmartChat(); // This will also call stopListening() internally if needed.
                } else {
                    stopListening(); // Reset manual UI
                }
            };

            recognition.onend = defaultRecognitionOnEnd; 
        } else {
            voiceInputBtn.style.display = 'none'; 
            document.querySelector('.upload-options-container button[onclick="startSmartChat()"]').style.display = 'none'; 
            setStatus("المتصفح لا يدعم التعرف على الصوت", "error", 3000);
        }
    }
    
    // For the MANUAL voice input button
    function toggleListening() { 
        if (!recognition) {
            setStatus("ميزة التعرف على الصوت غير متاحة.", "error", 3000);
            return;
        }
        if (isSmartChatActive) { // If smart chat is on, this button should ideally be disabled or stop smart chat
            stopSmartChat(); // Pressing manual mic while smart chat is on will stop smart chat.
            return;
        }

        if (isListening) { // isListening here means manual listening
            recognition.stop();
        } else {
            try {
                userInput.value = ""; 
                autoResizeTextarea();
                recognition.start(); // This will trigger onstart, which updates manual UI
            } catch (e) {
                console.error("Error starting speech recognition (manual):", e);
                setStatus("لا يمكن بدء التعرف على الصوت.", "error", 3000);
                stopListening(); // Reset manual UI
            }
        }
    }
    
    // START Smart Chat Mode
    function startSmartChat() {
        uploadOptionsContainer.classList.remove('active'); 
        if (!recognition) {
            setStatus("ميزة التعرف على الصوت غير متاحة.", "error", 3000);
            return;
        }

        isSmartChatActive = true;
        userInput.value = ""; 
        autoResizeTextarea();

        speakingOverlay.style.display = 'block';
        speakingIndicatorCircle.style.display = 'flex';
        smartChatIcon.className = 'fas fa-microphone'; // Set icon to listening
        speakingIndicatorCircle.classList.add('speaking-animation'); // Start animation
        closeSmartChatBtn.style.display = 'block';

        if (isListening) { // If manual recognition was somehow active
            recognition.onend = () => { // One-time onend for this specific transition
                stopListening(); // Clean up manual UI if any
                if (isSmartChatActive) { // Check flag again
                    try { recognition.start(); } catch(e){ console.error("Error starting smart chat recog after stop:", e); stopSmartChat();}
                }
                recognition.onend = defaultRecognitionOnEnd; // Restore main handler
            };
            recognition.stop();
        } else {
            try { recognition.start(); } catch(e){ console.error("Error starting smart chat recog:", e); stopSmartChat(); }
        }
    }

    // STOP Smart Chat Mode
    function stopSmartChat() {
        isSmartChatActive = false;

        speakingOverlay.style.display = 'none';
        speakingIndicatorCircle.style.display = 'none';
        speakingIndicatorCircle.classList.remove('speaking-animation');
        closeSmartChatBtn.style.display = 'none';
        smartChatIcon.className = 'fas fa-microphone'; // Reset icon just in case

        if (isListening) { // isListening is general, could be smart chat's listening
            recognition.stop(); // This will call defaultRecognitionOnEnd
        }
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
        }
        // defaultRecognitionOnEnd will handle not restarting if isSmartChatActive is false.
    }
    
    // Resets UI for the MANUAL voice input button
    function stopListening() {
        isListening = false; // General listening flag off
        voiceInputBtn.classList.remove('recording');
        voiceIndicator.classList.remove('active');
        if (statusBar.textContent === "جاري الاستماع...") {
            setStatus("", "", 100); 
        }
    }

    function speakText(textToSpeak) {
        if (!('speechSynthesis' in window)) {
            console.warn("Text-to-speech not supported.");
            addMessage("bot", "عفواً، المتصفح الحالي لا يدعم نطق الردود صوتياً.", false, true);
            // If smart chat was active, we need to decide what to do. Maybe restart listening.
            if (isSmartChatActive) {
                setTimeout(() => { // Give a moment for the message to appear
                    if(isSmartChatActive) { // Check again
                        smartChatIcon.className = 'fas fa-microphone speaking-animation';
                        userInput.value = ""; autoResizeTextarea();
                        try { recognition.start(); } catch(e){ console.error("TTS not supported, error restarting recog:", e); stopSmartChat();}
                    }
                }, 100);
            }
            return;
        }

        if (speechSynthesis.speaking) { 
            speechSynthesis.cancel();
        }

        ttsUtterance = new SpeechSynthesisUtterance(textToSpeak);
        ttsUtterance.lang = 'ar-SA'; 
        const voices = speechSynthesis.getVoices();
        const arabicVoice = voices.find(voice => voice.lang === 'ar-SA' || voice.lang.startsWith('ar-'));
        if (arabicVoice) ttsUtterance.voice = arabicVoice;
        
        ttsUtterance.onstart = () => {
            console.log("TTS started.");
            speakingIndicatorCircle.classList.add('speaking-animation'); // Ensure animation is on
            smartChatIcon.className = 'fas fa-volume-up'; // Set icon to speaking
            // Overlay, indicator, and close button should already be visible if isSmartChatActive
        };

        ttsUtterance.onend = () => {
            console.log("TTS ended.");
            speakingIndicatorCircle.classList.remove('speaking-animation'); 

            if (isSmartChatActive) {
                smartChatIcon.className = 'fas fa-microphone speaking-animation'; 
                speakingIndicatorCircle.classList.add('speaking-animation');
                userInput.value = ""; 
                autoResizeTextarea();
                try { recognition.start(); } catch(e){ console.error("Error restarting recog after TTS:", e); stopSmartChat(); }
            } else {
                // Smart chat was stopped during TTS, or this TTS wasn't part of smart chat.
                // stopSmartChat() would have handled UI hiding.
            }
        };

        ttsUtterance.onerror = (event) => {
            console.error("Speech synthesis error:", event.error);
            speakingIndicatorCircle.classList.remove('speaking-animation');
            addMessage("bot", `عفواً, حدث خطأ أثناء محاولة نطق الرد: ${event.error}`, false, true);

            if (isSmartChatActive) {
                smartChatIcon.className = 'fas fa-microphone speaking-animation';
                speakingIndicatorCircle.classList.add('speaking-animation');
                userInput.value = ""; autoResizeTextarea();
                try { recognition.start(); } catch(e){ console.error("Error restarting recog after TTS error:", e); stopSmartChat();}
            }
        };
        speechSynthesis.speak(ttsUtterance);
    }
    if ('speechSynthesis' in window && speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => console.log("Speech synthesis voices updated.");
    }


    function initializeApp() {
        const storedAdCount = localStorage.getItem(localStorageKeyAdCounter);
        if (storedAdCount) successfulResponseCount = parseInt(storedAdCount, 10) || 0;

        loadAllMessagesAndSetCurrent(); 

        const storedSubject = localStorage.getItem(localStorageKeyCurrentSubject);
        currentSubject = (storedSubject && (subjects.includes(storedSubject) || storedSubject === "general")) ? storedSubject : "general";
        
        if (!allMessages[currentSubject]) allMessages[currentSubject] = [];
        messages = allMessages[currentSubject];

        updateSubjectUI(); 
        botNameElement.textContent = getBotDisplayName(); 

        addWelcomeMessage(); 
        refreshChat();
        autoResizeTextarea();

        toggleUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uploadOptionsContainer.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!uploadOptionsContainer.contains(e.target) && !toggleUploadBtn.contains(e.target) &&
                !subjectModal.contains(e.target) && e.target !== enterSubjectsBtn) { 
                uploadOptionsContainer.classList.remove('active');
            }
        });

        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);
        scrollToTopBtn.addEventListener('click', () => chatContainer.scrollTo({ top: 0, behavior: 'smooth' }));
        scrollToBottomBtn.addEventListener('click', () => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }));

        chatContainer.addEventListener('scroll', () => {
            const scrollTop = chatContainer.scrollTop;
            const scrollHeight = chatContainer.scrollHeight;
            const clientHeight = chatContainer.clientHeight;
            const scrollThreshold = 150; 
            scrollToTopBtn.classList.toggle('visible', scrollTop > scrollThreshold);
            scrollToBottomBtn.classList.toggle('visible', scrollHeight > clientHeight && scrollHeight - scrollTop - clientHeight > scrollThreshold);
        });
        chatContainer.dispatchEvent(new Event('scroll')); 

        enterSubjectsBtn.addEventListener('click', openSubjectModal);
        generalChatBtn.addEventListener('click', switchToGeneralMode);
        populateSubjectList();
        
        initSpeechRecognition();
        voiceInputBtn.addEventListener('click', toggleListening); 
        closeSmartChatBtn.addEventListener('click', stopSmartChat);
    }

    function getBotDisplayName() {
        return (currentSubject === "general") ? botName : `${botName} (${currentSubject})`;
    }
    
    function updateSubjectUI() {
        botNameElement.textContent = getBotDisplayName();
        generalChatBtn.style.display = (currentSubject === "general") ? 'none' : 'inline-block';
        enterSubjectsBtn.textContent = (currentSubject === "general") ? "مواد متخصصة" : `مادة: ${currentSubject}`;
        localStorage.setItem(localStorageKeyCurrentSubject, currentSubject);
    }

    function openSubjectModal() { subjectModal.style.display = "flex"; }
    function closeSubjectModal() { subjectModal.style.display = "none"; }

    function populateSubjectList() {
        subjectListContainer.innerHTML = '';
        subjects.forEach(subject => {
            const btn = document.createElement('button');
            btn.textContent = subject;
            btn.onclick = () => selectSubject(subject);
            subjectListContainer.appendChild(btn);
        });
    }

    function selectSubject(subject) {
        if (currentSubject === subject) { closeSubjectModal(); return; }
        allMessages[currentSubject] = messages; 
        currentSubject = subject;
        messages = allMessages[currentSubject] || []; 
        if (!allMessages[currentSubject]) allMessages[currentSubject] = []; 
        updateSubjectUI();
        closeSubjectModal();
        addWelcomeMessage(); 
        refreshChat(); 
        setStatus(`تم التحويل إلى وضع مادة: ${currentSubject}`, "success", 3000);
        saveAllMessagesToLocalStorage(); 
    }

    function switchToGeneralMode() {
        if (currentSubject === "general") return; 
        allMessages[currentSubject] = messages; 
        currentSubject = "general";
        messages = allMessages[currentSubject] || [];
        if (!allMessages[currentSubject]) allMessages[currentSubject] = [];
        updateSubjectUI();
        addWelcomeMessage(); 
        refreshChat(); 
        setStatus("تم الرجوع إلى الوضع العام", "success", 3000);
        saveAllMessagesToLocalStorage();
    }

    function loadAllMessagesAndSetCurrent() {
        const storedAllMessages = localStorage.getItem(localStorageKeyAllChats);
        if (storedAllMessages) {
            try {
                const parsed = JSON.parse(storedAllMessages);
                if (typeof parsed === 'object' && parsed !== null) {
                    allMessages = parsed;
                    for (const subjectKey in allMessages) {
                        if (Object.hasOwnProperty.call(allMessages, subjectKey) && Array.isArray(allMessages[subjectKey])) {
                            allMessages[subjectKey] = allMessages[subjectKey].map(msg => ({ ...msg, timestamp: new Date(msg.timestamp) }));
                        } else { allMessages[subjectKey] = []; }
                    }
                } else { allMessages = {}; }
            } catch (e) {
                console.error("خطأ في تحليل الرسائل من التخزين:", e);
                allMessages = {}; 
                localStorage.removeItem(localStorageKeyAllChats); 
            }
        } else { allMessages = {}; }
        if (!allMessages["general"] || !Array.isArray(allMessages["general"])) allMessages["general"] = [];
    }

    function saveAllMessagesToLocalStorage() {
        if (currentSubject && messages) allMessages[currentSubject] = messages;
        localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allMessages));
    }

    function addWelcomeMessage() {
        let welcomeMsgText = `مرحباً بك! أنا ${getBotDisplayName()}، كيف يمكنني مساعدتك اليوم؟ 💡 يمكنك رفع صورتين يوميًا وسأحاول استخلاص النص منها وإرساله للتحليل. يمكنك أيضاً تجربة "الدردشة الذكية" من قائمة "+" للتحدث معي صوتياً.`;
        if (currentSubject !== "general") {
             welcomeMsgText = `مرحباً! أنا ${getBotDisplayName()}. حاليًا في وضع الإجابة عن أسئلة مادة ${currentSubject} بناءً على المنهج الدراسي. كيف يمكنني مساعدتك ضمن هذا الإطار؟ يمكنك أيضاً تجربة "الدردشة الذكية" من قائمة "+" للتحدث معي صوتياً.`;
        }
        const welcomeExists = messages.some(m => m.isInitialWelcome && m.sender === "bot");
        if (!welcomeExists) {
            messages = messages.filter(m => !m.isInitialWelcome); 
            const welcomeMessageObject = { sender: "bot", text: welcomeMsgText, isImage: false, isSystemMessage: true, timestamp: new Date(), isInitialWelcome: true };
            messages.unshift(welcomeMessageObject); 
            allMessages[currentSubject] = messages; 
            saveAllMessagesToLocalStorage(); 
        } else {
            const welcomeIndex = messages.findIndex(m => m.isInitialWelcome && m.sender === "bot");
            if (welcomeIndex !== -1 && messages[welcomeIndex].text !== welcomeMsgText) {
                messages[welcomeIndex].text = welcomeMsgText;
                allMessages[currentSubject] = messages;
                saveAllMessagesToLocalStorage();
            }
        }
    }

    function addMessage(sender, text, isImage = false, isSystemMessage = false, isInitialWelcome = false) {
      const message = { sender, text, isImage, isSystemMessage, timestamp: new Date(), isInitialWelcome };
      messages.push(message);
      allMessages[currentSubject] = messages; 
      const wasNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 150;
      refreshChat(); 
      if (sender === 'user') chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      else if (isInitialWelcome && messages.length <= 2) chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      else if (wasNearBottom && !isImage) chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function linkifyAndFormatText(text) {
      if (typeof text !== 'string') return '';
      const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      const linkedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return linkedText.replace(/\n/g, '<br>');
    }

    function refreshChat() {
      chatContainer.innerHTML = ""; 
      messages.forEach((msg, index) => {
        const messageElem = document.createElement("div");
        messageElem.classList.add("message", msg.sender);
        const header = document.createElement("div");
        header.classList.add("message-header");
        let senderName = msg.sender === "bot" ? getBotDisplayName() : "أنت";
        if (msg.sender === "bot" && msg.isSystemMessage && !msg.isInitialWelcome) senderName = `${getBotDisplayName()} (نظام)`;
        header.innerHTML = `<span>${senderName}</span>`;
        const deleteBtn = document.createElement("i");
        deleteBtn.className = "fas fa-trash delete-btn";
        deleteBtn.title = "حذف الرسالة";
        deleteBtn.onclick = () => deleteMessage(index); 
        header.appendChild(deleteBtn);
        messageElem.appendChild(header);
        const bubble = document.createElement("div");
        bubble.classList.add("bubble");
        if(msg.isImage) {
          const img = document.createElement("img");
          img.src = msg.text;
          img.style.cssText = "max-width:100%; max-height:300px; border-radius:var(--border-radius-sm);";
          img.alt = "صورة مرسلة";
          img.onload = () => {
              if (index === messages.length - 1 || chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 350) {
                  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
              }
          }
          img.onerror = () => { bubble.textContent = "فشل تحميل الصورة"; }
          bubble.appendChild(img);
        } else {
          const originalText = msg.text;
          const charLimit = 250; 
          if (msg.sender === "bot" && !msg.isSystemMessage && !msg.isInitialWelcome && originalText.length > charLimit) {
            const shortText = originalText.substring(0, charLimit) + "...";
            const contentDiv = document.createElement('div');
            const textSpan = document.createElement('span');
            textSpan.innerHTML = linkifyAndFormatText(shortText);
            contentDiv.appendChild(textSpan);
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = "المزيد"; toggleBtn.className = "toggle-details-btn";
            toggleBtn.onclick = function() {
              const isExp = this.dataset.expanded === "true";
              textSpan.innerHTML = linkifyAndFormatText(isExp ? shortText : originalText);
              this.textContent = isExp ? "المزيد" : "أقل";
              this.dataset.expanded = !isExp;
            };
            contentDiv.appendChild(toggleBtn);
            bubble.appendChild(contentDiv);
          } else bubble.innerHTML = linkifyAndFormatText(originalText);
        }
        messageElem.appendChild(bubble);
        if(msg.sender === "bot" && !msg.isImage && !msg.isSystemMessage && !msg.isInitialWelcome) {
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "message-actions";
          const likeBtn = document.createElement("button"); likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i>'; likeBtn.title="إعجاب";
          likeBtn.onclick = (e) => e.currentTarget.classList.toggle("liked");
          const copyBtn = document.createElement("button"); copyBtn.innerHTML = '<i class="fas fa-copy"></i>'; copyBtn.title="نسخ";
          copyBtn.onclick = () => navigator.clipboard.writeText(msg.text).then(() => setStatus("تم النسخ 👍", "success", 1500)).catch(err => setStatus("فشل النسخ", "error", 2000));
          if (index > 0 && messages[index - 1]?.sender === 'user') {
            const retryBtn = document.createElement("button"); retryBtn.innerHTML = '<i class="fas fa-redo"></i>'; retryBtn.title="إعادة"; retryBtn.className="retry-btn";
            retryBtn.onclick = () => retryQuery(index); 
            actionsDiv.appendChild(retryBtn);
          }
          actionsDiv.appendChild(likeBtn); actionsDiv.appendChild(copyBtn);
          messageElem.appendChild(actionsDiv);
        }
        chatContainer.appendChild(messageElem);
      });
      saveAllMessagesToLocalStorage(); 
      autoResizeTextarea(); 
      chatContainer.dispatchEvent(new Event('scroll')); 
    }

    async function retryQuery(botMessageIndex) {
        if (botMessageIndex > 0 && messages[botMessageIndex - 1]?.sender === 'user') {
            const userQuery = messages[botMessageIndex - 1].text;
            if (userQuery) {
                setStatus(`إعادة: "${userQuery.substring(0, 30)}..."`, "", null);
                await processQueryWithAI(userQuery);
            } else setStatus("لم يتم العثور على السؤال الأصلي.", "error", 2000);
        } else setStatus("خطأ: تعذر تحديد السؤال الأصلي.", "error", 3000);
    }

    function deleteMessage(index) {
      const isWelcome = messages[index].isInitialWelcome;
      messages.splice(index, 1); 
      allMessages[currentSubject] = messages; 
      if (isWelcome && !messages.some(m => m.sender === 'bot' && m.isInitialWelcome)) addWelcomeMessage(); 
      refreshChat(); 
      setStatus("تم حذف الرسالة.", "success", 1500);
    }

    function deleteAllMessages() {
      const nonWelcomeMsgs = messages.filter(m => !m.isInitialWelcome);
      if (nonWelcomeMsgs.length === 0) { setStatus("لا يوجد رسائل لحذفها.", "", 1500); return; }
      if (confirm("هل أنت متأكد أنك تريد حذف كل الرسائل في هذه الدردشة؟")) {
        messages = messages.filter(m => m.isInitialWelcome); 
        allMessages[currentSubject] = messages; 
        if (messages.length === 0 || !messages.some(m => m.isInitialWelcome)) addWelcomeMessage();
        else addWelcomeMessage(); // Refreshes existing welcome message text if needed
        refreshChat(); 
        setStatus("تم حذف كل الرسائل.", "success", 2000);
      }
    }
    
    function setStatus(message, type = "", duration = 3000) {
      clearTimeout(statusTimeout);
      statusBar.textContent = message;
      statusBar.className = "status " + type; 
      if (message && duration !== null) {
        statusTimeout = setTimeout(() => { statusBar.textContent = ""; statusBar.className = "status"; }, duration);
      } else if (!message) { statusBar.textContent = ""; statusBar.className = "status"; }
    }

    function triggerImageUpload() { uploadOptionsContainer.classList.remove('active'); imageUploadInput.click(); }

    function handleFileSelect(event) {
        if (event.target.type === 'file' && event.target.files?.[0]) {
            processAndUploadImageFile(event.target.files[0]);
            event.target.value = ""; 
        }
    }
    
    async function processAndUploadImageFile(file) {
        if (!checkImageUploadLimit()) return;
        setTimeout(() => window.open(AD_URL, '_blank'), AD_DELAY_MS); 
        if (file.size > 5 * 1024 * 1024) { setStatus("حجم الصورة كبير (الحد 5 ميجا).", "error", 3000); return; }
        const reader = new FileReader();
        reader.onload = (e) => { addMessage("user", e.target.result, true); extractTextFromImageAndProcess(file); }
        reader.readAsDataURL(file);
        incrementImageUploadCount();
    }

    function checkImageUploadLimit() {
        const today = new Date().toISOString().split('T')[0];
        const lastUpload = localStorage.getItem(localStorageKeyImageUploadDate);
        let count = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        if (lastUpload === today) {
            if (count >= 2) {
                setStatus("تعديت حد الصور اليومي (2).", "error", 4000);
                addMessage("bot", "عفواً، استنفدت حصة رفع الصور اليومية (2). حاول غداً.", false, true);
                return false;
            }
        } else { localStorage.setItem(localStorageKeyImageUploadDate, today); localStorage.setItem(localStorageKeyImageUploadCount, "0"); count = 0; }
        return true;
    }

    function incrementImageUploadCount() {
        localStorage.setItem(localStorageKeyImageUploadDate, new Date().toISOString().split('T')[0]);
        localStorage.setItem(localStorageKeyImageUploadCount, (parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0") + 1).toString());
    }

    async function extractTextFromImageAndProcess(file) {
        if (!ocrApiKey) { 
             addMessage("bot", "ميزة OCR غير مفعلة (مفتاح مفقود).", false, true);
             setStatus("مفتاح OCR غير مكوّن.", "error", 5000); return;
        }
        setStatus(`جاري معالجة الصورة واستخلاص النص...`, "", null); 
        const formData = new FormData();
        formData.append('apikey', ocrApiKey); formData.append('language', 'ara'); formData.append('file', file);
        try {
            const ocrRes = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
            if (!ocrRes.ok) throw new Error(`فشل OCR: ${ (await ocrRes.json().catch(()=>({}))).ErrorMessage || ocrRes.statusText }`);
            const ocrData = await ocrRes.json();
            if (ocrData.IsErroredOnProcessing) throw new Error(`خطأ في معالجة OCR: ${ocrData.ErrorMessage.join(', ')}`);
            const extracted = ocrData.ParsedResults?.[0]?.ParsedText.trim();
            if (extracted) {
                addMessage("bot", `النص المستخلص:\n"${extracted}"`, false, true); 
                setStatus("تم استخلاص النص، جاري التحليل...", "success", 2500);
                await processQueryWithAI(extracted); 
            } else {
                addMessage("bot", "لم يتم العثور على نص واضح في الصورة.", false, true);
                setStatus("لم يتم استخلاص نص.", "error", 3000);
            }
        } catch (error) {
            addMessage("bot", `خطأ استخلاص النص: ${error.message}`, false, true);
            setStatus("فشل استخلاص النص.", "error", 4000);
        }
    }
    
    function generateChatPrompt(userMessage) {
      const maxHistory = 8; 
      let history = "";
      const textMsgs = messages.filter(m => !m.isImage && !(m.sender === 'bot' && m.isSystemMessage && !m.isInitialWelcome && !m.text.includes("وضع مادة") && !m.text.includes("الوضع العام")));
      const botDisplayName = getBotDisplayName();
      let systemPrompt = `أنت ${botDisplayName}، مساعد ذكاء اصطناعي ودود، صادق، إيجابي، وذكي. هدفك مساعدة المستخدم والإجابة بوضوح وتفاعل. تجنب الردود المقتضبة. إذا لم تعرف، اعترف بلطف. استخدم رموز تعبيرية باعتدال. إذا سُئلت "من صنعك" أو ما شابه، قل "أنا من صنع وتطوير سيف هاني".\n\n`;
      if (currentSubject && currentSubject !== "general") {
          systemPrompt = `أنت الآن خبير مادة "${currentSubject}". إجاباتك يجب أن تستند حصريًا إلى منهج "${currentSubject}" المصري. لا تقدم معلومات خارجه. إذا كان السؤال خارج النطاق، وضح ذلك. لقد أُعلم المستخدم أن "الإجابات من المنهج فقط". ابدأ ردود المادة بتأكيد أنك تجيب ضمن نطاقها.\n\n` + systemPrompt;
      }
      const startIdx = Math.max(0, textMsgs.length - maxHistory);
      for (let i = startIdx; i < textMsgs.length; i++) {
        const msg = textMsgs[i];
        if (msg.sender === "bot" && msg.isInitialWelcome && msg.text.includes("كيف يمكنني مساعدتك اليوم؟")) continue;
        history += (msg.sender === "user" ? "المستخدم: " : (botDisplayName + (msg.isSystemMessage && !msg.isInitialWelcome ? " (نظام)" : "") +": ")) + msg.text + "\n";
      }
      return `${systemPrompt}${history}المستخدم: ${userMessage}\n${botDisplayName}:`;
    }

    async function fetchGeminiResponse(prompt) {
      if (!geminiApiKey) throw new Error("عفواً، خدمة AI غير مكوّنة (مفتاح Gemini مفقود).");
      const body = { contents: [{ parts: [{ text: prompt }] }] };
      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, 
                                { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
        if(!res.ok) {
          const errData = await res.json().catch(() => null); 
          let errMsg = `خطأ ${res.status}: ${res.statusText}.`;
          if (res.statusText?.toLowerCase().includes("failed to fetch")) throw new Error("Failed to fetch"); 
          if (errData?.error?.message) {
             if (errData.error.message.toLowerCase().includes("api key") || errData.error.message.toLowerCase().includes("permission")) errMsg += " خطأ في إعدادات الطلب أو صلاحيات المفتاح.";
             else errMsg += ` تفاصيل: ${errData.error.message.substring(0, 200)}`;
          }
          throw new Error(errMsg);
        }
        const data = await res.json();
        if (data.candidates?.[0]?.content?.parts?.[0]?.text) return data.candidates[0].content.parts[0].text;
        if (data.promptFeedback?.blockReason) return `لم أتمكن من معالجة طلبك (السبب: ${data.promptFeedback.blockReason}). حاول تعديل سؤالك.`;
        if (data.candidates?.[0]?.finishReason) {
            let botMsg = (data.candidates[0].content?.parts?.[0]?.text || ""); 
            const reason = data.candidates[0].finishReason;
            if (reason === "SAFETY") return botMsg + (botMsg ? "\n\n" : "") + "لم أتمكن من إكمال الرد بسبب قيود السلامة. حاول تعديل سؤالك.";
            if (reason === "MAX_TOKENS") return botMsg + (botMsg ? "\n\n" : "") + "(تم اختصار الرد لتجاوز الحد الأقصى)";
            return botMsg + (botMsg ? "\n\n" : "") + `لم يتم استلام رد مكتمل (السبب: ${reason}).`;
        }
        return "لم يتم استلام رد صحيح. قد يكون غير كامل أو هناك مشكلة.";
      } catch (error) {
          if (error.message?.toLowerCase().includes("api key") || (geminiApiKey && error.message?.toLowerCase().includes(geminiApiKey.toLowerCase()))) {
              throw new Error("خطأ أثناء الاتصال بخادم Gemini. راجع وحدة التحكم.");
          }
          throw error; 
      }
    }

    async function processQueryWithAI(queryText) {
        if (!queryText?.trim()) return;
        searchLog.textContent = `آخر استعلام: ${queryText.substring(0, 60)}${queryText.length > 60 ? '...' : ''}`;
        setStatus(`${getBotDisplayName()} يفكر: "${queryText.substring(0,30)}..."`, "", null); 
        try {
            const prompt = generateChatPrompt(queryText);
            const responseText = await fetchGeminiResponse(prompt);
            addMessage("bot", responseText);
            if (isSmartChatActive || (!responseText.toLowerCase().includes("مفتاح gemini مفقود") && !responseText.toLowerCase().includes("خدمة الذكاء الاصطناعي غير مكوّنة"))) {
               speakText(responseText); 
            }
            setStatus("تم استلام الرد! ✅", "success"); 
            successfulResponseCount++;
            localStorage.setItem(localStorageKeyAdCounter, successfulResponseCount.toString());
        } catch (error) {
            let displayErr;
            if (error.message?.toLowerCase().includes("failed to fetch")) displayErr = "فشل الاتصال بالخادم. تحقق من اتصالك بالإنترنت.";
            else if (error.message?.includes("عفواً، خدمة AI غير مكوّنة")) displayErr = error.message; 
            else {
                displayErr = "عفواً، واجهت مشكلة مع Gemini. 😥";
                if (error.message && !error.message.includes("خطأ أثناء الاتصال بخادم Gemini") && !error.message.toLowerCase().includes("api key")) displayErr += " تفاصيل: " + error.message.substring(0,100); 
                else if (error.message?.includes("خطأ أثناء الاتصال بخادم Gemini")) displayErr = "عفواً، مشكلة في الاتصال بخدمة Gemini.";
            }
            addMessage("bot", displayErr, false, true); 
            if (isSmartChatActive && !displayErr.includes("غير مكوّنة")) speakText(displayErr); // Speak error in smart chat unless it's a config issue
            setStatus("فشل الحصول على رد. ❌", "error"); 
        }
    }

    async function sendMessage() {
      const msgText = userInput.value.trim();
      if (!msgText) return;
      addMessage("user", msgText);
      userInput.value = ""; autoResizeTextarea(); 
      userMessageCounterForAds++;
      if (userMessageCounterForAds % 4 === 0) setTimeout(() => window.open(AD_URL, '_blank'), 500); 
      await processQueryWithAI(msgText);
    }

    userInput.addEventListener("keydown", (e) => { if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
    userInput.addEventListener("input", autoResizeTextarea); 
    
    function autoResizeTextarea() {
        userInput.style.height = 'auto'; 
        let newH = userInput.scrollHeight;
        const maxH = parseInt(getComputedStyle(userInput).maxHeight) || 120; 
        userInput.style.overflowY = (newH > maxH) ? (newH = maxH, 'auto') : 'hidden';
        userInput.style.height = newH + 'px';
    }
    
    async function openCamera() {
        uploadOptionsContainer.classList.remove('active'); 
        if (!checkImageUploadLimit()) return;
        if (navigator.mediaDevices?.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                cameraView.srcObject = cameraStream;
                cameraModal.style.display = "flex"; 
            } catch (err) {
                setStatus("لا يمكن الوصول للكاميرا. تأكد من الأذونات.", "error", 4000);
                addMessage("bot", "عفواً، لم أتمكن من الوصول للكاميرا. تحقق من أذونات المتصفح.", false, true);
            }
        } else {
            setStatus("متصفحك لا يدعم الكاميرا.", "error", 4000);
            addMessage("bot","عفواً، متصفحك لا يدعم ميزة الكاميرا.", false, true);
        }
    }

    function closeCamera() {
        if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); 
        cameraView.srcObject = null; 
        cameraModal.style.display = "none"; 
    }

    async function captureImageFromCamera() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraView.videoWidth; canvas.height = cameraView.videoHeight;
        canvas.getContext('2d').drawImage(cameraView, 0, 0, canvas.width, canvas.height);
        closeCamera(); 
        canvas.toBlob(async (blob) => {
            if (blob) await processAndUploadImageFile(new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' }));
            else { setStatus("فشل التقاط الصورة.", "error", 3000); addMessage("bot", "خطأ أثناء التقاط الصورة.", false, true); }
        }, 'image/jpeg', 0.9); 
    }

    initializeApp();
  </script>

</body>
</html>
