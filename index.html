<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- PWA: Link to Manifest File -->
  <link rel="manifest" href="manifest.json">
  <!-- PWA: Theme color for browser UI -->
  <meta name="theme-color" content="#000000" />
  <!-- PWA: Favicon for the site -->
  <link rel="icon" href="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" type="image/png">


  <!-- Social Share Meta Tags -->
  <title>Saif AI - دردشة ذكاء اصطناعي</title>
  <meta property="og:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta property="og:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta property="og:image" content="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" />
  <meta property="og:url" content="https://tinyurl.com/saif-ai" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta name="twitter:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta name="twitter:image" content="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" />

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      /* --- NEW: Monochrome Color Scheme inspired by ChatGPT --- */
      --primary-color: #E0E0E0; /* Light grey for accents */
      --primary-hover-color: #FFFFFF; /* Pure white for hover */
      --primary-glow-color: rgba(224, 224, 224, 0.2); /* Adjusted glow for grey */
      --secondary-color: #BDBDBD; /* Another grey for variation */
      
      /* Pure Black Theme */
      --bg-main: #000000;
      --bg-surface: #101010;
      --bg-surface-raised: #1c1c1c;
      --bg-input: #1c1c1c;

      --text-primary: #f0f4f8;
      --text-secondary: #a0a8b2;
      --text-on-primary: #000000; /* Text on top of the light grey accent */
      
      --border-color: #2a2a2a;
      --border-color-light: #404040;
      
      --success-color: #4ce083;
      --error-color: #ff5c5c;
      
      --shadow-xs: 0 1px 3px rgba(0,0,0,0.5);
      --shadow-sm: 0 4px 6px rgba(0,0,0,0.6);
      --shadow-md: 0 6px 12px rgba(0,0,0,0.7);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.8);
      
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;

      --header-height: 52px;
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--secondary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar { width: 6px; height: 6px; }
    *::-webkit-scrollbar-track { background: var(--bg-surface); border-radius: 3px; }
    *::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 3px; }

    html, body {
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
    }

    body {
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
    }

    .container {
      width: 100%;
      height: 100%; 
      background: var(--bg-main); 
      border: 1px solid var(--border-color); 
      border-radius: 0;
      display: flex;
      flex-direction: column; 
      overflow: hidden; 
      position: relative; 
      box-shadow: var(--shadow-lg);
    }
    
    .download-notification {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-surface-raised);
      color: var(--text-primary);
      text-align: center;
      font-weight: 500;
      z-index: 100;
      box-shadow: var(--shadow-md);
      border-bottom: 1px solid var(--border-color);
      overflow: hidden;
      max-height: 0;
      padding: 0 15px;
      transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
    }
    .download-notification.show { max-height: 80px; padding: 10px 15px; }
    .notification-buttons { display: flex; align-items: center; gap: 10px; margin-right: auto; padding-right: 15px; }
    .download-btn { background-color: var(--primary-color); color: var(--text-on-primary); border: none; padding: 6px 14px; border-radius: var(--border-radius-md); cursor: pointer; font-weight: 700; transition: all 0.25s ease; }
    .download-btn:hover { background-color: var(--primary-hover-color); transform: scale(1.05); }
    .close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.8rem; cursor: pointer; padding: 0 5px; line-height: 1; opacity: 0.8; transition: all 0.25s ease; }
    .close-btn:hover { opacity: 1; transform: rotate(90deg) scale(1.1); }

    .header { 
      background: transparent;
      padding: 0.4rem 0.8rem; 
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0; 
      z-index: 10; 
      height: var(--header-height);
      direction: rtl; /* Always RTL */
      position: absolute; /* Floating Header */
      top: 0;
      left: 0;
      right: 0;
    }

    .header-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* --- NEW/MODIFIED --- */
    .header .header-icon {
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: 1.2rem; 
      z-index: 11; 
      padding: 5px;
    }
    .delete-all-btn:hover { color: var(--error-color); transform: rotate(10deg) scale(1.1); }
    .share-btn-header:hover { color: var(--success-color); transform: scale(1.15); }
    .history-btn:hover { color: var(--primary-hover-color); transform: scale(1.15); }
    
    .header .fas.fa-robot { 
      font-size: 1.2rem; 
      color: var(--primary-color);
      background: rgba(224, 224, 224, 0.1);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .header h1 { 
      font-size: 1.05rem; 
      font-weight: 700;
      color: var(--primary-color); 
      white-space: nowrap;
    }

    .header-btn { 
        background-color: var(--bg-surface-raised); 
        color: var(--text-primary);
        border: 1px solid var(--border-color-light);
        padding: 0.4rem 0.7rem; 
        border-radius: var(--border-radius-md); 
        cursor: pointer;
        font-size: 0.75rem; 
        font-weight: 500;
        transition: all 0.25s ease;
        box-shadow: var(--shadow-xs);
    }
    .header-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-color);
        transform: translateY(-1px); 
        box-shadow: var(--shadow-sm), 0 0 8px var(--primary-glow-color);
    }
    
    #languageSelector { position: relative; }
    #languageBtn {
      padding: 0.4rem;
      width: 34px;
      height: 34px;
      font-size: 1.1rem;
    }
    #languageDropdown {
        display: none;
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        background-color: var(--bg-surface-raised);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        z-index: 100;
        min-width: 150px;
        overflow: hidden;
    }
    #languageDropdown button {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background: none;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        font-size: 0.9rem;
        text-align: right;
    }
    #languageDropdown button:hover { background-color: var(--primary-color); color: var(--text-on-primary); }


    .chat-wrapper { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden; 
        min-height: 0;
        padding-top: var(--header-height); /* Space for floating header */
    }
    
    #subjectsViewContainer { background-color: var(--bg-main); padding: 1.5rem; display: none; align-items: center; }
    .subjects-view-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
    .subjects-view-header h2 { font-size: 1.6rem; color: var(--primary-color); }
    .back-to-chat-btn { background-color: var(--bg-surface-raised); color: var(--text-primary); border: 1px solid var(--border-color-light); padding: 0.7rem 1.2rem; border-radius: var(--border-radius-md); cursor: pointer; font-size: 0.9rem; transition: all 0.25s ease; box-shadow: var(--shadow-xs); display: flex; align-items: center; gap: 0.5rem; }
    .back-to-chat-btn:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); transform: translateY(-2px); box-shadow: var(--shadow-sm), 0 0 10px var(--primary-glow-color); }
    #subjectListContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 700px; overflow-y: auto; padding: 10px; }
    .subject-item-btn { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); padding: 18px 22px; font-size: 1rem; min-width: 180px; border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.3s ease; text-align: center; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .subject-item-btn:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-hover-color); transform: translateY(-4px) scale(1.03); box-shadow: var(--shadow-md), 0 0 15px var(--primary-glow-color); }
    .subject-item-btn i { font-size: 2.2rem; margin-bottom: 5px; color: var(--secondary-color); transition: color 0.3s ease; }
    .subject-item-btn:hover i { color: var(--text-on-primary); }

    .chat-container { flex: 1; padding: 1.5rem 1rem; overflow-y: auto; background: var(--bg-main); scroll-behavior: smooth; min-height: 0; }
    .message { max-width: 85%; margin-bottom: 2rem; display: flex; flex-direction: column; animation: messageAppear 0.4s ease-out; word-wrap: break-word; white-space: pre-wrap; line-height: 1.7; }
    @keyframes messageAppear { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .message-content { padding: 0.2rem 0.5rem; }
    .message-header { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .delete-btn { color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; transition: color 0.2s, transform 0.2s; opacity: 0.4; padding: 3px 5px; }
    .message:hover .delete-btn { opacity: 0.8; }
    .delete-btn:hover { opacity: 1; color: var(--error-color); transform: scale(1.15); }
    .message.user { margin-left: auto; align-items: flex-end; }
    .message.user .message-header { flex-direction: row-reverse; }
    .message.bot { margin-right: auto; align-items: flex-start; }
    
    html[dir="ltr"] .message.user { margin-right: auto; margin-left: 0; align-items: flex-end; }
    html[dir="ltr"] .message.bot { margin-left: auto; margin-right: 0; align-items: flex-start; }
    
    .message.user .message-content { color: #e5e7eb; /* NEW: Brighter off-white for user text */ }
    .message.bot .message-content { color: var(--text-primary); }
    .message.bot .message-content strong { color: var(--primary-color); }
    .message-actions { margin-top: 10px; display: flex; gap: 8px; padding: 0 8px; flex-wrap: wrap; }
    .message.user .message-actions { justify-content: flex-end; }
    .message-actions button { background: var(--bg-surface-raised); border: 1px solid var(--border-color); cursor: pointer; font-size: 0.85rem; padding: 5px 9px; color: var(--text-secondary); transition: all 0.25s ease; border-radius: var(--border-radius-sm); display: flex; align-items: center; gap: 5px; }
    .message-actions button:hover { color: var(--text-on-primary); background-color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 0 10px var(--primary-glow-color); }
    
    .chat-input-area { 
        flex-shrink: 0; 
        background: transparent; 
        position: relative; 
        padding: 0.8rem 1rem;
    }
    .chat-input-area::before { 
        content: ''; 
        position: absolute; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        height: 150px; 
        background: linear-gradient(to top, var(--bg-main) 20%, transparent 100%); 
        pointer-events: none; 
        z-index: 4; 
    }
    .chat-input-wrapper {
        position: relative;
        z-index: 5;
        max-width: 800px;
        margin: 0 auto;
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-xl);
        transition: border-color 0.25s ease, box-shadow 0.25s ease;
        display: flex;
        align-items: flex-end; /* Align buttons at the bottom */
    }
    .chat-input-wrapper:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
    }
    .chat-input-wrapper textarea { 
        flex: 1; 
        padding: 0.8rem 48px; /* Room for buttons on both sides */
        border: none;
        resize: none; 
        font-size: 0.95rem; 
        outline: none; 
        background: transparent; 
        color: var(--text-primary); 
        max-height: 150px; 
        line-height: 1.6; 
    }
    .chat-input-wrapper textarea::placeholder { color: var(--text-secondary); opacity: 0.6; }

    .chat-input-btn { 
        background: transparent; 
        border: none; 
        color: var(--text-secondary); 
        width: 44px; 
        height: 44px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        font-size: 1.1rem; 
        transition: all 0.25s ease; 
        flex-shrink: 0;
        position: absolute;
        bottom: 0px;
    }
    .chat-input-btn:hover { color: var(--text-primary); transform: scale(1.1); }
    
    #toggleUploadBtn { right: 0; }
    html[dir="ltr"] #toggleUploadBtn { left: 0; right: auto; }
    
    #sendOrVoiceBtn { left: 0; }
    html[dir="ltr"] #sendOrVoiceBtn { right: 0; left: auto; }
    #sendOrVoiceBtn:hover { color: var(--primary-hover-color); }
    
    #speakBtn {
        position: absolute;
        bottom: 0px;
        left: 48px;
        display: none; /* Hidden by default */
    }
    html[dir="ltr"] #speakBtn { right: 48px; left: auto; }

    .voice-indicator { display: none; align-items: center; justify-content: center; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: var(--bg-surface-raised); color: var(--text-primary); padding: 8px 16px; border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); gap: 8px; z-index: 10; opacity: 0; transition: opacity 0.3s ease; }
    .voice-indicator.active { display: flex; opacity: 1; }
    .voice-indicator i { color: var(--error-color); animation: pulseMic 1.5s infinite ease-in-out; }
    @keyframes pulseMic { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    .chat-input-btn.recording { color: var(--error-color); }
    
    #uploadOptionsContainer { display: flex; flex-direction: column; gap: 8px; background-color: var(--bg-surface-raised); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 10px; position: absolute; bottom: calc(100% + 5px); right: 5px; z-index: 10; box-shadow: var(--shadow-md); opacity: 0; visibility: hidden; transform: translateY(10px) scale(0.95); transition: all 0.25s ease-out; }
    html[dir="ltr"] #uploadOptionsContainer { left: 5px; right: auto; }
    #uploadOptionsContainer.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
    #uploadOptionsContainer button { background: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border-color-light); border-radius: var(--border-radius-sm); padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: all 0.2s ease; text-align: right; width: 100%; white-space: nowrap; }
    html[dir="ltr"] #uploadOptionsContainer button { text-align: left; }
    #uploadOptionsContainer button:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); }
    
    .status { text-align: center; padding: 0.4rem; font-size: 0.8rem; background-color: var(--bg-surface); color: var(--text-secondary); border-top: 1px solid var(--border-color); transition: color 0.3s ease; font-weight: 500; }
    
    /* Suggestions Feature */
    #suggestionsContainer {
        display: none; /* Hidden by default */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        padding: 0 1rem 1rem;
        max-width: 800px;
        margin: auto;
    }
    .suggestion-btn {
        background-color: var(--bg-surface-raised);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 12px;
        font-size: 0.9rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: right;
    }
    html[dir="ltr"] .suggestion-btn { text-align: left; }
    .suggestion-btn:hover {
        background-color: var(--bg-input);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    /* Disclaimer Text Styling */
    .ai-disclaimer {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: center;
        padding: 0.5rem 1rem 0;
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.5;
        position: relative;
        z-index: 5;
    }

    .camera-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .camera-modal-content { background-color: var(--bg-surface); padding: 25px; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); text-align: center; max-width: 90%; display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: var(--shadow-lg); }
    
    /* Redesigned Share Modal */
    .share-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .share-modal-content { max-width: 450px; width: 90%; background: #1c1c1c; padding: 30px; border: 1px solid var(--border-color-light); border-radius: var(--border-radius-lg); text-align: center; display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: var(--shadow-lg); }
    .share-modal-content h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--text-primary); }
    .share-modal-content > p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6; }
    .share-link-container { display: flex; margin-bottom: 20px; width: 100%; }
    .share-link-container input { flex-grow: 1; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); padding: 12px 15px; border-radius: 0 8px 8px 0; font-size: 0.95rem; outline: none; }
    .share-link-container button { border: 1px solid var(--primary-color); background-color: var(--primary-color); color: var(--text-on-primary); padding: 12px 18px; border-radius: 8px 0 0 8px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
    .share-link-container button:hover { background-color: var(--primary-hover-color); }
    .share-divider { width: 80%; height: 1px; background: var(--border-color); margin: 25px auto; border: none; }
    .social-share-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .social-share-buttons .share-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-surface-raised); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; text-decoration: none; transition: all 0.3s ease; }
    .social-share-buttons .share-icon:hover { color: #fff; transform: translateY(-4px); box-shadow: var(--shadow-md); }
    .share-icon.whatsapp:hover { background-color: #25D366; }
    .share-icon.twitter:hover { background-color: #1DA1F2; }
    .share-icon.telegram:hover { background-color: #0088cc; }
    .share-icon.facebook:hover { background-color: #1877F2; }
    .qr-code-container { margin-top: 15px; }
    .qr-code-container img { background: #fff; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); }
    .qr-code-container p { color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px; }
    .close-share-modal { position: absolute; top: 15px; left: 15px; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; }
    .close-share-modal:hover { color: var(--text-primary); transform: rotate(90deg); }
    
    /* --- NEW: HISTORY SIDEBAR --- */
    .history-sidebar {
      position: fixed;
      top: 0;
      right: -300px; /* Start off-screen */
      width: 280px;
      height: 100%;
      background-color: var(--bg-surface);
      border-left: 1px solid var(--border-color);
      z-index: 1001;
      transition: right 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    html[dir="ltr"] .history-sidebar { right: auto; left: -300px; border-left: none; border-right: 1px solid var(--border-color); transition: left 0.3s ease-in-out; }
    .history-sidebar.open { right: 0; }
    html[dir="ltr"] .history-sidebar.open { left: 0; }
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      z-index: 1000;
      backdrop-filter: blur(2px);
    }
    .sidebar-overlay.open { display: block; }
    .history-header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
    .history-header h3 { font-size: 1.1rem; color: var(--text-primary); }
    #closeHistoryBtn { background: none; border: none; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
    #closeHistoryBtn:hover { color: var(--text-primary); transform: rotate(90deg); }
    .new-chat-btn { display: flex; align-items: center; gap: 10px; width: calc(100% - 2rem); margin: 1rem; padding: 0.8rem; background-color: var(--bg-input); border: 1px solid var(--border-color-light); border-radius: var(--border-radius-md); color: var(--text-primary); cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .new-chat-btn:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); }
    #historyList { list-style: none; flex-grow: 1; overflow-y: auto; padding: 0 1rem; }
    #historyList li { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0.6rem; border-radius: var(--border-radius-sm); margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s; background-color: var(--bg-surface-raised); border: 1px solid transparent; }
    #historyList li:hover { background-color: var(--bg-input); }
    #historyList li.active { background-color: var(--bg-input); border-color: var(--primary-color); }
    .history-item-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; font-size: 0.9rem; }
    .delete-history-item-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0 5px; font-size: 0.9rem; opacity: 0.5; transition: all 0.2s; }
    #historyList li:hover .delete-history-item-btn { opacity: 1; }
    .delete-history-item-btn:hover { color: var(--error-color); transform: scale(1.2); }

    @media (max-width: 768px) {
      /* --- NEW: HIDE DISCLAIMER ON MOBILE --- */
      .ai-disclaimer { display: none !important; }
    }

    @media (max-width: 480px) { 
      .header h1 { font-size: 0.95rem; }
      .message { max-width: 95%; }
      .chat-input-wrapper textarea { padding: 0.8rem 44px; }
      .chat-input-btn { width: 40px; height: 40px; font-size: 1rem; }
      #speakBtn { left: 42px; }
      html[dir="ltr"] #speakBtn { right: 42px; left: auto; }
      #suggestionsContainer { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="downloadNotification" class="download-notification">
      <span id="downloadNotificationText">ثبّت التطبيق على جهازك للوصول السريع!</span>
      <div class="notification-buttons">
          <button id="downloadAppBtn" class="download-btn">تثبيت</button>
          <button id="closeNotificationBtn" class="close-btn">×</button>
      </div>
    </div>
    
    <header class="header">
      <!-- Right Group (Controls) -->
      <div id="headerControls" class="header-group">
        <button id="enterSubjectsBtn" class="header-btn">مواد متخصصة</button>
        <button id="generalChatBtn" class="header-btn" style="display: none;">عام</button>
        <div id="languageSelector">
          <button id="languageBtn" class="header-btn" title="تغيير اللغة">
            <i class="fas fa-globe"></i>
          </button>
          <div id="languageDropdown">
            <button data-lang="ar">العربية</button>
            <button data-lang="en">English</button>
            <button data-lang="fr">Français</button>
            <button data-lang="es">Español</button>
            <button data-lang="zh">中文</button>
          </div>
        </div>
      </div>
      
      <!-- Center Group (Title) -->
      <div class="header-group">
        <i class="fas fa-robot"></i>
        <h1 id="botName">Saif AI</h1>
      </div>
      
      <!-- Left Group (Icons) -->
      <div id="headerIcons" class="header-group">
        <i class="fas fa-share-alt header-icon share-btn-header" id="shareBtn" title="مشاركة التطبيق"></i>
        <i class="fas fa-trash header-icon delete-all-btn" id="deleteCurrentChatBtn" title="حذف المحادثة الحالية"></i>
        <i class="fas fa-bars header-icon history-btn" id="historyBtn" title="عرض السجل"></i>
      </div>
    </header>

    <div class="chat-wrapper" id="chatWrapper"> 
        <div id="chatContainer" class="chat-container">
          <!-- Messages will be here -->
        </div>
        
        <!-- Suggestions will be here -->
        <div id="suggestionsContainer"></div>
        
        <div class="chat-input-area"> 
            <div class="status" id="statusBar"></div>
            
            <div class="voice-indicator" id="voiceIndicator">
              <i class="fas fa-microphone"></i>
              <span id="listeningText">جاري الاستماع...</span>
            </div>

            <div class="chat-input-wrapper">
              <button class="chat-input-btn" id="toggleUploadBtn" title="إرفاق ملف">
                <i class="fas fa-plus"></i>
              </button>

              <textarea id="userInput" rows="1" placeholder="اكتب رسالتك هنا..."></textarea>
              
              <button class="chat-input-btn" id="speakBtn" title="تشغيل الصوت">
                <i class="fas fa-volume-up"></i>
              </button>

              <button class="chat-input-btn" id="sendOrVoiceBtn">
                <!-- Content will be set by JS -->
              </button>
              
              <div class="upload-options-container" id="uploadOptionsContainer">
                <button id="uploadFromGalleryBtn" onclick="triggerImageUpload()">
                  <i class="fas fa-images"></i> رفع من المعرض
                </button>
                <button id="useCameraBtn" onclick="openCamera()">
                  <i class="fas fa-camera"></i> استخدام الكاميرا
                </button>
              </div>

              <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" style="display: none;" />
            </div>
            
            <!-- AI Disclaimer -->
            <div id="aiDisclaimer" class="ai-disclaimer"></div>
        </div>
    </div>

    <div id="subjectsViewContainer"> 
        <div class="subjects-view-header">
            <h2 id="subjectsViewTitle">اختر المادة الدراسية</h2>
            <button id="backToChatBtn" class="back-to-chat-btn">
                <i class="fas fa-arrow-left"></i> <span id="backToChatText">العودة للدردشة</span>
            </button>
        </div>
        <div id="subjectListContainer">
            <!-- Subject items will be populated here by JS -->
        </div>
    </div>
  </div>
  
  <!-- NEW: History Sidebar -->
  <div id="historySidebar" class="history-sidebar">
    <div class="history-header">
      <h3 id="historyTitle">سجل المحادثات</h3>
      <button id="closeHistoryBtn">&times;</button>
    </div>
    <button id="newChatBtn" class="new-chat-btn">
      <i class="fas fa-plus"></i> <span id="newChatText">محادثة جديدة</span>
    </button>
    <ul id="historyList">
      <!-- History items will be populated here -->
    </ul>
  </div>
  <div id="sidebar-overlay" class="sidebar-overlay"></div>


  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">التقاط صورة</button>
        <button id="cancelCameraBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <span class="close-share-modal" id="closeShareModal">&times;</span>
      <h2 id="shareModalTitle">شارك التطبيق</h2>
      <p id="shareModalDesc">ساعدنا على النمو بمشاركة التطبيق مع أصدقائك!</p>
      
      <div class="share-link-container">
        <button id="copyLinkBtn"><i class="fas fa-copy"></i> <span id="copyBtnText">نسخ</span></button>
        <input type="text" value="https://tinyurl.com/saif-ai" id="shareLinkInput" readonly>
      </div>

      <hr class="share-divider">

      <div class="social-share-buttons">
          <a href="#" target="_blank" class="share-icon whatsapp" id="whatsapp-share" title="مشاركة عبر واتساب"><i class="fab fa-whatsapp"></i></a>
          <a href="#" target="_blank" class="share-icon twitter" id="twitter-share" title="مشاركة عبر تويتر"><i class="fab fa-twitter"></i></a>
          <a href="#" target="_blank" class="share-icon telegram" id="telegram-share" title="مشاركة عبر تيليجرام"><i class="fab fa-telegram-plane"></i></a>
          <a href="#" target="_blank" class="share-icon facebook" id="facebook-share" title="مشاركة عبر فيسبوك"><i class="fab fa-facebook-f"></i></a>
      </div>
      
      <div class="qr-code-container">
          <img id="qr-code-img" src="" alt="QR Code" width="140" height="140">
          <p id="qrCodeText">أو امسح الرمز للمشاركة</p>
      </div>
    </div>
  </div>


  <script>
    // --- API KEYS ---
    const geminiApiKey = "AIzaSyAnuSkvwbWZ0M95asG7-cd0-JhfOkWtXV8"; 
    const ocrApiKey = "K83201031288957";     

    // --- DOM ELEMENTS ---
    const chatWrapper = document.getElementById("chatWrapper");
    const chatContainer = document.getElementById("chatContainer");
    const statusBar = document.getElementById("statusBar");
    const userInput = document.getElementById("userInput");
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const voiceIndicator = document.getElementById('voiceIndicator');
    const subjectsViewContainer = document.getElementById('subjectsViewContainer');
    const subjectListContainer = document.getElementById('subjectListContainer'); 
    const backToChatBtn = document.getElementById('backToChatBtn');
    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;
    const enterSubjectsBtn = document.getElementById('enterSubjectsBtn');
    const generalChatBtn = document.getElementById('generalChatBtn');
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShareModalBtn = document.getElementById('closeShareModal');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const shareLinkInput = document.getElementById('shareLinkInput');
    const downloadNotification = document.getElementById('downloadNotification');
    const downloadAppBtn = document.getElementById('downloadAppBtn');
    const closeNotificationBtn = document.getElementById('closeNotificationBtn');
    const sendOrVoiceBtn = document.getElementById('sendOrVoiceBtn');
    const speakBtn = document.getElementById('speakBtn');
    const languageBtn = document.getElementById('languageBtn');
    const languageDropdown = document.getElementById('languageDropdown');
    const suggestionsContainer = document.getElementById('suggestionsContainer');
    const deleteCurrentChatBtn = document.getElementById('deleteCurrentChatBtn');
    // --- NEW: History Sidebar Elements ---
    const historyBtn = document.getElementById('historyBtn');
    const historySidebar = document.getElementById('historySidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const closeHistoryBtn = document.getElementById('closeHistoryBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const historyList = document.getElementById('historyList');

    
    // --- GLOBAL VARIABLES & CONSTANTS ---
    const botName = "Saif AI";
    // --- MODIFIED: New data structure for chat sessions ---
    const localStorageKeyAllChats = "saifAiAllChatSessions_v3";
    const localStorageKeyLastSession = "saifAiLastSession_v3";
    const localStorageKeyLanguage = "saifAiLanguage_v1";
    
    let allChatSessions = {}; // { general: [ {id, messages, timestamp} ], ... }
    let messages = [];    
    let currentSubject = "general";
    let currentChatId = null; // ID of the currently active chat
    
    let statusTimeout;
    let currentLanguage = "ar";
    const subjects = [ 
        { key: "physics", name: { ar: "فيزياء", en: "Physics", fr: "Physique", es: "Física", zh: "物理" }, icon: "fas fa-atom" },
        { key: "chemistry", name: { ar: "كيمياء", en: "Chemistry", fr: "Chimie", es: "Química", zh: "化学" }, icon: "fas fa-flask" },
        { key: "biology", name: { ar: "أحياء", en: "Biology", fr: "Biologie", es: "Biología", zh: "生物学" }, icon: "fas fa-dna" },
        { key: "science", name: { ar: "علوم", en: "Science", fr: "Sciences", es: "Ciencia", zh: "科学" }, icon: "fas fa-microscope" },
        { key: "arabic", name: { ar: "لغة عربية", en: "Arabic", fr: "Arabe", es: "Árabe", zh: "阿拉伯语" }, icon: "fas fa-pen-nib" },
        { key: "philosophy", name: { ar: "فلسفة", en: "Philosophy", fr: "Philosophie", es: "Filosofía", zh: "哲学" }, icon: "fas fa-brain" },
        { key: "english", name: { ar: "لغة إنجليزية", en: "English", fr: "Anglais", es: "Inglés", zh: "英语" }, icon: "fas fa-language" },
        { key: "math", name: { ar: "رياضيات", en: "Math", fr: "Maths", es: "Matemáticas", zh: "数学" }, icon: "fas fa-calculator" },
        { key: "religion", name: { ar: "تربية دينية", en: "Religion", fr: "Religion", es: "Religión", zh: "宗教教育" }, icon: "fas fa-mosque" }
    ];
    let recognition;
    let isListening = false;
    let deferredPrompt;
    let speechEndTimeout;

    // --- PWA & NOTIFICATION FUNCTIONS ---
    function showAppNotification() { downloadNotification.classList.add('show'); }
    function hideAppNotification() { downloadNotification.classList.remove('show'); }
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(err => console.error('Service Worker registration failed:', err));
      }
    }
    async function promptInstall(e) {
        e.preventDefault();
        if (deferredPrompt) {
            hideAppNotification();
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
        }
    }

    // --- SPEECH RECOGNITION (INPUT) ---
    function initSpeechRecognition() {
        if (recognition) { recognition.abort(); }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const langMap = { ar: 'ar-SA', en: 'en-US', fr: 'fr-FR', es: 'es-ES', zh: 'zh-CN' };
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = langMap[currentLanguage];

            recognition.onstart = () => {
                isListening = true;
                sendOrVoiceBtn.classList.add('recording');
                voiceIndicator.classList.add('active');
                setStatus(translations[currentLanguage].listening, "", null);
            };

            recognition.onresult = (event) => {
                clearTimeout(speechEndTimeout);
                let transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                userInput.value = transcript;
                autoResizeTextarea();
                updateSendOrVoiceButton();
                
                speechEndTimeout = setTimeout(() => {
                    if (isListening) recognition.stop();
                }, 1500);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error !== 'no-speech') {
                    setStatus(`${translations[currentLanguage].speechError}: ${event.error}`, "error", 4000);
                }
                stopListening();
            };

            recognition.onend = () => {
                stopListening();
            };
        } else {
            sendOrVoiceBtn.style.display = 'none';
            setStatus(translations[currentLanguage].speechNotSupported, "error", 3000);
        }
    }
    
    function toggleListening() {
        if (!recognition) return;
        if (isListening) { 
            recognition.stop();
        } else { 
            try { 
                userInput.value = ""; 
                autoResizeTextarea(); 
                recognition.start(); 
            } catch (e) { 
                stopListening(); 
            }
        }
    }
    
    function stopListening() {
        clearTimeout(speechEndTimeout);
        isListening = false;
        sendOrVoiceBtn.classList.remove('recording');
        voiceIndicator.classList.remove('active');
        if (statusBar.textContent === translations[currentLanguage].listening) setStatus("", "", 100);
    }
    
    // --- TEXT TO SPEECH (OUTPUT) ---
    function speakLastBotMessage() {
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
            return;
        }
        const lastBotMessage = [...messages].reverse().find(m => m.sender === 'bot' && !m.isSystemMessage && !m.isInitialWelcome);
        if (lastBotMessage) {
            const utterance = new SpeechSynthesisUtterance(lastBotMessage.text);
            const langMap = { ar: 'ar-SA', en: 'en-US', fr: 'fr-FR', es: 'es-ES', zh: 'zh-CN' };
            utterance.lang = langMap[currentLanguage];
            speechSynthesis.speak(utterance);
        } else {
            setStatus(translations[currentLanguage].noResponseToSpeak, "", 2000);
        }
    }

    // --- INITIALIZATION & EVENT LISTENERS ---
    function initializeApp() {
        registerServiceWorker();
        const savedLang = localStorage.getItem(localStorageKeyLanguage) || 'ar';
        switchLanguage(savedLang, false); // Switch language first to have translations ready
        
        loadAllChatSessions();
        
        // Event Listeners
        const qrCodeImg = document.getElementById('qr-code-img');
        const whatsappShare = document.getElementById('whatsapp-share');
        const twitterShare = document.getElementById('twitter-share');
        const telegramShare = document.getElementById('telegram-share');
        const facebookShare = document.getElementById('facebook-share');

        shareBtn.addEventListener('click', () => {
            const shareUrl = shareLinkInput.value;
            const shareText = translations[currentLanguage].shareText;
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(shareUrl)}&bgcolor=1c1c1c&color=ffffff&qzone=1`;
            whatsappShare.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + " " + shareUrl)}`;
            twitterShare.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
            telegramShare.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
            facebookShare.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
            shareModal.style.display = 'flex';
        });

        closeShareModalBtn.addEventListener('click', () => { shareModal.style.display = 'none'; });
        copyLinkBtn.addEventListener('click', copyShareLink);
        toggleUploadBtn.addEventListener('click', (e) => { e.stopPropagation(); uploadOptionsContainer.classList.toggle('active'); });
        document.addEventListener('click', () => { uploadOptionsContainer.classList.remove('active'); });
        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);
        enterSubjectsBtn.addEventListener('click', openSubjectsView);
        backToChatBtn.addEventListener('click', closeSubjectsView);
        generalChatBtn.addEventListener('click', switchToGeneralMode);
        downloadAppBtn.addEventListener('click', promptInstall);
        closeNotificationBtn.addEventListener('click', hideAppNotification);
        userInput.addEventListener("keydown", (e) => { if(e.key==="Enter"&&!e.shiftKey) { e.preventDefault(); sendMessage();}});
        userInput.addEventListener("input", () => { autoResizeTextarea(); updateSendOrVoiceButton(); }); 
        speakBtn.addEventListener('click', speakLastBotMessage);
        languageBtn.addEventListener('click', (e) => { e.stopPropagation(); languageDropdown.style.display = languageDropdown.style.display === 'block' ? 'none' : 'block'; });
        document.addEventListener('click', () => { languageDropdown.style.display = 'none'; });
        document.querySelectorAll('#languageDropdown button').forEach(button => {
            button.addEventListener('click', (e) => {
                switchLanguage(e.currentTarget.dataset.lang);
            });
        });
        
        deleteCurrentChatBtn.addEventListener('click', deleteCurrentChat);

        // --- NEW: History Sidebar Listeners ---
        historyBtn.addEventListener('click', openHistorySidebar);
        closeHistoryBtn.addEventListener('click', closeHistorySidebar);
        sidebarOverlay.addEventListener('click', closeHistorySidebar);
        newChatBtn.addEventListener('click', () => {
          loadChat(currentSubject, null); // Start a new chat in the current subject
          closeHistorySidebar();
        });


        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; showAppNotification(); });
        window.addEventListener('appinstalled', () => { deferredPrompt = null; hideAppNotification(); });
        window.addEventListener('click', (event) => {
            if (event.target == shareModal) shareModal.style.display = 'none';
            if (event.target == cameraModal) closeCamera();
        });
    }
    
    function copyShareLink() {
        shareLinkInput.select();
        navigator.clipboard.writeText(shareLinkInput.value).then(() => {
            const originalText = document.getElementById('copyBtnText').textContent;
            document.getElementById('copyBtnText').textContent = translations[currentLanguage].copied;
            copyLinkBtn.querySelector('i').className = "fas fa-check";
            setTimeout(() => { 
                document.getElementById('copyBtnText').textContent = originalText;
                copyLinkBtn.querySelector('i').className = "fas fa-copy";
            }, 2000);
        });
    }

    // --- UI & VIEW MANAGEMENT ---
    function updateSendOrVoiceButton() {
        const hasText = userInput.value.trim().length > 0;
        const t = translations[currentLanguage];
        if (hasText) {
            sendOrVoiceBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendOrVoiceBtn.title = t.send;
            sendOrVoiceBtn.onclick = sendMessage;
        } else {
            sendOrVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            sendOrVoiceBtn.title = t.speak;
            sendOrVoiceBtn.onclick = toggleListening;
        }
    }

    function openSubjectsView() { chatWrapper.style.display = 'none'; subjectsViewContainer.style.display = 'flex'; }
    function closeSubjectsView() { subjectsViewContainer.style.display = 'none'; chatWrapper.style.display = 'flex'; }
    
    function getTranslatedSubjectName(subjectKey) {
        if (subjectKey === "general") return translations[currentLanguage].general;
        const subject = subjects.find(s => s.key === subjectKey);
        return subject ? subject.name[currentLanguage] : subjectKey;
    }

    function getBotDisplayName() { 
        const subjectName = getTranslatedSubjectName(currentSubject);
        return currentSubject === "general" ? botName : `${botName} (${subjectName})`;
    }
    
    function updateSubjectUI() {
        botNameElement.textContent = getBotDisplayName();
        const t = translations[currentLanguage];
        generalChatBtn.style.display = currentSubject === "general" ? 'none' : 'inline-block';
        generalChatBtn.textContent = t.general;
        enterSubjectsBtn.textContent = currentSubject === "general" ? t.specializedSubjects : `${t.subjectPrefix}: ${getTranslatedSubjectName(currentSubject)}`;
        // No longer storing subject in its own key, but as part of last session
    }

    function populateSubjectListInView() { 
        subjectListContainer.innerHTML = '';
        subjects.forEach(subject => {
            const btn = document.createElement('button');
            btn.className = 'subject-item-btn';
            btn.innerHTML = `<i class="${subject.icon}"></i><span>${subject.name[currentLanguage]}</span>`;
            btn.onclick = () => selectSubject(subject.key);
            subjectListContainer.appendChild(btn);
        });
    }

    function selectSubject(subjectKey) {
        if (currentSubject === subjectKey) { closeSubjectsView(); return; }
        switchSubject(subjectKey);
        setStatus(`${translations[currentLanguage].switchedToSubject} ${getTranslatedSubjectName(subjectKey)}`, "success", 3000);
    }

    function switchToGeneralMode() {
        if (currentSubject === "general") { closeSubjectsView(); return; }
        switchSubject("general");
        setStatus(translations[currentLanguage].returnedToGeneral, "success", 3000);
    }

    function switchSubject(newSubject) {
        currentSubject = newSubject;
        
        // Find the last chat for the new subject, or start a new one
        const sessionsForNewSubject = allChatSessions[currentSubject] || [];
        const lastChatInNewSubject = sessionsForNewSubject.length > 0 ? sessionsForNewSubject[0].id : null;
        
        loadChat(newSubject, lastChatInNewSubject);
        
        updateSubjectUI();
        closeSubjectsView();
        // saveAllChatSessionsToLocalStorage will be called by loadChat via refreshChat
    }
    
    // --- MESSAGE & CHAT MANAGEMENT (REWRITTEN) ---
    function loadAllChatSessions() {
      try {
        const stored = localStorage.getItem(localStorageKeyAllChats);
        allChatSessions = stored ? JSON.parse(stored) : {};
      } catch (e) {
        allChatSessions = {};
      }
      
      // Ensure base structure exists for all subjects
      subjects.forEach(s => { if (!allChatSessions[s.key]) allChatSessions[s.key] = []; });
      if (!allChatSessions.general) allChatSessions.general = [];

      let lastSession = { subject: 'general', id: null };
      try {
        const storedLast = localStorage.getItem(localStorageKeyLastSession);
        if (storedLast) lastSession = JSON.parse(storedLast);
      } catch (e) { /* use default */ }
      
      // Validate that the last session still exists
      const lastSessionExists = allChatSessions[lastSession.subject]?.some(s => s.id === lastSession.id);

      if (lastSessionExists) {
        loadChat(lastSession.subject, lastSession.id);
      } else {
        // If it doesn't exist, load the latest chat in that subject, or a new one
        const sessionsForSubject = allChatSessions[lastSession.subject] || [];
        const latestChatId = sessionsForSubject.length > 0 ? sessionsForSubject[0].id : null;
        loadChat(lastSession.subject, latestChatId);
      }
    }

    function saveAllChatSessionsToLocalStorage() {
      // Find the current session and update its messages
      if (currentChatId && allChatSessions[currentSubject]) {
        const session = allChatSessions[currentSubject].find(s => s.id === currentChatId);
        if (session) {
          session.messages = messages;
        }
      }
      // Save the entire sessions object
      localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allChatSessions));
      // Save the last active session reference
      localStorage.setItem(localStorageKeyLastSession, JSON.stringify({ subject: currentSubject, id: currentChatId }));
    }

    function loadChat(subject, chatId) {
        currentSubject = subject;
        currentChatId = chatId;
        
        if (chatId === null) {
            // This is a new chat, not yet saved
            messages = [];
            addWelcomeMessage();
        } else {
            const session = allChatSessions[subject]?.find(s => s.id === chatId);
            if (session) {
                messages = session.messages;
            } else {
                // Fallback if ID is invalid
                messages = [];
                addWelcomeMessage();
                currentChatId = null; 
            }
        }
        
        updateSubjectUI();
        refreshChat();
    }

    function addWelcomeMessage() {
        const welcomeMsgText = getWelcomeMessageText();
        if (messages.length === 0 || !messages.some(m => m.isInitialWelcome)) {
          messages.unshift({ sender: "bot", text: welcomeMsgText, isInitialWelcome: true });
        }
    }

    function addMessage(sender, text, isImage = false, isSystemMessage = false) { 
        // If this is the first message in a new chat, create the session first
        if (currentChatId === null && sender === 'user') {
            const newId = Date.now();
            const newSession = {
                id: newId,
                timestamp: newId,
                messages: [] // Will be populated by refreshChat
            };
            // Ensure the subject array exists
            if (!allChatSessions[currentSubject]) {
                allChatSessions[currentSubject] = [];
            }
            // Add to the beginning (so it's the newest)
            allChatSessions[currentSubject].unshift(newSession);
            currentChatId = newId;
        }
        
        messages.push({ sender, text, isImage, isSystemMessage }); 
        refreshChat(); 
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); 
    }

    function refreshChat() {
      chatContainer.innerHTML = ""; 
      const t = translations[currentLanguage];
      messages.forEach((msg, index) => {
        const messageElem = document.createElement("div"); messageElem.className = `message ${msg.sender}`;
        let senderName = msg.sender === "bot" ? getBotDisplayName() : t.you;
        const header = document.createElement("div"); header.className = "message-header"; 
        // Don't show delete button on system messages
        const deleteButtonHTML = (msg.isInitialWelcome || msg.isSystemMessage) ? '' : `<i class="fas fa-trash delete-btn" title="${t.deleteMessage}"></i>`;
        header.innerHTML = `<span>${senderName}</span>${deleteButtonHTML}`;
        if (!msg.isInitialWelcome && !msg.isSystemMessage) {
            header.querySelector('.delete-btn').onclick = () => deleteMessage(index);
        }
        const contentDiv = document.createElement("div"); contentDiv.className = "message-content"; contentDiv.innerHTML = msg.text; 
        messageElem.appendChild(header); messageElem.appendChild(contentDiv);
        if(msg.sender === "bot" && !msg.isInitialWelcome && !msg.isSystemMessage) {
            const actionsDiv = document.createElement("div"); actionsDiv.className = "message-actions";
            actionsDiv.innerHTML = `<button title="${t.copy}"><i class="fas fa-copy"></i></button>`;
            actionsDiv.querySelector('button').onclick = () => { navigator.clipboard.writeText(msg.text).then(() => setStatus(t.copiedSuccess, "success", 1500)); };
            messageElem.appendChild(actionsDiv);
        }
        chatContainer.appendChild(messageElem);
      });
      toggleSuggestionsVisibility(); 
      saveAllChatSessionsToLocalStorage(); 
      autoResizeTextarea(); 
    }
    function deleteMessage(index) { messages.splice(index, 1); refreshChat(); setStatus(translations[currentLanguage].messageDeleted, "success", 1500); }
    
    function deleteCurrentChat() {
      if (!currentChatId) {
        // Can't delete a new, unsaved chat. Just clear it.
        messages = [];
        addWelcomeMessage();
        refreshChat();
        return;
      }
      if (confirm(translations[currentLanguage].confirmDeleteCurrent)) {
        // Find and remove the chat session
        const sessionIndex = allChatSessions[currentSubject].findIndex(s => s.id === currentChatId);
        if (sessionIndex > -1) {
            allChatSessions[currentSubject].splice(sessionIndex, 1);
        }
        
        // Load the next available chat or start a new one
        const nextSession = allChatSessions[currentSubject][0] || null;
        loadChat(currentSubject, nextSession ? nextSession.id : null);
        
        setStatus(translations[currentLanguage].chatDeleted, "success", 2000);
        speakBtn.style.display = 'none';
      }
    }
    
    function setStatus(message, type = "", duration = 3000) { clearTimeout(statusTimeout); statusBar.textContent = message; statusBar.className = "status " + type; if (message && duration) { statusTimeout = setTimeout(() => { statusBar.textContent = ""; statusBar.className = "status"; }, duration); } }

    // --- AI & GEMINI FUNCTIONS ---
    async function fetchGeminiResponse(prompt) {
      if (!geminiApiKey) throw new Error("Gemini API key is missing.");
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
      const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      if(!response.ok) throw new Error(`Network error: ${response.statusText}`);
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.";
    }
    async function processQueryWithAI(queryText) {
        if (!queryText?.trim()) return;
        const t = translations[currentLanguage];
        setStatus(`${getBotDisplayName()} ${t.thinking}...`, "", null); 
        try {
            const strictInstructions = t.aiInstructions
              .replace('{botName}', getBotDisplayName())
              .replace('{language}', t.languageName)
              .replace('{subjectContext}', currentSubject !== 'general' ? t.aiSubjectInstruction.replace('{subject}', getTranslatedSubjectName(currentSubject)) : '');
            
            const prompt = `${strictInstructions} The user's question is: ${queryText}`;

            const responseText = await fetchGeminiResponse(prompt);
            addMessage("bot", responseText);
            setStatus(t.responseReceived, "success"); 
            speakBtn.style.display = 'flex';
        } catch (error) {
            addMessage("bot", `${t.errorPrefix}: ${error.message}`, false, true); 
            setStatus(t.responseFailed, "error"); 
        }
    }
    async function sendMessage() {
      const messageText = userInput.value.trim();
      if (!messageText) return;
      
      addMessage("user", messageText);
      userInput.value = ""; 
      autoResizeTextarea(); 
      updateSendOrVoiceButton();
      await processQueryWithAI(messageText);
    }

    // --- UTILITY & OTHER FUNCTIONS ---
    function autoResizeTextarea() { userInput.style.height = 'auto'; userInput.style.height = userInput.scrollHeight + 'px'; }
    async function openCamera() { try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); cameraView.srcObject = cameraStream; cameraModal.style.display = "flex"; } catch (err) { setStatus(translations[currentLanguage].cameraError, "error", 4000); } }
    function closeCamera() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); } cameraModal.style.display = "none"; }
    async function captureImageFromCamera() { /* Your existing capture code */ }
    function triggerImageUpload() { imageUploadInput.click(); }
    function handleFileSelect(event) { /* Your existing file handling code */ }
    
    // --- LANGUAGE SWITCHING ---
    function switchLanguage(lang, showStatus = true) {
        currentLanguage = lang;
        localStorage.setItem(localStorageKeyLanguage, currentLanguage);
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

        updateUIForLanguage();
        initSpeechRecognition();
        
        // Reload messages array and update welcome message text
        if (messages.length > 0 && messages[0].isInitialWelcome) {
            messages[0].text = getWelcomeMessageText();
        }
        refreshChat(); // This will redraw the chat with the new language strings (e.g., "You")

        if (showStatus) {
            setStatus(translations[lang].languageChanged, "success", 2000);
        }
    }

    function getWelcomeMessageText() {
        const t = translations[currentLanguage];
        let welcomeMsgText = t.welcomeGeneral.replace('{botName}', getBotDisplayName());
        if (currentSubject !== "general") { 
            welcomeMsgText = t.welcomeSubject
                .replace('{botName}', getBotDisplayName())
                .replace('{subject}', getTranslatedSubjectName(currentSubject)); 
        }
        return welcomeMsgText;
    }
    
    // --- SUGGESTIONS FEATURE ---
    async function fetchAndDisplaySuggestions() {
        try {
            const t = translations[currentLanguage];
            let subjectContext = currentSubject === 'general' ? t.suggestionContextGeneral : t.suggestionContextSubject.replace('{subject}', getTranslatedSubjectName(currentSubject));
            const prompt = t.suggestionPrompt
                .replace('{subjectContext}', subjectContext)
                .replace('{language}', t.languageName);

            const responseText = await fetchGeminiResponse(prompt);
            const suggestions = responseText.split('\n')
                .map(s => s.trim().replace(/^(-|\*|\d+\.\s*)/, '').trim())
                .filter(s => s.length > 0);

            if (suggestions.length > 0) {
                populateSuggestions(suggestions);
            } else {
                populateSuggestions(t.fallbackSuggestions);
            }
        } catch (error) {
            console.error("Failed to fetch AI suggestions:", error);
            populateSuggestions(translations[currentLanguage].fallbackSuggestions);
        }
    }

    function populateSuggestions(suggestionsArray) {
        suggestionsContainer.innerHTML = '';
        suggestionsArray.forEach(text => {
            const btn = document.createElement('button');
            btn.className = 'suggestion-btn';
            btn.textContent = text;
            btn.onclick = () => {
                userInput.value = text;
                sendMessage();
            };
            suggestionsContainer.appendChild(btn);
        });
    }

    function toggleSuggestionsVisibility() {
        const hasUserMessages = messages.some(m => !m.isInitialWelcome);
        if (!hasUserMessages && currentChatId === null) {
            suggestionsContainer.style.display = 'grid';
        } else {
            suggestionsContainer.style.display = 'none';
        }
    }
    
    // --- NEW: HISTORY SIDEBAR FUNCTIONS ---
    function openHistorySidebar() {
      renderHistoryList();
      historySidebar.classList.add('open');
      sidebarOverlay.classList.add('open');
    }

    function closeHistorySidebar() {
      historySidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    }

    function renderHistoryList() {
      historyList.innerHTML = '';
      const t = translations[currentLanguage];
      const sessions = allChatSessions[currentSubject] || [];

      if (sessions.length === 0) {
        historyList.innerHTML = `<li style="cursor: default; opacity: 0.7; justify-content: center;">${t.noHistory}</li>`;
        return;
      }
      
      sessions.forEach(session => {
        const li = document.createElement('li');
        if (session.id === currentChatId) {
            li.classList.add('active');
        }

        // Find the first user message for the title, or use a default
        const firstUserMsg = session.messages.find(m => m.sender === 'user');
        const titleText = firstUserMsg ? firstUserMsg.text : t.newChat;
        
        li.innerHTML = `
            <span class="history-item-title">${titleText}</span>
            <button class="delete-history-item-btn" title="${t.deleteChat}"><i class="fas fa-trash"></i></button>
        `;
        
        li.querySelector('.history-item-title').addEventListener('click', () => {
            if (session.id !== currentChatId) {
                loadChat(currentSubject, session.id);
            }
            closeHistorySidebar();
        });
        
        li.querySelector('.delete-history-item-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(t.confirmDeleteCurrent)) {
                const sessionIndex = allChatSessions[currentSubject].findIndex(s => s.id === session.id);
                if (sessionIndex > -1) {
                    allChatSessions[currentSubject].splice(sessionIndex, 1);
                    // If we deleted the active chat, load another one
                    if(session.id === currentChatId) {
                        const nextSession = allChatSessions[currentSubject][0] || null;
                        loadChat(currentSubject, nextSession ? nextSession.id : null);
                    }
                    saveAllChatSessionsToLocalStorage();
                    renderHistoryList(); // Re-render the list
                }
            }
        });

        historyList.appendChild(li);
      });
    }


    function updateUIForLanguage() {
        const t = translations[currentLanguage];
        // Header
        document.getElementById('deleteCurrentChatBtn').title = t.deleteCurrentChat;
        document.getElementById('historyBtn').title = t.viewHistory;
        document.getElementById('shareBtn').title = t.shareApp;
        document.getElementById('languageBtn').title = t.changeLanguage;
        // Subject buttons
        updateSubjectUI();
        // Subjects View
        document.getElementById('subjectsViewTitle').textContent = t.selectSubject;
        document.getElementById('backToChatText').textContent = t.backToChat;
        populateSubjectListInView();
        // Chat Input
        userInput.placeholder = t.placeholder;
        speakBtn.title = t.playAudio;
        toggleUploadBtn.title = t.attachFile;
        document.getElementById('uploadFromGalleryBtn').innerHTML = `<i class="fas fa-images"></i> ${t.uploadFromGallery}`;
        document.getElementById('useCameraBtn').innerHTML = `<i class="fas fa-camera"></i> ${t.useCamera}`;
        document.getElementById('listeningText').textContent = t.listening;
        updateSendOrVoiceButton();
        // Disclaimer
        document.getElementById('aiDisclaimer').textContent = t.aiDisclaimer;
        // Suggestions
        fetchAndDisplaySuggestions();
        // Camera Modal
        document.getElementById('captureBtn').textContent = t.capture;
        document.getElementById('cancelCameraBtn').textContent = t.cancel;
        // Share Modal
        document.getElementById('shareModalTitle').textContent = t.shareApp;
        document.getElementById('shareModalDesc').textContent = t.shareDescription;
        document.getElementById('copyBtnText').textContent = t.copy;
        document.getElementById('qrCodeText').textContent = t.qrCodeText;
        // PWA Notification
        document.getElementById('downloadNotificationText').textContent = t.installApp;
        document.getElementById('downloadAppBtn').textContent = t.install;
        // History Sidebar
        document.getElementById('historyTitle').textContent = t.historyTitle;
        document.getElementById('newChatText').textContent = t.newChat;
    }
    
    const translations = {
      'ar': {
        languageName: "العربية",
        specializedSubjects: "مواد متخصصة", general: "عام", subjectPrefix: "مادة",
        welcomeGeneral: "مرحباً بك! أنا {botName}، كيف يمكنني مساعدتك اليوم؟",
        welcomeSubject: "مرحباً! أنا {botName}. حاليًا في وضع الإجابة عن أسئلة مادة {subject}.",
        placeholder: "اكتب رسالتك هنا...", you: "أنت",
        thinking: "يفكر", responseReceived: "تم استلام الرد!", responseFailed: "فشل الرد.",
        switchedToSubject: "تم التحويل إلى وضع مادة:", returnedToGeneral: "تم الرجوع إلى الوضع العام",
        deleteMessage: "حذف الرسالة",
        messageDeleted: "تم حذف الرسالة.",
        listening: "جاري الاستماع...", speechError: "خطأ في التعرف على الصوت", speechNotSupported: "المتصفح لا يدعم التعرف على الصوت",
        noResponseToSpeak: "لا يوجد رد لتشغيله.", playAudio: "تشغيل الصوت", send: "إرسال", speak: "التحدث",
        shareApp: "مشاركة التطبيق", shareDescription: "ساعدنا على النمو بمشاركة التطبيق مع أصدقائك!", shareText: "اكتشف Saif AI، مساعد الذكاء الاصطناعي العربي المتطور!",
        copy: "نسخ", copied: "تم النسخ", copiedSuccess: "تم النسخ بنجاح", qrCodeText: "أو امسح الرمز للمشاركة",
        selectSubject: "اختر المادة الدراسية", backToChat: "العودة للدردشة",
        attachFile: "إرفاق ملف", uploadFromGallery: "رفع من المعرض", useCamera: "استخدام الكاميرا", cameraError: "لا يمكن الوصول للكاميرا.",
        capture: "التقاط صورة", cancel: "إلغاء",
        installApp: "ثبّت التطبيق على جهازك للوصول السريع!", install: "تثبيت", languageChanged: "تم تغيير اللغة إلى العربية", changeLanguage: "تغيير اللغة",
        errorPrefix: "عفواً، واجهت مشكلة",
        aiInstructions: "أنت مساعد ذكاء اصطناعي خبير اسمه {botName}. مهمتك هي تقديم إجابات دقيقة ومفصلة. {subjectContext} يجب أن تكون جميع ردودك باللغة {language} فقط. كن صارمًا في اتباع هذه التعليمات.",
        aiSubjectInstruction: "أجب كخبير متخصص في مادة {subject}.",
        aiDisclaimer: "قد يقدم Saif AI معلومات غير دقيقة، لذا يرجى التحقق من صحة إجاباته. المنصة مخصصة لأغراض التعليم والبحث والعلم فقط.",
        suggestionPrompt: "أنشئ 4 أسئلة متنوعة وجذابة لبدء محادثة مع مساعد ذكاء اصطناعي. {subjectContext}. يجب أن تكون الإجابة قائمة بسيطة مفصولة بأسطر جديدة، بدون ترقيم أو علامات. اللغة يجب أن تكون {language}.",
        suggestionContextGeneral: "المستخدم مهتم بالمعرفة العامة والعلوم والإبداع",
        suggestionContextSubject: "المستخدم يدرس حاليًا مادة {subject}",
        fallbackSuggestions: ["اشرح لي مفهوم التوتر السطحي", "اكتب قصة قصيرة عن مستكشف فضاء", "ما هي عاصمة أستراليا؟", "ترجم 'صباح الخير' إلى الإسبانية"],
        // New for History
        historyTitle: "سجل المحادثات", newChat: "محادثة جديدة", viewHistory: "عرض السجل",
        deleteCurrentChat: "حذف المحادثة الحالية", confirmDeleteCurrent: "هل أنت متأكد من حذف هذه المحادثة؟",
        chatDeleted: "تم حذف المحادثة.", deleteChat: "حذف المحادثة", noHistory: "لا يوجد سجل بعد"
      },
      'en': {
        languageName: "English",
        specializedSubjects: "Specialized Subjects", general: "General", subjectPrefix: "Subject",
        welcomeGeneral: "Hello! I'm {botName}. How can I help you today?",
        welcomeSubject: "Hello! I'm {botName}, currently in subject mode for {subject}.",
        placeholder: "Type your message here...", you: "You",
        thinking: "is thinking", responseReceived: "Response received!", responseFailed: "Response failed.",
        switchedToSubject: "Switched to subject mode:", returnedToGeneral: "Returned to general mode",
        deleteMessage: "Delete message",
        messageDeleted: "Message deleted.",
        listening: "Listening...", speechError: "Speech recognition error", speechNotSupported: "Browser does not support speech recognition",
        noResponseToSpeak: "No response to play.", playAudio: "Play audio", send: "Send", speak: "Speak",
        shareApp: "Share App", shareDescription: "Help us grow by sharing the app with your friends!", shareText: "Discover Saif AI, the advanced AI assistant!",
        copy: "Copy", copied: "Copied", copiedSuccess: "Copied successfully", qrCodeText: "Or scan the code to share",
        selectSubject: "Select a Subject", backToChat: "Back to Chat",
        attachFile: "Attach file", uploadFromGallery: "Upload from Gallery", useCamera: "Use Camera", cameraError: "Cannot access camera.",
        capture: "Capture", cancel: "Cancel",
        installApp: "Install the app on your device for quick access!", install: "Install", languageChanged: "Language changed to English", changeLanguage: "Change Language",
        errorPrefix: "Sorry, an error occurred",
        aiInstructions: "You are an expert AI assistant named {botName}. Your task is to provide accurate and detailed answers. {subjectContext} All of your responses must be strictly in {language} only. Be strict in following these instructions.",
        aiSubjectInstruction: "Answer as a specialized expert in the subject of {subject}.",
        aiDisclaimer: "Saif AI may provide inaccurate information, so please verify its answers. The platform is intended for education, research, and science purposes only.",
        suggestionPrompt: "Generate 4 diverse and engaging conversation starter questions for an AI assistant. {subjectContext}. The output should be a simple list separated by newlines, without numbering or markers. The language must be {language}.",
        suggestionContextGeneral: "The user is interested in general knowledge, science, and creativity",
        suggestionContextSubject: "The user is currently studying the subject of {subject}",
        fallbackSuggestions: ["Explain the concept of surface tension", "Write a short story about a space explorer", "What is the capital of Australia?", "Translate 'Good morning' into Spanish"],
        // New for History
        historyTitle: "Chat History", newChat: "New Chat", viewHistory: "View History",
        deleteCurrentChat: "Delete current chat", confirmDeleteCurrent: "Are you sure you want to delete this chat?",
        chatDeleted: "Chat deleted.", deleteChat: "Delete chat", noHistory: "No history yet"
      },
      // ... (Other languages can be updated similarly)
    };


    // --- START THE APP ---
    initializeApp();
  </script>

</body>
</html>
